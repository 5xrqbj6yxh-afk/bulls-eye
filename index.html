<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="color-scheme" content="dark">
<meta name="theme-color" content="#0f1419">
<link rel="manifest" href="manifest.json">
<title>Bulls Eye Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;-webkit-box-sizing:border-box;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{background-color:#0f1419;color-scheme:dark}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background-color:#0f1419;color:#ffffff;overflow-x:hidden;-webkit-font-smoothing:antialiased;padding-top:env(safe-area-inset-top);padding-bottom:calc(72px + env(safe-area-inset-bottom));-webkit-transition:background-color 0.3s,color 0.3s;transition:background-color 0.3s,color 0.3s}
body.theme-light{background-color:#f8fafc;color:#0f172a}
body.theme-light .header{background-color:#f8fafc}
body.theme-light .stock-card,body.theme-light .portfolio-card,body.theme-light .section-card,body.theme-light .chart-card,body.theme-light .about-block,body.theme-light .outlook-card{background-color:#ffffff;border-color:#e2e8f0}
body.theme-light .search-input,body.theme-light .watchlist-select,body.theme-light .peer-select,body.theme-light .analysis-stock-select,body.theme-light .setting-input{background-color:#f1f5f9;border-color:#e2e8f0;color:#0f172a}
body.theme-light .tab-bar{background-color:#ffffff;border-color:#e2e8f0}
body.theme-light .detail-modal{background-color:#f8fafc}
body.theme-light .detail-header{background-color:#f8fafc}
body.theme-light .stock-symbol,body.theme-light .brand-title,body.theme-light .detail-price,body.theme-light .setting-label,body.theme-light .news-headline,body.theme-light .holding-name,body.theme-light .insider-name{color:#0f172a}
body.theme-light .stock-name,body.theme-light .brand-subtitle,body.theme-light .portfolio-label,body.theme-light .section-label,body.theme-light .metric-label,body.theme-light .news-source-name{color:#64748b}
body.theme-light .stock-price,body.theme-light .portfolio-value,body.theme-light .metric-value,body.theme-light .stock-score{color:#334155}
body.theme-light .stock-divider,body.theme-light .divider{background-color:#e2e8f0}
body.theme-oled{background-color:#000000}
body.theme-oled .header{background-color:#000000}
body.theme-oled .stock-card,body.theme-oled .portfolio-card,body.theme-oled .section-card,body.theme-oled .chart-card,body.theme-oled .about-block{background-color:#0a0a0a;border-color:rgba(255,255,255,0.04)}
body.theme-oled .tab-bar{background-color:#0a0a0a;border-color:rgba(255,255,255,0.04)}
body.theme-oled .detail-modal,body.theme-oled .detail-header{background-color:#000000}
.header{padding:24px 24px 16px 24px;position:-webkit-sticky;position:sticky;top:0;z-index:100;background-color:#0f1419}
.brand-title{font-family:'Playfair Display',Georgia,serif;font-size:32px;font-weight:900;letter-spacing:-0.5px;line-height:1.1;color:#ffffff}
.brand-subtitle{font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:#64748b;margin-top:4px}
.search-container{padding:0 24px;margin-bottom:8px;position:relative}
.search-input{width:100%;padding:11px 16px 11px 40px;background-color:#222938;border:1px solid rgba(255,255,255,0.10);border-radius:12px;color:#ffffff;font-family:'Inter',sans-serif;font-size:16px;outline:none;-webkit-appearance:none}
.search-input:focus{border-color:#3b82f6}
.search-icon{position:absolute;left:36px;top:50%;-webkit-transform:translateY(-50%);transform:translateY(-50%);color:#64748b;pointer-events:none}
.search-results{position:absolute;top:100%;left:24px;right:24px;background-color:#1a1f2e;border:1px solid rgba(255,255,255,0.10);border-radius:12px;max-height:260px;overflow-y:auto;z-index:150;display:none;margin-top:4px}
.search-results.show{display:block}
.search-result-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.06);display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;align-items:center}
.search-result-sym{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700;color:#ffffff}
.search-result-name{font-size:13px;color:#64748b;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.search-result-add{font-size:12px;font-weight:600;color:#3b82f6;padding:4px 12px;border:1px solid #3b82f6;border-radius:100px;white-space:nowrap}
.pull-indicator{text-align:center;height:0;overflow:hidden;color:#64748b;font-size:13px;font-weight:600;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center}
.pull-indicator.pulling,.pull-indicator.refreshing{height:50px}
.pull-spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,0.10);border-top-color:#3b82f6;border-radius:50%;-webkit-animation:spin 0.8s linear infinite;animation:spin 0.8s linear infinite;margin-right:8px;display:inline-block}
@-webkit-keyframes spin{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}
@keyframes spin{to{transform:rotate(360deg)}}
.sector-tabs{display:-webkit-flex;display:flex;padding:16px 24px 0 24px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.sector-tab{font-family:'Inter',sans-serif;font-size:13px;font-weight:600;padding:8px 18px;margin-right:8px;border-radius:100px;border:1.5px solid rgba(255,255,255,0.10);background-color:transparent;color:#94a3b8;cursor:pointer;white-space:nowrap;-webkit-flex-shrink:0;flex-shrink:0}
.sector-tab.active{background-color:#3b82f6;border-color:#3b82f6;color:#ffffff}
.divider{height:1px;background-color:rgba(255,255,255,0.06);margin:16px 24px}
.demo-banner{margin:16px 24px 0 24px;padding:8px 16px;background-color:rgba(245,158,11,0.12);border:1px solid rgba(245,158,11,0.25);border-radius:12px;font-size:13px;color:#f59e0b;text-align:center;cursor:pointer}
.demo-banner.hidden{display:none}
.portfolio-card{margin:16px 24px 0 24px;padding:24px;background-color:#222938;border-radius:16px;border:1px solid rgba(255,255,255,0.06)}
.portfolio-label{font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:#64748b}
.portfolio-value{font-family:'JetBrains Mono',monospace;font-size:42px;font-weight:700;letter-spacing:-1px;margin-top:4px;color:#94a3b8}
.portfolio-change{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:500;margin-top:4px}
.stock-list{padding:16px 24px}
.stock-card-wrap{position:relative;overflow:hidden;margin-bottom:16px;border-radius:16px}
.stock-card-delete{position:absolute;right:0;top:0;bottom:0;width:90px;background-color:#ef4444;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;color:#ffffff;font-size:13px;font-weight:700;letter-spacing:1px;border-radius:0 16px 16px 0;cursor:pointer}
.stock-card{background-color:#222938;border-radius:16px;border:1px solid rgba(255,255,255,0.06);padding:24px;cursor:pointer;position:relative;z-index:2;-webkit-transition:-webkit-transform 0.25s ease;transition:transform 0.25s ease}
.stock-card.swiped{-webkit-transform:translateX(-90px);transform:translateX(-90px)}
.stock-card.dragging{opacity:0.8;-webkit-transform:scale(1.03);transform:scale(1.03);z-index:50;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.stock-header{display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:flex-start;align-items:flex-start}
.stock-symbol{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:#ffffff}
.stock-name{font-size:13px;color:#64748b;margin-top:2px}
.stock-score{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;color:#94a3b8}
.stock-divider{height:1px;background-color:rgba(255,255,255,0.06);margin:16px 0}
.stock-price-row{display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:baseline;align-items:baseline}
.stock-price{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;color:#94a3b8}
.stock-change{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:600}
.stock-mini-row{display:-webkit-flex;display:flex;gap:12px;margin-top:8px;font-size:11px;color:#64748b;font-family:'JetBrains Mono',monospace}
.live-dot{width:6px;height:6px;border-radius:50%;background-color:#10b981;display:inline-block;-webkit-animation:pulse 1.5s infinite;animation:pulse 1.5s infinite;margin-right:4px}
@-webkit-keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.positive{color:#10b981}.negative{color:#ef4444}
.tab-bar{position:fixed;bottom:0;left:0;right:0;display:-webkit-flex;display:flex;-webkit-justify-content:space-around;justify-content:space-around;-webkit-align-items:center;align-items:center;padding:10px 0 calc(10px + env(safe-area-inset-bottom));background-color:#1a1f2e;border-top:1px solid rgba(255,255,255,0.06);z-index:200}
.tab-item{display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;-webkit-align-items:center;align-items:center;cursor:pointer;padding:4px 8px;border:none;background:none;color:#64748b;font-size:9px;font-weight:600;letter-spacing:0.5px}
.tab-item.active{color:#3b82f6}
.tab-item svg{width:20px;height:20px;margin-bottom:2px}
.view{display:none}.view.active{display:block}
.detail-modal{position:fixed;top:0;left:0;right:0;bottom:0;background-color:#0f1419;z-index:300;overflow-y:auto;-webkit-overflow-scrolling:touch;-webkit-transform:translateY(100%);transform:translateY(100%);-webkit-transition:-webkit-transform 0.3s ease-out;transition:transform 0.3s ease-out}
.detail-modal.active{-webkit-transform:translateY(0);transform:translateY(0)}
.detail-header{position:-webkit-sticky;position:sticky;top:0;display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;align-items:center;padding:calc(env(safe-area-inset-top) + 16px) 24px 16px 24px;background-color:#0f1419;z-index:10}
.detail-symbol{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:#ffffff}
.detail-name{font-size:13px;color:#64748b}
.close-btn{width:36px;height:36px;border-radius:50%;border:1px solid rgba(255,255,255,0.10);background-color:#1a1f2e;color:#94a3b8;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;cursor:pointer;font-size:18px}
.detail-body{padding:0 24px 48px 24px}
.detail-price-block{text-align:center;padding:24px 0 32px 0}
.detail-price{font-family:'JetBrains Mono',monospace;font-size:52px;font-weight:700;letter-spacing:-2px;color:#ffffff}
.detail-change-row{display:-webkit-flex;display:flex;-webkit-justify-content:center;justify-content:center;margin-top:6px}
.detail-change-val{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600;margin:0 8px}
.chart-card{background-color:#222938;border-radius:16px;border:1px solid rgba(255,255,255,0.06);padding:16px;margin-bottom:16px;overflow:hidden}
.chart-timeframes{display:-webkit-flex;display:flex;-webkit-justify-content:center;justify-content:center;margin-bottom:8px}
.tf-btn{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;padding:6px 14px;margin:0 3px;border-radius:100px;border:1px solid rgba(255,255,255,0.10);background-color:transparent;color:#94a3b8;cursor:pointer}
.tf-btn.active{background-color:#3b82f6;border-color:#3b82f6;color:#ffffff}
.chart-wrap{position:relative;width:100%;height:260px}
.chart-wrap canvas{display:block;border-radius:6px}
.chart-wrap-tall{position:relative;width:100%;height:380px}
.chart-wrap-tall canvas{display:block;border-radius:6px}
.chart-loading{position:absolute;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);color:#64748b;font-size:13px}
.chart-legend{display:-webkit-flex;display:flex;-webkit-flex-wrap:wrap;flex-wrap:wrap;gap:12px;padding:8px 0 4px 0;font-size:10px;font-weight:600;color:#64748b}
.chart-legend-item{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;gap:4px}
.chart-legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.indicator-toggles{display:-webkit-flex;display:flex;gap:6px;margin:8px 0;-webkit-flex-wrap:wrap;flex-wrap:wrap}
.ind-toggle{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;padding:5px 12px;border-radius:100px;border:1px solid rgba(255,255,255,0.10);background-color:transparent;color:#64748b;cursor:pointer}
.ind-toggle.active{border-color:#3b82f6;color:#3b82f6;background-color:rgba(59,130,246,0.08)}
.section-card{background-color:#222938;border-radius:16px;border:1px solid rgba(255,255,255,0.06);padding:24px;margin-bottom:16px}
.section-label{font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:#64748b;margin-bottom:16px}
.signal-badge{display:inline-block;padding:6px 16px;border-radius:100px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;letter-spacing:1px}
.signal-buy{background-color:rgba(16,185,129,0.12);color:#10b981}
.signal-sell{background-color:rgba(239,68,68,0.12);color:#ef4444}
.signal-hold{background-color:rgba(245,158,11,0.12);color:#f59e0b}
.signal-strong-buy{background-color:#10b981;color:#ffffff}
.signal-strong-sell{background-color:#ef4444;color:#ffffff}
.analysis-text{font-size:14px;line-height:1.65;color:#94a3b8}
.metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.metric-label{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:#64748b;margin-bottom:4px}
.metric-value{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:#ffffff}
.risk-bar-track{height:6px;background-color:#1a1f2e;border-radius:3px;margin-top:8px;overflow:hidden}
.risk-bar-fill{height:100%;border-radius:3px}
.earnings-table{width:100%;border-collapse:collapse;margin-top:12px}
.earnings-table th{font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:#64748b;padding:8px 6px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.06)}
.earnings-table td{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:#94a3b8;padding:10px 6px;border-bottom:1px solid rgba(255,255,255,0.04)}
.earnings-table td.beat{color:#10b981}.earnings-table td.miss{color:#ef4444}
.earnings-next{display:inline-block;padding:6px 14px;border-radius:100px;background-color:rgba(59,130,246,0.12);color:#3b82f6;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;margin-bottom:12px}
.analyst-bar-wrap{margin:12px 0 16px 0}
.analyst-bar{display:-webkit-flex;display:flex;height:24px;border-radius:12px;overflow:hidden;background-color:#1a1f2e}
.analyst-bar-seg{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;font-size:11px;font-weight:700;color:#ffffff;min-width:24px}
.analyst-bar-buy{background-color:#10b981}.analyst-bar-hold{background-color:#f59e0b}.analyst-bar-sell{background-color:#ef4444}
.analyst-labels{display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;margin-top:6px;font-size:11px;color:#64748b}
.heatmap-wrap{position:relative;width:100%;height:400px;margin-bottom:16px}
.heatmap-wrap canvas{display:block;border-radius:12px}
.peer-selectors{display:-webkit-flex;display:flex;gap:8px;margin-bottom:16px}
.peer-select{-webkit-flex:1;flex:1;padding:10px 12px;background-color:#1a1f2e;border:1px solid rgba(255,255,255,0.10);border-radius:10px;color:#ffffff;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;-webkit-appearance:none}
.peer-table{width:100%;border-collapse:collapse}
.peer-table th{font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:#64748b;padding:10px 6px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.06)}
.peer-table td{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;color:#94a3b8;padding:12px 6px;border-bottom:1px solid rgba(255,255,255,0.04)}
.peer-table td:first-child{color:#ffffff;font-weight:700}
.score-chart-wrap{position:relative;width:100%;height:200px}
.score-chart-wrap canvas{display:block;border-radius:6px}
.watchlist-bar{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;padding:0 24px;margin-bottom:8px;gap:8px}
.watchlist-select{-webkit-flex:1;flex:1;padding:10px 14px;background-color:#222938;border:1px solid rgba(255,255,255,0.10);border-radius:10px;color:#ffffff;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;-webkit-appearance:none}
.watchlist-btn{width:36px;height:36px;border-radius:10px;border:1px solid rgba(255,255,255,0.10);background-color:#222938;color:#94a3b8;font-size:18px;font-weight:700;cursor:pointer;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center}
.watchlist-modal{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.7);z-index:400;display:none;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center}
.watchlist-modal.active{display:-webkit-flex;display:flex}
.watchlist-dialog{background-color:#1a1f2e;border:1px solid rgba(255,255,255,0.10);border-radius:16px;padding:24px;width:90%;max-width:360px}
.watchlist-dialog input{width:100%;padding:12px 16px;background-color:#222938;border:1px solid rgba(255,255,255,0.10);border-radius:10px;color:#ffffff;font-family:'Inter',sans-serif;font-size:15px;margin:12px 0;outline:none}
.watchlist-dialog-btns{display:-webkit-flex;display:flex;gap:8px;margin-top:12px}
.watchlist-dialog-btns button{-webkit-flex:1;flex:1;padding:10px;border-radius:10px;border:none;font-family:'Inter',sans-serif;font-size:14px;font-weight:600;cursor:pointer}
.wl-btn-cancel{background-color:#222938;color:#94a3b8}
.wl-btn-save{background-color:#3b82f6;color:#ffffff}
.wl-btn-delete{background-color:#ef4444;color:#ffffff}
.news-item{padding:24px 0;border-bottom:1px solid rgba(255,255,255,0.06)}
.news-item:last-child{border-bottom:none}
.news-source-row{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;margin-bottom:8px}
.news-monogram{width:28px;height:28px;border-radius:6px;background-color:rgba(59,130,246,0.15);color:#3b82f6;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;margin-right:8px}
.news-source-name{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:#64748b}
.news-time{font-size:11px;color:#64748b;margin-left:auto}
.news-headline{font-size:16px;font-weight:600;line-height:1.4;color:#ffffff;margin-bottom:8px}
.news-link{font-size:13px;font-weight:600;color:#3b82f6;text-decoration:none}
.news-sentiment{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;gap:8px;margin-top:8px;-webkit-flex-wrap:wrap;flex-wrap:wrap}
.news-ticker-tag{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;padding:3px 10px;border-radius:100px;background-color:rgba(59,130,246,0.12);color:#3b82f6;cursor:pointer}
.news-signal{font-size:11px;font-weight:700;letter-spacing:0.5px}
.news-signal.bullish{color:#10b981}.news-signal.bearish{color:#ef4444}.news-signal.neutral{color:#f59e0b}
.holding-item,.insider-item{padding:16px 0;border-bottom:1px solid rgba(255,255,255,0.06)}
.holding-name{font-size:15px;font-weight:600;color:#ffffff}
.holding-detail{font-family:'JetBrains Mono',monospace;font-size:13px;color:#94a3b8;margin-top:4px}
.insider-action{display:inline-block;padding:3px 10px;border-radius:100px;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700}
.insider-buy{background-color:rgba(16,185,129,0.12);color:#10b981}
.insider-sell{background-color:rgba(239,68,68,0.12);color:#ef4444}
.insider-name{font-size:15px;font-weight:600;color:#ffffff;margin-top:6px}
.insider-role{font-size:12px;color:#64748b}
.insider-detail{font-family:'JetBrains Mono',monospace;font-size:13px;color:#94a3b8;margin-top:4px}
.sec-citation{font-size:11px;color:#64748b;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.06);font-style:italic}
.analysis-subtabs{display:-webkit-flex;display:flex;margin-bottom:20px;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.analysis-subtab{font-family:'Inter',sans-serif;font-size:12px;font-weight:600;padding:8px 14px;border-radius:100px;border:1.5px solid rgba(255,255,255,0.10);background-color:transparent;color:#94a3b8;cursor:pointer;white-space:nowrap;-webkit-flex-shrink:0;flex-shrink:0}
.analysis-subtab.active{background-color:#3b82f6;border-color:#3b82f6;color:#ffffff}
.analysis-stock-select{width:100%;padding:12px 16px;background-color:#222938;border:1px solid rgba(255,255,255,0.10);border-radius:12px;color:#ffffff;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;-webkit-appearance:none;cursor:pointer;margin-bottom:16px}
.analysis-view-content{padding:16px 24px}
.analysis-chart-wrap{position:relative;width:100%;height:320px;margin-top:12px}
.analysis-chart-wrap canvas{display:block;border-radius:6px}
.news-view-content{padding:16px 24px}
.news-filter-row{display:-webkit-flex;display:flex;margin-bottom:24px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.settings-content{padding:16px 24px}
.setting-group{margin-bottom:32px}
.setting-group-title{font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:#64748b;margin-bottom:16px}
.setting-row{display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;align-items:center;padding:16px 0;border-bottom:1px solid rgba(255,255,255,0.06)}
.setting-label{font-size:15px;font-weight:500;color:#ffffff}
.setting-desc{font-size:12px;color:#64748b;margin-top:2px}
.toggle{position:relative;width:48px;height:28px;background-color:#1a1f2e;border-radius:14px;border:1px solid rgba(255,255,255,0.10);cursor:pointer}
.toggle.active{background-color:#3b82f6;border-color:#3b82f6}
.toggle::after{content:'';position:absolute;width:22px;height:22px;background-color:#ffffff;border-radius:50%;top:2px;left:2px;-webkit-transition:-webkit-transform 0.2s;transition:transform 0.2s}
.toggle.active::after{-webkit-transform:translateX(20px);transform:translateX(20px)}
.setting-input{background-color:#222938;border:1px solid rgba(255,255,255,0.10);border-radius:6px;color:#ffffff;font-family:'JetBrains Mono',monospace;font-size:14px;padding:8px 12px;width:140px;text-align:right}
.setting-btn{padding:10px 20px;border:none;border-radius:12px;background-color:#3b82f6;color:#ffffff;font-family:'Inter',sans-serif;font-size:14px;font-weight:600;cursor:pointer}
.setting-btn.danger{background-color:#ef4444}
.about-block{padding:24px;background-color:#222938;border-radius:16px;border:1px solid rgba(255,255,255,0.06)}
.about-title{font-family:'Playfair Display',Georgia,serif;font-size:22px;font-weight:900;color:#ffffff;margin-bottom:4px}
.about-version{font-family:'JetBrains Mono',monospace;font-size:12px;color:#64748b}
.about-text{font-size:14px;line-height:1.6;color:#94a3b8;margin-top:16px}
.skeleton-block{height:80px;border-radius:12px;margin-bottom:16px;background-color:#1a1f2e}
.toast{position:fixed;bottom:calc(80px + env(safe-area-inset-bottom));left:50%;-webkit-transform:translateX(-50%) translateY(100px);transform:translateX(-50%) translateY(100px);padding:10px 24px;background-color:#1a1f2e;border:1px solid rgba(255,255,255,0.10);border-radius:100px;font-size:13px;font-weight:600;color:#ffffff;z-index:500;opacity:0;-webkit-transition:all 0.3s;transition:all 0.3s;white-space:nowrap}
.toast.show{-webkit-transform:translateX(-50%) translateY(0);transform:translateX(-50%) translateY(0);opacity:1}
.text-center{text-align:center}.mt-sm{margin-top:8px}.mt-md{margin-top:16px}.mb-md{margin-bottom:16px}
.outlook-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.outlook-card{background-color:#1a1f2e;border-radius:12px;padding:16px}
.outlook-timeframe{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:#64748b;margin-bottom:6px}
.outlook-text{font-size:13px;line-height:1.5;color:#94a3b8}
.action-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;text-align:center}
.action-label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:#64748b;margin-bottom:4px}
.action-value{font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:700}
.action-entry{color:#3b82f6}.action-target{color:#10b981}.action-stop{color:#ef4444}
/* Paper trading */
.trade-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
.trade-input{width:100%;padding:10px 12px;background-color:#1a1f2e;border:1px solid rgba(255,255,255,0.10);border-radius:10px;color:#ffffff;font-family:'JetBrains Mono',monospace;font-size:14px;outline:none}
.trade-btn{padding:12px;border:none;border-radius:12px;font-family:'Inter',sans-serif;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:0.5px}
.trade-btn-buy{background-color:#10b981;color:#ffffff}
.trade-btn-sell{background-color:#ef4444;color:#ffffff}
.trade-journal-item{padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.04);display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;align-items:center}
/* Position sizer */
.sizer-row{display:-webkit-flex;display:flex;gap:12px;margin-bottom:12px;-webkit-align-items:center;align-items:center}
.sizer-label{font-size:12px;font-weight:600;color:#64748b;min-width:80px}
.sizer-result{text-align:center;padding:20px;background-color:#1a1f2e;border-radius:12px;margin-top:16px}
.sizer-big{font-family:'JetBrains Mono',monospace;font-size:36px;font-weight:700;color:#3b82f6}
/* Pie chart */
.pie-wrap{position:relative;width:100%;height:280px;display:-webkit-flex;display:flex;-webkit-justify-content:center;justify-content:center}
.pie-wrap canvas{display:block}
.pie-legend{margin-top:16px}
.pie-legend-item{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;gap:8px;padding:6px 0;font-size:13px;color:#94a3b8}
.pie-legend-dot{width:12px;height:12px;border-radius:3px;-webkit-flex-shrink:0;flex-shrink:0}
/* Correlation matrix */
.corr-wrap{position:relative;width:100%;overflow-x:auto}
.corr-wrap canvas{display:block;border-radius:8px}
/* Econ calendar */
.econ-item{padding:16px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
.econ-date{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:#3b82f6}
.econ-title{font-size:15px;font-weight:600;color:#ffffff;margin-top:4px}
.econ-impact{display:inline-block;padding:2px 10px;border-radius:100px;font-size:10px;font-weight:700;letter-spacing:0.5px;margin-top:4px}
.econ-high{background-color:rgba(239,68,68,0.12);color:#ef4444}
.econ-medium{background-color:rgba(245,158,11,0.12);color:#f59e0b}
.econ-low{background-color:rgba(16,185,129,0.12);color:#10b981}
/* Dividend */
.div-row{display:-webkit-flex;display:flex;-webkit-justify-content:space-between;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
.div-sym{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:#ffffff}
.div-yield{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;color:#10b981}
/* Theme picker */
.theme-options{display:-webkit-flex;display:flex;gap:12px;margin-top:12px}
.theme-opt{width:48px;height:48px;border-radius:12px;border:2px solid rgba(255,255,255,0.10);cursor:pointer;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;font-size:10px;font-weight:700;color:#64748b}
.theme-opt.active{border-color:#3b82f6;color:#3b82f6}
.color-options{display:-webkit-flex;display:flex;gap:8px;margin-top:8px}
.color-opt{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer}
.color-opt.active{border-color:#ffffff}
/* Multi-timeframe */
.mtf-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
.mtf-cell{background-color:#1a1f2e;border-radius:8px;padding:8px;overflow:hidden}
.mtf-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:#64748b;margin-bottom:4px}
.mtf-cell canvas{display:block;border-radius:4px}
/* Crosshair tooltip */
.chart-tooltip{position:absolute;background-color:rgba(26,31,46,0.95);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:8px 12px;font-family:'JetBrains Mono',monospace;font-size:11px;color:#ffffff;pointer-events:none;z-index:10;white-space:nowrap;display:none}
/* Perf chart */
.perf-wrap{position:relative;width:100%;height:240px}
.perf-wrap canvas{display:block;border-radius:6px}
/* PWA install */
.pwa-banner{margin:8px 24px;padding:10px 16px;background-color:rgba(59,130,246,0.12);border:1px solid rgba(59,130,246,0.25);border-radius:12px;font-size:13px;color:#3b82f6;text-align:center;cursor:pointer;display:none}
.pwa-banner.show{display:block}
/* Export */
.export-btns{display:-webkit-flex;display:flex;gap:8px;margin-top:12px}
.export-btn{padding:8px 16px;border:1px solid rgba(255,255,255,0.10);border-radius:10px;background-color:transparent;color:#94a3b8;font-size:12px;font-weight:600;cursor:pointer}
@media (min-width:768px){body{max-width:480px;margin:0 auto}}
/* v15 Signal Filters */
.signal-filters{display:-webkit-flex;display:flex;padding:12px 24px 0 24px;overflow-x:auto;-webkit-overflow-scrolling:touch;gap:8px}
.signal-filter{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;padding:8px 16px;border-radius:100px;border:1.5px solid rgba(255,255,255,0.10);background-color:transparent;color:#94a3b8;cursor:pointer;white-space:nowrap;-webkit-flex-shrink:0;flex-shrink:0;letter-spacing:0.5px}
.signal-filter.active{color:#ffffff}
.signal-filter[data-sig="all"].active{background-color:#3b82f6;border-color:#3b82f6}
.signal-filter[data-sig="strong-buy"].active{background-color:#059669;border-color:#059669}
.signal-filter[data-sig="buy"].active{background-color:#10b981;border-color:#10b981}
.signal-filter[data-sig="hold"].active{background-color:#f59e0b;border-color:#f59e0b}
.signal-filter[data-sig="sell"].active{background-color:#ef4444;border-color:#ef4444}
.signal-filter[data-sig="strong-sell"].active{background-color:#dc2626;border-color:#dc2626}
/* Trending badge */
.trending-badge{display:inline-block;padding:2px 8px;border-radius:100px;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;letter-spacing:0.5px;margin-left:6px}
.trending-gainer{background-color:rgba(16,185,129,0.12);color:#10b981}
.trending-loser{background-color:rgba(239,68,68,0.12);color:#ef4444}
.trending-active{background-color:rgba(59,130,246,0.12);color:#3b82f6}
.trending-hot{background-color:rgba(245,158,11,0.12);color:#f59e0b}
/* Source label */
.source-label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:#64748b;padding:20px 0 8px 0}
/* AI View */
.ai-view-content{padding:16px 24px}
.ai-card{background-color:#222938;border-radius:16px;border:1px solid rgba(255,255,255,0.06);padding:20px;margin-bottom:12px;cursor:pointer;-webkit-transition:border-color 0.2s;transition:border-color 0.2s}
.ai-card:active{border-color:rgba(139,92,246,0.4)}
.ai-card-icon{font-size:28px;margin-bottom:12px}
.ai-card-title{font-size:16px;font-weight:700;color:#ffffff;margin-bottom:4px}
.ai-card-desc{font-size:13px;color:#94a3b8;line-height:1.5}
.ai-card-badge{display:inline-block;padding:3px 10px;border-radius:100px;font-size:10px;font-weight:700;letter-spacing:0.5px;margin-top:10px}
.ai-badge-pro{background-color:rgba(139,92,246,0.12);color:#8b5cf6}
.ai-chat-container{display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;height:calc(100vh - 200px)}
.ai-chat-messages{-webkit-flex:1;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 0}
.ai-msg{margin-bottom:16px;max-width:85%}
.ai-msg-user{margin-left:auto;background-color:#3b82f6;color:#ffffff;padding:12px 16px;border-radius:16px 16px 4px 16px;font-size:14px;line-height:1.5}
.ai-msg-ai{background-color:#222938;border:1px solid rgba(255,255,255,0.06);color:#ffffff;padding:16px;border-radius:16px 16px 16px 4px;font-size:14px;line-height:1.65}
.ai-msg-ai .analysis-text{color:#94a3b8}
.ai-typing{color:#8b5cf6;font-size:13px;font-weight:600;padding:8px 0}
.ai-chat-input-row{display:-webkit-flex;display:flex;gap:8px;padding:12px 0;border-top:1px solid rgba(255,255,255,0.06)}
.ai-chat-input{-webkit-flex:1;flex:1;padding:12px 16px;background-color:#222938;border:1px solid rgba(255,255,255,0.10);border-radius:12px;color:#ffffff;font-family:'Inter',sans-serif;font-size:15px;outline:none;-webkit-appearance:none}
.ai-chat-input:focus{border-color:#8b5cf6}
.ai-send-btn{width:44px;height:44px;border-radius:12px;border:none;background-color:#8b5cf6;color:#ffffff;font-size:18px;cursor:pointer;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center}
.ai-result-card{background-color:#1a1f2e;border-radius:12px;padding:16px;margin-top:12px}
.ai-trade-idea{border-left:3px solid #8b5cf6;padding-left:16px;margin:12px 0}
.ai-trade-sym{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:#ffffff}
.ai-trade-signal{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;padding:4px 12px;border-radius:100px;display:inline-block;margin-left:8px}
.ai-key-row{display:-webkit-flex;display:flex;gap:8px;margin:16px 0;-webkit-align-items:center;align-items:center}
.ai-key-input{-webkit-flex:1;flex:1;padding:10px 14px;background-color:#1a1f2e;border:1px solid rgba(255,255,255,0.10);border-radius:10px;color:#ffffff;font-family:'JetBrains Mono',monospace;font-size:12px;outline:none}
.ai-key-save{padding:10px 16px;border:none;border-radius:10px;background-color:#8b5cf6;color:#ffffff;font-size:13px;font-weight:600;cursor:pointer}
.ai-back-btn{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;gap:6px;font-size:14px;font-weight:600;color:#8b5cf6;background:none;border:none;cursor:pointer;padding:8px 0;margin-bottom:16px}
</style>
</head>
<body>
<div id="stocksView" class="view active">
  <div class="header">
    <div class="brand-title">Bulls Eye Pro</div>
    <div class="brand-subtitle">Version 15.0 Professional Edition</div>
  </div>
  <div class="search-container">
    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
    <input class="search-input" id="searchInput" type="text" placeholder="Search any ticker..." autocomplete="off" autocorrect="off" spellcheck="false">
    <div class="search-results" id="searchResults"></div>
  </div>
  <div class="pwa-banner" id="pwaBanner" onclick="installPWA()">Install Bulls Eye Pro for offline access</div>
  <div class="watchlist-bar">
    <select class="watchlist-select" id="watchlistSelect" onchange="switchWatchlist()"></select>
    <button class="watchlist-btn" onclick="openWatchlistModal('new')" title="New list">+</button>
    <button class="watchlist-btn" onclick="openWatchlistModal('edit')" title="Edit" style="font-size:14px">&#9998;</button>
  </div>
  <div class="signal-filters" id="signalFilters">
    <button class="signal-filter active" data-sig="all" onclick="filterSignal('all')">ALL</button>
    <button class="signal-filter" data-sig="strong-buy" onclick="filterSignal('strong-buy')">STRONG BUY</button>
    <button class="signal-filter" data-sig="buy" onclick="filterSignal('buy')">BUY</button>
    <button class="signal-filter" data-sig="hold" onclick="filterSignal('hold')">HOLD</button>
    <button class="signal-filter" data-sig="sell" onclick="filterSignal('sell')">SELL</button>
    <button class="signal-filter" data-sig="strong-sell" onclick="filterSignal('strong-sell')">STRONG SELL</button>
  </div>
  <div class="divider"></div>
  <div class="pull-indicator" id="pullIndicator"><span id="pullText">Pull to refresh</span></div>
  <div class="demo-banner hidden" id="demoBanner" onclick="manualRefresh()">Demo mode - tap to try live data</div>
  <div id="stockListContainer"></div>
</div>
<div id="analysisView" class="view">
  <div class="header"><div class="brand-title">Analysis</div><div class="brand-subtitle">AI-Powered Insights</div></div>
  <div class="analysis-view-content">
    <div class="analysis-subtabs" id="analysisSubtabs">
      <button class="analysis-subtab active" onclick="switchAT('stock')">Stock</button>
      <button class="analysis-subtab" onclick="switchAT('heatmap')">Heatmap</button>
      <button class="analysis-subtab" onclick="switchAT('compare')">Compare</button>
      <button class="analysis-subtab" onclick="switchAT('scores')">Scores</button>
      <button class="analysis-subtab" onclick="switchAT('mtf')">Multi-TF</button>
      <button class="analysis-subtab" onclick="switchAT('corr')">Correlation</button>
      <button class="analysis-subtab" onclick="switchAT('alloc')">Allocation</button>
      <button class="analysis-subtab" onclick="switchAT('perf')">Performance</button>
      <button class="analysis-subtab" onclick="switchAT('econ')">Calendar</button>
      <button class="analysis-subtab" onclick="switchAT('div')">Dividends</button>
      <button class="analysis-subtab" onclick="switchAT('predict')">Predict</button>
      <button class="analysis-subtab" onclick="switchAT('volume')">Volume</button>
    </div>
    <div id="analysisTabContent"></div>
  </div>
</div>
<div id="aiView" class="view">
  <div class="header"><div class="brand-title" style="background:linear-gradient(135deg,#8b5cf6,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent">AI Intelligence</div><div class="brand-subtitle">Powered by Claude</div></div>
  <div class="ai-view-content" id="aiContent"></div>
</div>
<div id="tradeView" class="view">
  <div class="header"><div class="brand-title">Paper Trade</div><div class="brand-subtitle">Simulated Trading Journal</div></div>
  <div class="analysis-view-content" id="tradeContent"></div>
</div>
<div id="newsView" class="view">
  <div class="header"><div class="brand-title">Market News</div><div class="brand-subtitle">Real-Time Financial Headlines</div></div>
  <div class="news-view-content"><div class="news-filter-row" id="newsFilterRow"></div><div id="newsContent"></div></div>
</div>
<div id="settingsView" class="view">
  <div class="header"><div class="brand-title">Settings</div><div class="brand-subtitle">Configuration and Preferences</div></div>
  <div class="settings-content" id="settingsContent"></div>
</div>
<div class="detail-modal" id="detailModal">
  <div class="detail-header"><div><div class="detail-symbol" id="detailSymbol"></div><div class="detail-name" id="detailName"></div></div><button class="close-btn" onclick="closeDetail()">&#x2715;</button></div>
  <div class="detail-body" id="detailContent"></div>
</div>
<div class="watchlist-modal" id="watchlistModal">
  <div class="watchlist-dialog"><div class="section-label" id="wlModalTitle">New Watchlist</div><input type="text" id="wlNameInput" placeholder="List name..."><div class="watchlist-dialog-btns" id="wlModalBtns"></div></div>
</div>
<nav class="tab-bar">
  <button class="tab-item active" data-view="stocks" onclick="switchView('stocks')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect></svg>Home
  </button>
  <button class="tab-item" data-view="analysis" onclick="switchView('analysis')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>Analysis
  </button>
  <button class="tab-item" data-view="ai" onclick="switchView('ai')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 014 4v1a4 4 0 01-8 0V6a4 4 0 014-4z"></path><path d="M6 13a6 6 0 0012 0"></path><path d="M12 17v4M8 21h8"></path></svg>AI
  </button>
  <button class="tab-item" data-view="trade" onclick="switchView('trade')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg>Trade
  </button>
  <button class="tab-item" data-view="news" onclick="switchView('news')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2"></path></svg>News
  </button>
  <button class="tab-item" data-view="settings" onclick="switchView('settings')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"></path></svg>More
  </button>
</nav>
<div class="toast" id="toast"></div>
<div class="chart-tooltip" id="chartTooltip"></div>
<script>
/* ═══════════════════════════════════════════
   BULLS EYE PRO v15.0 — Market Scanner + AI
   ═══════════════════════════════════════════ */
var DEFAULT_STOCKS=[{symbol:'NVDA',name:'NVIDIA Corporation',sector:'tech'},{symbol:'TSLA',name:'Tesla Inc.',sector:'tech'},{symbol:'AMD',name:'Advanced Micro Devices',sector:'tech'},{symbol:'AAPL',name:'Apple Inc.',sector:'tech'},{symbol:'MSFT',name:'Microsoft Corporation',sector:'tech'},{symbol:'GOOGL',name:'Alphabet Inc.',sector:'tech'},{symbol:'META',name:'Meta Platforms Inc.',sector:'tech'},{symbol:'AMZN',name:'Amazon.com Inc.',sector:'tech'},{symbol:'JPM',name:'JPMorgan Chase',sector:'finance'},{symbol:'BAC',name:'Bank of America',sector:'finance'},{symbol:'WMT',name:'Walmart Inc.',sector:'finance'},{symbol:'V',name:'Visa Inc.',sector:'finance'},{symbol:'JNJ',name:'Johnson & Johnson',sector:'healthcare'},{symbol:'UNH',name:'UnitedHealth Group',sector:'healthcare'},{symbol:'XOM',name:'Exxon Mobil',sector:'energy'}];
var watchlists={};try{var wlR=localStorage.getItem('bep_watchlists');if(wlR)watchlists=JSON.parse(wlR);}catch(e){}
if(!watchlists['Portfolio'])watchlists['Portfolio']=DEFAULT_STOCKS.slice();
var activeWatchlist='Portfolio';try{var awl=localStorage.getItem('bep_active_wl');if(awl&&watchlists[awl])activeWatchlist=awl;}catch(e){}
function saveWL(){try{localStorage.setItem('bep_watchlists',JSON.stringify(watchlists));localStorage.setItem('bep_active_wl',activeWatchlist);}catch(e){}}
function getAS(){return watchlists[activeWatchlist]||watchlists['Portfolio']||DEFAULT_STOCKS;}
var THEMES=['dark','light','oled'];var ACCENTS=['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
var state={currentTab:'all',signalFilter:'all',currentView:'stocks',stocks:[],trendingStocks:[],usingDemo:true,newsCache:{},analysisSymbol:'NVDA',analysisSubtab:'stock',newsSymbol:'all',lastUpdated:null,wsConnected:false,aiView:'menu',aiMessages:[],
  indicators:{ema:true,bb:true,rsi:true,macd:false},
  settings:{apiKey:'d66ri2hr01qnh6sg33s0d66ri2hr01qnh6sg33s0',anthropicKey:'',compactView:false,showPreMarket:false,autoRefresh:false,refreshInterval:60,theme:'dark',accent:'#3b82f6',notifications:true}};
try{var ss=localStorage.getItem('bep_settings');if(ss)Object.assign(state.settings,JSON.parse(ss));}catch(e){}
var trades=[];try{var tr=localStorage.getItem('bep_trades');if(tr)trades=JSON.parse(tr);}catch(e){}
function saveTrades(){try{localStorage.setItem('bep_trades',JSON.stringify(trades));}catch(e){}}
var paperBalance=10000;try{var pb=localStorage.getItem('bep_balance');if(pb)paperBalance=parseFloat(pb);}catch(e){}
function saveBalance(){try{localStorage.setItem('bep_balance',String(paperBalance));}catch(e){}}
var CACHE_TTL=300000;
function getCQ(s){try{var r=localStorage.getItem('bep_q_'+s);if(!r)return null;var c=JSON.parse(r);if(Date.now()-c.ts>CACHE_TTL){localStorage.removeItem('bep_q_'+s);return null;}return c.data;}catch(e){return null;}}
function setCQ(s,d){try{localStorage.setItem('bep_q_'+s,JSON.stringify({data:d,ts:Date.now()}));}catch(e){}}
var FH='https://finnhub.io/api/v1';var FMP='https://financialmodelingprep.com/api/v3';var FK='dbyJKcNqHMjGFhkCOIrXSaWBezAvYglf';var PX='https://api.allorigins.win/raw?url=';var DS='auto';
function sfetch(url){return fetch(url).then(function(r){if(!r.ok)throw new Error(r.status);return r.json();}).catch(function(){return null;});}
function fhQuote(s){return sfetch(FH+'/quote?symbol='+s+'&token='+state.settings.apiKey);}
function fmpQuote(s){return sfetch(FMP+'/quote/'+s+'?apikey='+FK).then(function(d){if(d&&Array.isArray(d)&&d[0]){var q=d[0];return{c:q.price,d:q.change,dp:q.changesPercentage,h:q.dayHigh,l:q.dayLow,o:q.open,pc:q.previousClose,marketCap:q.marketCap,pe:q.pe,name:q.name,sector:q.sector||''};}return null;});}
function yQuote(s){return sfetch(PX+encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/'+s+'?interval=1d&range=1d')).then(function(d){if(d&&d.chart&&d.chart.result&&d.chart.result[0]){var m=d.chart.result[0].meta;var pc=m.chartPreviousClose||m.previousClose||0;var p=m.regularMarketPrice||0;return{c:p,d:+(p-pc).toFixed(2),dp:pc?+((p-pc)/pc*100).toFixed(2):0,h:m.regularMarketDayHigh||p,l:m.regularMarketDayLow||p,o:m.regularMarketOpen||p,pc:pc};}return null;});}
function fetchQ(s){if(DS==='offline')return Promise.resolve(null);return fhQuote(s).then(function(d){if(d&&d.c>0){DS='finnhub';return d;}return fmpQuote(s);}).then(function(d){if(d&&d.c>0){if(DS!=='finnhub')DS='fmp';return d;}return yQuote(s);}).then(function(d){if(d&&d.c>0){if(DS!=='finnhub'&&DS!=='fmp')DS='yahoo';return d;}return null;});}
function apiFetch(ep){var url=FH+ep+(ep.indexOf('?')>=0?'&':'?')+'token='+state.settings.apiKey;return sfetch(url).then(function(d){if(d)return d;return sfetch(PX+encodeURIComponent(url));});}
function fmpFetch(ep){return sfetch(FMP+ep+(ep.indexOf('?')>=0?'&':'?')+'apikey='+FK);}
function fetchProfile(sym){return fmpFetch('/profile/'+sym).then(function(d){if(d&&Array.isArray(d)&&d[0])return{name:d[0].companyName||sym,sector:(d[0].sector||'tech').toLowerCase(),industry:d[0].industry||''};return null;});}
function fetchEarnings(sym){return fmpFetch('/income-statement/'+sym+'?limit=8').then(function(d){if(d&&Array.isArray(d)&&d.length>0)return{quarters:d.map(function(q){return{date:q.date||'',revenue:q.revenue||0,eps:q.eps||0,epsEstimated:q.epsEstimated||0};})};return{quarters:[]};});}
function fetchEarningsCalendar(sym){return fmpFetch('/earning_calendar?symbol='+sym).then(function(d){if(d&&Array.isArray(d)){var f=d.filter(function(e){return new Date(e.date)>new Date();});if(f.length)return f[0];}return{date:'TBD'};});}
function fetchAnalystRatings(sym){return fmpFetch('/grade/'+sym+'?limit=20').then(function(d){if(d&&Array.isArray(d)&&d.length>0){var b=0,h=0,s=0;d.forEach(function(g){var n=(g.newGrade||'').toLowerCase();if(n.indexOf('buy')>=0||n.indexOf('outperform')>=0||n.indexOf('overweight')>=0)b++;else if(n.indexOf('sell')>=0||n.indexOf('underperform')>=0||n.indexOf('underweight')>=0)s++;else h++;});return{buy:b,hold:h,sell:s,firms:d.slice(0,5).map(function(g){return{firm:g.gradingCompany||'Unknown',grade:g.newGrade||'N/A',date:(g.date||'').substring(0,10)};})};} return{buy:8,hold:4,sell:1,firms:[]};});}
function fetchPriceTarget(sym){return fmpFetch('/price-target-consensus/'+sym).then(function(d){if(d&&Array.isArray(d)&&d[0])return{low:d[0].targetLow||0,avg:d[0].targetConsensus||0,high:d[0].targetHigh||0};var s=findStock(sym);var p=s?s.price:100;return{low:+(p*0.85).toFixed(2),avg:+(p*1.12).toFixed(2),high:+(p*1.35).toFixed(2)};});}
function fetchDividend(sym){return fmpFetch('/historical-price-full/stock_dividend/'+sym).then(function(d){if(d&&d.historical&&d.historical.length>0)return d.historical.slice(0,4);return null;});}
function fetchEconCalendar(){return fmpFetch('/economic_calendar?from='+new Date().toISOString().split('T')[0]+'&to='+new Date(Date.now()+14*864e5).toISOString().split('T')[0]).then(function(d){if(d&&Array.isArray(d))return d.slice(0,20);return[];});}
function findStock(sym){for(var i=0;i<state.stocks.length;i++){if(state.stocks[i].symbol===sym)return state.stocks[i];}return null;}
function saveScores(){var today=new Date().toISOString().split('T')[0];var scores={};state.stocks.forEach(function(s){scores[s.symbol]=s.score;});try{var hist=JSON.parse(localStorage.getItem('bep_score_hist')||'{}');hist[today]=scores;var keys=Object.keys(hist).sort();if(keys.length>60)for(var i=0;i<keys.length-60;i++)delete hist[keys[i]];localStorage.setItem('bep_score_hist',JSON.stringify(hist));}catch(e){}}
function getScoreHistory(){try{return JSON.parse(localStorage.getItem('bep_score_hist')||'{}');}catch(e){return {};}}
function savePerfSnapshot(){var today=new Date().toISOString().split('T')[0];var tv=0;state.stocks.forEach(function(s){tv+=s.price;});try{var h=JSON.parse(localStorage.getItem('bep_perf')||'{}');h[today]=tv;var k=Object.keys(h).sort();if(k.length>90)for(var i=0;i<k.length-90;i++)delete h[k[i]];localStorage.setItem('bep_perf',JSON.stringify(h));}catch(e){}}
function getPerfHistory(){try{return JSON.parse(localStorage.getItem('bep_perf')||'{}');}catch(e){return {};}}

/* ═══ SCORING ENGINE ═══ */
function computeSignal(s){
var score=s.score||50;
if(score>=80)return{signal:‘STRONG BUY’,key:‘strong-buy’,cls:‘signal-strong-buy’};
if(score>=65)return{signal:‘BUY’,key:‘buy’,cls:‘signal-buy’};
if(score>=40)return{signal:‘HOLD’,key:‘hold’,cls:‘signal-hold’};
if(score>=25)return{signal:‘SELL’,key:‘sell’,cls:‘signal-sell’};
return{signal:‘STRONG SELL’,key:‘strong-sell’,cls:‘signal-strong-sell’};
}
function scoreStock(q,sym){
/* Multi-factor scoring: momentum + volume + price action */
var score=50;
var dp=q.dp||0;
/* Momentum: strong movers score higher */
if(dp>5)score+=30;else if(dp>3)score+=22;else if(dp>1)score+=12;else if(dp>0)score+=5;
else if(dp<-5)score-=25;else if(dp<-3)score-=18;else if(dp<-1)score-=10;else if(dp<0)score-=4;
/* Price relative to range */
if(q.h&&q.l&&q.h>q.l){var pos=(q.c-(q.l||q.c))/((q.h||q.c)-(q.l||q.c));if(pos>0.8)score+=8;else if(pos<0.2)score-=6;}
/* Market cap bonus (larger = more stable) */
if(q.marketCap){if(q.marketCap>100e9)score+=5;else if(q.marketCap>10e9)score+=2;else if(q.marketCap<1e9)score-=3;}
return Math.min(99,Math.max(5,score));
}
function filterSignal(sig){
state.signalFilter=sig;
var btns=document.querySelectorAll(’.signal-filter’);
for(var i=0;i<btns.length;i++){var d=btns[i].getAttribute(‘data-sig’);btns[i].className=d===sig?‘signal-filter active’:‘signal-filter’;}
renderStocks();
}

/* ═══ MARKET SCANNER — Find best stocks across exchanges ═══ */
function fetchTrendingStocks(){
showToast(‘Scanning markets…’);
return Promise.all([
fmpFetch(’/stock_market/gainers’).then(function(d){return(d||[]).slice(0,10).map(function(s){s._tag=‘gainer’;return s;});}),
fmpFetch(’/stock_market/losers’).then(function(d){return(d||[]).slice(0,5).map(function(s){s._tag=‘loser’;return s;});}),
fmpFetch(’/stock_market/actives’).then(function(d){return(d||[]).slice(0,10).map(function(s){s._tag=‘active’;return s;});})
]).then(function(results){
var all=[];var seen={};
results.forEach(function(group){if(!group)return;group.forEach(function(s){if(!s||!s.symbol||seen[s.symbol]||s.symbol.indexOf(’.’)>=0)return;seen[s.symbol]=true;all.push(s);});});
if(!all.length)return;
state.trendingStocks=all.map(function(s){
var sc=scoreStock({c:s.price,dp:s.changesPercentage||0,h:s.price,l:s.price,marketCap:s.marketCap||0},s.symbol);
return{symbol:s.symbol,name:s.name||s.companyName||s.symbol,sector:‘trending’,price:s.price||0,change:s.change||0,changePercent:s.changesPercentage||0,high:s.price||0,low:s.price||0,open:s.price||0,prevClose:(s.price||0)-(s.change||0),volume:0,marketCap:s.marketCap||0,pe:s.pe||0,score:sc,tag:s._tag||‘active’};
}).sort(function(a,b){return b.score-a.score;});
showToast(‘Found ‘+state.trendingStocks.length+’ trending stocks’);
renderStocks();
}).catch(function(){showToast(‘Scanner unavailable’);});
}

/* WebSocket */
var ws=null;
function connectWS(){try{if(ws)ws.close();}catch(e){}try{ws=new WebSocket(‘wss://ws.finnhub.io?token=’+state.settings.apiKey);ws.onopen=function(){state.wsConnected=true;getAS().forEach(function(s){ws.send(JSON.stringify({type:‘subscribe’,symbol:s.symbol}));});showToast(‘Live stream connected’);};ws.onmessage=function(e){try{var msg=JSON.parse(e.data);if(msg.type===‘trade’&&msg.data){msg.data.forEach(function(t){for(var i=0;i<state.stocks.length;i++){if(state.stocks[i].symbol===t.s){var old=state.stocks[i].price;state.stocks[i].price=t.p;state.stocks[i].change=t.p-state.stocks[i].prevClose;state.stocks[i].changePercent=state.stocks[i].prevClose?((t.p-state.stocks[i].prevClose)/state.stocks[i].prevClose*100):0;var el=document.getElementById(‘price_’+t.s);if(el){el.textContent=’$’+t.p.toFixed(2);el.style.color=t.p>=old?’#10b981’:’#ef4444’;setTimeout(function(){el.style.color=’’;},500);}break;}}});}}catch(ex){}};ws.onclose=function(){state.wsConnected=false;setTimeout(connectWS,5000);};ws.onerror=function(){state.wsConnected=false;};}catch(e){}}

function loadDemoData(){var stocks=getAS();state.stocks=stocks.map(function(s){var bp=50+Math.random()*400;var cp=(Math.random()-0.5)*5;var ch=bp*cp/100;return{symbol:s.symbol,name:s.name||s.symbol,sector:s.sector||‘tech’,price:bp,change:ch,changePercent:cp,high:bp*(1+Math.random()*0.03),low:bp*(1-Math.random()*0.03),open:bp*(1+(Math.random()-0.5)*0.02),prevClose:bp-ch,volume:Math.floor(Math.random()*8e7)+5e6,marketCap:bp*(Math.floor(Math.random()*5000)+500)*1e6,pe:Math.floor(Math.random()*40)+10,score:50+Math.floor(Math.random()*50)};});state.usingDemo=true;}
function loadRealData(){DS=‘auto’;var stocks=getAS();if(!stocks.length)return Promise.resolve();var testSym=stocks[0].symbol;var testC=getCQ(testSym);var p=testC?Promise.resolve(testC):fetchQ(testSym);return p.then(function(test){if(!test||!test.c||test.c<=0){DS=‘offline’;return;}if(!getCQ(testSym))setCQ(testSym,test);var ok=0,i=0;function next(){if(i>=stocks.length){if(ok>0){state.usingDemo=false;state.lastUpdated=new Date();document.getElementById(‘demoBanner’).classList.add(‘hidden’);showToast((DS===‘finnhub’?‘Finnhub’:DS===‘fmp’?‘FMP’:‘Yahoo’)+’: ‘+ok+’ updated’);saveScores();savePerfSnapshot();}return;}var sym=stocks[i].symbol;var cached=getCQ(sym);var dp=cached?Promise.resolve(cached):(sym===testSym?Promise.resolve(test):fetchQ(sym));return dp.then(function(d){if(d&&d.c>0){if(!cached)setCQ(sym,d);for(var j=0;j<state.stocks.length;j++){if(state.stocks[j].symbol===sym){state.stocks[j].price=d.c;state.stocks[j].change=d.d||0;state.stocks[j].changePercent=d.dp||0;state.stocks[j].high=d.h||d.c;state.stocks[j].low=d.l||d.c;state.stocks[j].open=d.o||d.c;state.stocks[j].prevClose=d.pc||d.c;if(d.marketCap)state.stocks[j].marketCap=d.marketCap;if(d.pe)state.stocks[j].pe=d.pe;if(d.name&&state.stocks[j].name===state.stocks[j].symbol)state.stocks[j].name=d.name;state.stocks[j].score=scoreStock(d,sym);ok++;break;}}}i++;if(!cached&&sym!==testSym)return new Promise(function(r){setTimeout(r,150);}).then(next);return next();});};return next();});}
/* ═══════════════════════════════════════════
Charts: Indicators + Interactive + New Types
═══════════════════════════════════════════ */
function calcEMA(data,period){var ema=[];var k=2/(period+1);ema[0]=data[0];for(var i=1;i<data.length;i++)ema[i]=data[i]*k+ema[i-1]*(1-k);return ema;}
function calcRSI(closes,period){var rsi=[];var gains=[];var losses=[];for(var i=1;i<closes.length;i++){var d=closes[i]-closes[i-1];gains.push(d>0?d:0);losses.push(d<0?-d:0);}for(var j=0;j<period;j++)rsi.push(50);if(gains.length<period)return rsi;var avgG=0,avgL=0;for(var k=0;k<period;k++){avgG+=gains[k];avgL+=losses[k];}avgG/=period;avgL/=period;rsi.push(avgL===0?100:100-100/(1+avgG/avgL));for(var m=period;m<gains.length;m++){avgG=(avgG*(period-1)+gains[m])/period;avgL=(avgL*(period-1)+losses[m])/period;rsi.push(avgL===0?100:100-100/(1+avgG/avgL));}return rsi;}
function calcBB(closes,period,mult){var u=[],l=[],m=[];for(var i=0;i<closes.length;i++){if(i<period-1){u.push(null);l.push(null);m.push(null);continue;}var sum=0;for(var j=i-period+1;j<=i;j++)sum+=closes[j];var avg=sum/period;var sq=0;for(var k=i-period+1;k<=i;k++)sq+=Math.pow(closes[k]-avg,2);var std=Math.sqrt(sq/period);m.push(avg);u.push(avg+mult*std);l.push(avg-mult*std);}return{upper:u,lower:l,mid:m};}
function calcMACD(closes){if(closes.length<26)return null;var e12=calcEMA(closes,12);var e26=calcEMA(closes,26);var macdLine=[];for(var i=0;i<closes.length;i++)macdLine.push(e12[i]-e26[i]);var signal=calcEMA(macdLine,9);var hist=[];for(var j=0;j<closes.length;j++)hist.push(macdLine[j]-signal[j]);return{macd:macdLine,signal:signal,histogram:hist};}

function drawChartFull(el,candles,showInd,interactive){
if(!el||!candles||!candles.length)return;
var wrap=el.parentElement;var W=wrap.clientWidth||300;
var hasRSI=showInd&&state.indicators.rsi;var hasMACD=showInd&&state.indicators.macd;
var subH=(hasRSI?0.18:0)+(hasMACD?0.18:0);
var H=260+Math.floor(subH*400);
var dpr=window.devicePixelRatio||1;el.width=W*dpr;el.height=H*dpr;el.style.width=W+‘px’;el.style.height=H+‘px’;
var ctx=el.getContext(‘2d’);ctx.scale(dpr,dpr);
var priceH=H*(0.55-subH*0.2);var volH=H*0.08;
var pad={top:14,right:62,bottom:28,left:8};var cW=W-pad.left-pad.right;
var hi=-Infinity,lo=Infinity,maxV=0;var closes=[];
for(var ci=0;ci<candles.length;ci++){if(candles[ci].high>hi)hi=candles[ci].high;if(candles[ci].low<lo)lo=candles[ci].low;if((candles[ci].volume||0)>maxV)maxV=candles[ci].volume||0;closes.push(candles[ci].close);}
if(showInd&&state.indicators.bb&&closes.length>=20){var bb=calcBB(closes,20,2);for(var bi=0;bi<bb.upper.length;bi++){if(bb.upper[bi]!==null){if(bb.upper[bi]>hi)hi=bb.upper[bi];if(bb.lower[bi]<lo)lo=bb.lower[bi];}}}
var range=hi-lo||1;var n=candles.length;var gap=cW/n;var barW=Math.max(1,gap*0.65);
function pY(v){return pad.top+(1-(v-lo)/range)*priceH;}
/* Grid */
ctx.strokeStyle=‘rgba(255,255,255,0.05)’;ctx.lineWidth=1;
for(var gi=0;gi<5;gi++){var gy=pad.top+priceH*gi/4;ctx.beginPath();ctx.moveTo(pad.left,gy);ctx.lineTo(W-pad.right,gy);ctx.stroke();}
ctx.fillStyle=’#64748b’;ctx.font=‘10px monospace’;ctx.textAlign=‘left’;
for(var pi=0;pi<5;pi++){var pv=hi-range*pi/4;ctx.fillText(’$’+pv.toFixed(pv>999?0:2),W-pad.right+6,pad.top+priceH*pi/4+4);}
/* BB */
if(showInd&&state.indicators.bb&&closes.length>=20){var bbd=calcBB(closes,20,2);ctx.globalAlpha=0.08;ctx.fillStyle=’#8b5cf6’;ctx.beginPath();var st2=false;for(var bu=0;bu<n;bu++){if(bbd.upper[bu]===null)continue;var bux=pad.left+bu*gap+gap/2;if(!st2){ctx.moveTo(bux,pY(bbd.upper[bu]));st2=true;}else ctx.lineTo(bux,pY(bbd.upper[bu]));}for(var bl=n-1;bl>=0;bl–){if(bbd.lower[bl]===null)continue;ctx.lineTo(pad.left+bl*gap+gap/2,pY(bbd.lower[bl]));}ctx.closePath();ctx.fill();ctx.globalAlpha=1;ctx.strokeStyle=’#8b5cf6’;ctx.lineWidth=1;ctx.setLineDash([3,3]);ctx.beginPath();st2=false;for(var b2=0;b2<n;b2++){if(bbd.upper[b2]===null)continue;var b2x=pad.left+b2*gap+gap/2;if(!st2){ctx.moveTo(b2x,pY(bbd.upper[b2]));st2=true;}else ctx.lineTo(b2x,pY(bbd.upper[b2]));}ctx.stroke();ctx.beginPath();st2=false;for(var b3=0;b3<n;b3++){if(bbd.lower[b3]===null)continue;var b3x=pad.left+b3*gap+gap/2;if(!st2){ctx.moveTo(b3x,pY(bbd.lower[b3]));st2=true;}else ctx.lineTo(b3x,pY(bbd.lower[b3]));}ctx.stroke();ctx.setLineDash([]);}
/* EMA */
if(showInd&&state.indicators.ema&&closes.length>=5){var ema20=calcEMA(closes,20);ctx.strokeStyle=’#f59e0b’;ctx.lineWidth=1.5;ctx.beginPath();for(var ei=0;ei<n;ei++){var ex=pad.left+ei*gap+gap/2;if(ei===0)ctx.moveTo(ex,pY(ema20[ei]));else ctx.lineTo(ex,pY(ema20[ei]));}ctx.stroke();}
/* Volume */
var volTop=pad.top+priceH+6;
for(var vi=0;vi<n;vi++){var vc=candles[vi];var vx=pad.left+vi*gap+gap/2;var vH=maxV>0?(vc.volume||0)/maxV*volH:0;ctx.fillStyle=vc.close>=vc.open?‘rgba(16,185,129,0.2)’:‘rgba(239,68,68,0.2)’;ctx.fillRect(vx-barW/2,volTop+volH-vH,barW,vH);}
/* Candles */
for(var ki=0;ki<n;ki++){var kc=candles[ki];var kx=pad.left+ki*gap+gap/2;var col=kc.close>=kc.open?’#10b981’:’#ef4444’;ctx.strokeStyle=col;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(kx,pY(kc.high));ctx.lineTo(kx,pY(kc.low));ctx.stroke();var tp=pY(Math.max(kc.open,kc.close));var bt=pY(Math.min(kc.open,kc.close));ctx.fillStyle=col;ctx.fillRect(kx-barW/2,tp,barW,Math.max(1,bt-tp));}
var subStart=volTop+volH+12;
/* RSI */
if(hasRSI&&closes.length>=15){var rsiData=calcRSI(closes,14);var rsiH2=H*0.16;var rsiBot=subStart+rsiH2;ctx.fillStyle=‘rgba(255,255,255,0.02)’;ctx.fillRect(pad.left,subStart-4,cW,rsiH2+8);ctx.fillStyle=’#64748b’;ctx.font=‘9px monospace’;ctx.textAlign=‘left’;ctx.fillText(‘RSI(14)’,pad.left+4,subStart+8);ctx.strokeStyle=‘rgba(255,255,255,0.08)’;ctx.lineWidth=1;ctx.setLineDash([2,2]);var y70=subStart+(1-70/100)*rsiH2;var y30=subStart+(1-30/100)*rsiH2;ctx.beginPath();ctx.moveTo(pad.left,y70);ctx.lineTo(W-pad.right,y70);ctx.stroke();ctx.beginPath();ctx.moveTo(pad.left,y30);ctx.lineTo(W-pad.right,y30);ctx.stroke();ctx.setLineDash([]);ctx.fillText(‘70’,W-pad.right+4,y70+3);ctx.fillText(‘30’,W-pad.right+4,y30+3);ctx.strokeStyle=’#06b6d4’;ctx.lineWidth=1.5;ctx.beginPath();for(var ri=0;ri<n;ri++){var rx=pad.left+ri*gap+gap/2;var rv=ri<rsiData.length?rsiData[ri]:50;var ry=subStart+(1-rv/100)*rsiH2;if(ri===0)ctx.moveTo(rx,ry);else ctx.lineTo(rx,ry);}ctx.stroke();subStart=rsiBot+16;}
/* MACD */
if(hasMACD&&closes.length>=26){var macdD=calcMACD(closes);if(macdD){var macdH=H*0.16;ctx.fillStyle=‘rgba(255,255,255,0.02)’;ctx.fillRect(pad.left,subStart-4,cW,macdH+8);ctx.fillStyle=’#64748b’;ctx.font=‘9px monospace’;ctx.textAlign=‘left’;ctx.fillText(‘MACD’,pad.left+4,subStart+8);var mHi=0;for(var mi=0;mi<n;mi++){var av=Math.abs(macdD.histogram[mi]||0);if(av>mHi)mHi=av;}if(mHi<0.01)mHi=1;for(var mj=0;mj<n;mj++){var mv=macdD.histogram[mj]||0;var mx=pad.left+mj*gap+gap/2;var mh=mv/mHi*macdH*0.4;ctx.fillStyle=mv>=0?‘rgba(16,185,129,0.4)’:‘rgba(239,68,68,0.4)’;if(mv>=0)ctx.fillRect(mx-barW/2,subStart+macdH/2-mh,barW,mh);else ctx.fillRect(mx-barW/2,subStart+macdH/2,barW,-mh);}ctx.strokeStyle=’#3b82f6’;ctx.lineWidth=1;ctx.beginPath();for(var mk=0;mk<n;mk++){var mkx=pad.left+mk*gap+gap/2;var mky=subStart+macdH/2-(macdD.macd[mk]/mHi*macdH*0.4);if(mk===0)ctx.moveTo(mkx,mky);else ctx.lineTo(mkx,mky);}ctx.stroke();ctx.strokeStyle=’#ef4444’;ctx.lineWidth=1;ctx.beginPath();for(var ml=0;ml<n;ml++){var mlx=pad.left+ml*gap+gap/2;var mly=subStart+macdH/2-(macdD.signal[ml]/mHi*macdH*0.4);if(ml===0)ctx.moveTo(mlx,mly);else ctx.lineTo(mlx,mly);}ctx.stroke();}}
/* X labels */
ctx.fillStyle=’#64748b’;ctx.font=‘9px monospace’;ctx.textAlign=‘center’;var lc=Math.min(5,n);for(var li=0;li<lc;li++){var lidx=Math.floor(li*(n-1)/(lc-1));ctx.fillText(candles[lidx].dateStr||’’,pad.left+lidx*gap+gap/2,H-4);}
/* Interactive crosshair */
if(interactive){el._candles=candles;el._pad=pad;el._gap=gap;el._pY=pY;el._H=H;el._W=W;el._priceH=priceH;
el.ontouchmove=el.onmousemove=function(ev){ev.preventDefault();var rect=el.getBoundingClientRect();var cx=(ev.touches?ev.touches[0].clientX:ev.clientX)-rect.left;var scaleX=W/rect.width;cx*=scaleX;var idx=Math.round((cx-pad.left)/gap-0.5);if(idx<0)idx=0;if(idx>=n)idx=n-1;var c=candles[idx];var tt=document.getElementById(‘chartTooltip’);if(tt&&c){tt.style.display=‘block’;tt.innerHTML=c.dateStr+’<br>O:$’+c.open.toFixed(2)+’ H:$’+c.high.toFixed(2)+’<br>L:$’+c.low.toFixed(2)+’ C:$’+c.close.toFixed(2)+’<br>Vol:’+fmtS(c.volume||0);var ttl=rect.left+cx/scaleX;if(ttl>rect.right-120)ttl=rect.right-120;tt.style.left=ttl+‘px’;tt.style.top=(rect.top-70)+‘px’;}};
el.ontouchend=el.onmouseleave=function(){var tt=document.getElementById(‘chartTooltip’);if(tt)tt.style.display=‘none’;};}
}
function drawChart(el,candles){drawChartFull(el,candles,false,false);}
function genDemoCandles(price,count){var c=[];var p=price*0.92;var now=new Date();for(var i=count;i>0;i–){var d=new Date(now);d.setDate(d.getDate()-i);if(d.getDay()===0||d.getDay()===6)continue;var o=p+(Math.random()-0.48)*p*0.025;var cc=o+(Math.random()-0.48)*o*0.035;var h=Math.max(o,cc)*(1+Math.random()*0.015);var l=Math.min(o,cc)*(1-Math.random()*0.015);c.push({dateStr:(d.getMonth()+1)+’/’+d.getDate(),time:Math.floor(d.getTime()/1000),open:+o.toFixed(2),high:+h.toFixed(2),low:+l.toFixed(2),close:+cc.toFixed(2),volume:Math.floor(Math.random()*8e6)+5e5});p=cc;}return c;}
var TF_MAP={‘1D’:{yi:‘5m’,yr:‘1d’,d:1},‘1W’:{yi:‘15m’,yr:‘5d’,d:7},‘1M’:{yi:‘1h’,yr:‘1mo’,d:30},‘3M’:{yi:‘1d’,yr:‘3mo’,d:90},‘1Y’:{yi:‘1d’,yr:‘1y’,d:365}};
function loadChartData(sym,tf){var cfg=TF_MAP[tf];return sfetch(PX+encodeURIComponent(‘https://query1.finance.yahoo.com/v8/finance/chart/’+sym+’?interval=’+cfg.yi+’&range=’+cfg.yr)).then(function(yd){if(yd&&yd.chart&&yd.chart.result&&yd.chart.result[0]){var r=yd.chart.result[0];var ts=r.timestamp;var q=r.indicators&&r.indicators.quote&&r.indicators.quote[0];if(ts&&q&&ts.length>2){var out=[];for(var i=0;i<ts.length;i++){if(!q.open[i]||!q.close[i])continue;var d=new Date(ts[i]*1000);out.push({dateStr:(d.getMonth()+1)+’/’+d.getDate(),time:ts[i],open:+q.open[i].toFixed(2),high:+q.high[i].toFixed(2),low:+q.low[i].toFixed(2),close:+q.close[i].toFixed(2),volume:q.volume?q.volume[i]||0:0});}if(out.length>2)return out;}}var stock=findStock(sym);return genDemoCandles(stock?stock.price:100,cfg.d);});}
var curSym=null,curTF=‘1M’;
function renderChart(sym,tf){var wrap=document.getElementById(‘chartWrap’);if(!wrap)return;wrap.innerHTML=’<div class="chart-loading"><span class="pull-spinner"></span> Loading…</div>’;loadChartData(sym,tf).then(function(candles){wrap.innerHTML=’<canvas id="chartCanvas"></canvas>’;wrap.className=state.indicators.rsi||state.indicators.macd?‘chart-wrap-tall’:‘chart-wrap’;requestAnimationFrame(function(){drawChartFull(document.getElementById(‘chartCanvas’),candles,true,true);});});}
function renderAChart(sym,cid){loadChartData(sym,‘1M’).then(function(c){var el=document.getElementById(cid);if(el)requestAnimationFrame(function(){drawChartFull(el,c,true,false);});});}
/* Heatmap */
function drawHeatmap(cid){var el=document.getElementById(cid);if(!el)return;var wrap=el.parentElement;var W=wrap.clientWidth||300;var H=400;var dpr=window.devicePixelRatio||1;el.width=W*dpr;el.height=H*dpr;el.style.width=W+‘px’;el.style.height=H+‘px’;var ctx=el.getContext(‘2d’);ctx.scale(dpr,dpr);var stocks=state.stocks.slice().sort(function(a,b){return(b.marketCap||0)-(a.marketCap||0);});var tmc=0;stocks.forEach(function(s){tmc+=(s.marketCap||1);});var x=0,y=0,rw=W,rh=H;stocks.forEach(function(s,idx){var rat=(s.marketCap||1)/tmc;var area=rw*rh*rat;var bw,bh;if(rw>rh){bw=area/rh;bh=rh;if(bw>rw)bw=rw;}else{bh=area/rw;bw=rw;if(bh>rh)bh=rh;}if(idx===stocks.length-1){bw=rw;bh=rh;}var cp=s.changePercent||0;var int2=Math.min(Math.abs(cp)/5,1);var r2,g2,b2;if(cp>=0){r2=Math.floor(16+(1-int2)*20);g2=Math.floor(185*int2+40);b2=Math.floor(129*int2+20);}else{r2=Math.floor(239*int2+40);g2=Math.floor(68*(1-int2)+20);b2=Math.floor(68*(1-int2)+20);}ctx.fillStyle=‘rgb(’+r2+’,’+g2+’,’+b2+’)’;ctx.fillRect(x+1,y+1,bw-2,bh-2);ctx.strokeStyle=’#0f1419’;ctx.lineWidth=2;ctx.strokeRect(x,y,bw,bh);if(bw>40&&bh>30){ctx.fillStyle=’#fff’;ctx.font=‘bold ‘+Math.min(14,Math.max(9,bw/5))+‘px monospace’;ctx.textAlign=‘center’;ctx.textBaseline=‘middle’;ctx.fillText(s.symbol,x+bw/2,y+bh/2-7);ctx.font=Math.min(11,Math.max(8,bw/7))+‘px monospace’;ctx.fillText((cp>=0?’+’:’’)+cp.toFixed(1)+’%’,x+bw/2,y+bh/2+9);}if(rw>rh){x+=bw;rw-=bw;}else{y+=bh;rh-=bh;}if(rw<1)rw=1;if(rh<1)rh=1;});}
/* Peer Compare */
function renderPeerCompare(){var s1=document.getElementById(‘peerSel1’);var s2=document.getElementById(‘peerSel2’);var s3=document.getElementById(‘peerSel3’);if(!s1)return;var syms=[s1.value,s2.value];if(s3.value)syms.push(s3.value);var peers=[];syms.forEach(function(sym){var s=findStock(sym);if(s)peers.push(s);});if(peers.length<2)return;var h=’<table class="peer-table"><thead><tr><th>Metric</th>’;peers.forEach(function(p){h+=’<th>’+p.symbol+’</th>’;});h+=’</tr></thead><tbody>’;[‘Price’,‘Change’,‘P/E’,‘Mkt Cap’,‘Volume’,‘Score’].forEach(function(m){h+=’<tr><td style="color:#64748b;font-size:12px">’+m+’</td>’;peers.forEach(function(p){var v=’’,c=’’;if(m===‘Price’)v=’$’+p.price.toFixed(2);else if(m===‘Change’){v=(p.changePercent>=0?’+’:’’)+p.changePercent.toFixed(2)+’%’;c=p.changePercent>=0?‘positive’:‘negative’;}else if(m===‘P/E’)v=(p.pe||‘N/A’)+‘x’;else if(m===‘Mkt Cap’)v=fmtN(p.marketCap);else if(m===‘Volume’)v=fmtN(p.volume);else if(m===‘Score’)v=p.score+’/100’;h+=’<td class="'+c+'">’+v+’</td>’;});h+=’</tr>’;});h+=’</tbody></table>’;document.getElementById(‘peerContent’).innerHTML=h;}
/* Score History */
function drawScoreChart(cid,sym){var el=document.getElementById(cid);if(!el)return;var wrap=el.parentElement;var W=wrap.clientWidth||300;var H=200;var dpr=window.devicePixelRatio||1;el.width=W*dpr;el.height=H*dpr;el.style.width=W+‘px’;el.style.height=H+‘px’;var ctx=el.getContext(‘2d’);ctx.scale(dpr,dpr);var hist=getScoreHistory();var dates=Object.keys(hist).sort();if(dates.length<2){ctx.fillStyle=’#64748b’;ctx.font=‘14px Inter,sans-serif’;ctx.textAlign=‘center’;ctx.fillText(‘Score history builds over time’,W/2,H/2);return;}var pts=[];dates.forEach(function(d){if(hist[d][sym]!==undefined)pts.push({d:d.substring(5),s:hist[d][sym]});});if(pts.length<2){ctx.fillStyle=’#64748b’;ctx.font=‘14px sans-serif’;ctx.textAlign=‘center’;ctx.fillText(’Not enough data for ’+sym,W/2,H/2);return;}var p2={top:20,right:16,bottom:30,left:40};var cW2=W-p2.left-p2.right;var cH2=H-p2.top-p2.bottom;ctx.strokeStyle=‘rgba(255,255,255,0.05)’;ctx.lineWidth=1;for(var g=0;g<=4;g++){var gy2=p2.top+cH2*g/4;ctx.beginPath();ctx.moveTo(p2.left,gy2);ctx.lineTo(W-p2.right,gy2);ctx.stroke();ctx.fillStyle=’#64748b’;ctx.font=‘10px monospace’;ctx.textAlign=‘right’;ctx.fillText(Math.round(100-g*25),p2.left-6,gy2+4);}ctx.beginPath();ctx.strokeStyle=’#3b82f6’;ctx.lineWidth=2;pts.forEach(function(p,i){var x=p2.left+i*cW2/(pts.length-1);var y=p2.top+(1-p.s/100)*cH2;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();}
/* Correlation Matrix */
function drawCorrelation(cid){var el=document.getElementById(cid);if(!el)return;var syms=state.stocks.slice(0,8);var n=syms.length;var sz=Math.min(40,Math.floor((el.parentElement.clientWidth-20)/n));var W2=(n+1)*sz;var H2=(n+1)*sz;var dpr=window.devicePixelRatio||1;el.width=W2*dpr;el.height=H2*dpr;el.style.width=W2+‘px’;el.style.height=H2+‘px’;var ctx=el.getContext(‘2d’);ctx.scale(dpr,dpr);ctx.fillStyle=’#64748b’;ctx.font=‘9px monospace’;ctx.textAlign=‘center’;for(var i=0;i<n;i++){ctx.fillText(syms[i].symbol,sz*(i+1)+sz/2,sz/2+4);ctx.save();ctx.translate(sz/2+4,sz*(i+1)+sz/2);ctx.fillText(syms[i].symbol,0,0);ctx.restore();}for(var r=0;r<n;r++){for(var c2=0;c2<n;c2++){var corr=r===c2?1:((syms[r].changePercent*syms[c2].changePercent>0?0.3:-0.3)+Math.random()*0.4).toFixed(2);var v=parseFloat(corr);var x2=sz*(c2+1);var y2=sz*(r+1);if(v>0){ctx.fillStyle=‘rgba(16,185,129,’+Math.abs(v)+’)’;}else{ctx.fillStyle=‘rgba(239,68,68,’+Math.abs(v)+’)’;}ctx.fillRect(x2+1,y2+1,sz-2,sz-2);ctx.fillStyle=’#fff’;ctx.font=‘bold 9px monospace’;ctx.fillText(v.toFixed(1),x2+sz/2,y2+sz/2+3);}}}
/* Pie Chart */
function drawPie(cid){var el=document.getElementById(cid);if(!el)return;var W=260;var H=260;var dpr=window.devicePixelRatio||1;el.width=W*dpr;el.height=H*dpr;el.style.width=W+‘px’;el.style.height=H+‘px’;var ctx=el.getContext(‘2d’);ctx.scale(dpr,dpr);var total=0;state.stocks.forEach(function(s){total+=s.price;});var colors=[’#3b82f6’,’#10b981’,’#f59e0b’,’#ef4444’,’#8b5cf6’,’#ec4899’,’#06b6d4’,’#84cc16’,’#f97316’,’#6366f1’,’#14b8a6’,’#e11d48’,’#a855f7’,’#eab308’,’#0ea5e9’];var angle=0;var cx=W/2;var cy=H/2;var R=100;state.stocks.forEach(function(s,i){var slice=s.price/total*Math.PI*2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,R,angle,angle+slice);ctx.closePath();ctx.fillStyle=colors[i%colors.length];ctx.fill();ctx.strokeStyle=’#0f1419’;ctx.lineWidth=2;ctx.stroke();angle+=slice;});var lh=’’;angle=0;state.stocks.forEach(function(s,i){var pct=(s.price/total*100).toFixed(1);lh+=’<div class="pie-legend-item"><span class="pie-legend-dot" style="background-color:'+colors[i%colors.length]+'"></span>’+s.symbol+’ ‘+pct+’%</div>’;});var lg=document.getElementById(‘pieLegend’);if(lg)lg.innerHTML=lh;}
/* Portfolio Performance */
function drawPerfChart(cid){var el=document.getElementById(cid);if(!el)return;var wrap=el.parentElement;var W=wrap.clientWidth||300;var H=240;var dpr=window.devicePixelRatio||1;el.width=W*dpr;el.height=H*dpr;el.style.width=W+‘px’;el.style.height=H+‘px’;var ctx=el.getContext(‘2d’);ctx.scale(dpr,dpr);var hist=getPerfHistory();var dates=Object.keys(hist).sort();if(dates.length<2){ctx.fillStyle=’#64748b’;ctx.font=‘14px sans-serif’;ctx.textAlign=‘center’;ctx.fillText(‘Performance tracking starts after first refresh’,W/2,H/2);return;}var vals=dates.map(function(d){return hist[d];});var hi2=Math.max.apply(null,vals);var lo2=Math.min.apply(null,vals);var rng=hi2-lo2||1;var p2={top:20,right:16,bottom:30,left:50};var cW2=W-p2.left-p2.right;var cH2=H-p2.top-p2.bottom;ctx.strokeStyle=‘rgba(255,255,255,0.05)’;for(var g=0;g<5;g++){var gy=p2.top+cH2*g/4;ctx.beginPath();ctx.moveTo(p2.left,gy);ctx.lineTo(W-p2.right,gy);ctx.stroke();ctx.fillStyle=’#64748b’;ctx.font=‘10px monospace’;ctx.textAlign=‘right’;ctx.fillText(’$’+(hi2-rng*g/4).toFixed(0),p2.left-6,gy+4);}ctx.beginPath();ctx.strokeStyle=’#3b82f6’;ctx.lineWidth=2;vals.forEach(function(v,i){var x=p2.left+i*cW2/(vals.length-1);var y=p2.top+(1-(v-lo2)/rng)*cH2;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();/* Fill */ctx.lineTo(p2.left+cW2,p2.top+cH2);ctx.lineTo(p2.left,p2.top+cH2);ctx.closePath();ctx.fillStyle=‘rgba(59,130,246,0.08)’;ctx.fill();}
function toggleIndicator(ind){state.indicators[ind]=!state.indicators[ind];var btns=document.querySelectorAll(’.ind-toggle’);for(var i=0;i<btns.length;i++){var k=btns[i].getAttribute(‘data-ind’);if(k)btns[i].className=state.indicators[k]?‘ind-toggle active’:‘ind-toggle’;}if(curSym)renderChart(curSym,curTF);}
/* ═══════════════════════════════════════════
UI: Home Screen with Trending + Signals
═══════════════════════════════════════════ */
function animateCount(el,end,pre,suf,dur){if(!el)return;var start=parseFloat(el.getAttribute(‘data-v’)||‘0’);el.setAttribute(‘data-v’,end);if(Math.abs(start-end)<0.005){el.textContent=pre+end.toFixed(2)+suf;return;}var t0=performance.now();dur=dur||600;function tick(now){var p=Math.min((now-t0)/dur,1);var e=1-Math.pow(1-p,3);el.textContent=pre+(start+(end-start)*e).toFixed(2)+suf;if(p<1)requestAnimationFrame(tick);}requestAnimationFrame(tick);}
function fmtN(n){if(n>=1e12)return ‘$’+(n/1e12).toFixed(1)+‘T’;if(n>=1e9)return ‘$’+(n/1e9).toFixed(1)+‘B’;if(n>=1e6)return(n/1e6).toFixed(1)+‘M’;if(n>=1e3)return(n/1e3).toFixed(1)+‘K’;return n.toString();}
function fmtS(n){if(n>=1e9)return(n/1e9).toFixed(1)+‘B’;if(n>=1e6)return(n/1e6).toFixed(1)+‘M’;if(n>=1e3)return(n/1e3).toFixed(1)+‘K’;return typeof n===‘number’?n.toLocaleString():String(n);}
function showToast(m){var t=document.getElementById(‘toast’);t.textContent=m;t.classList.add(‘show’);setTimeout(function(){t.classList.remove(‘show’);},2500);}
function genAnalysis(s){var p=s.price,cp=s.changePercent,hi=s.high||p*1.02,lo=s.low||p*0.98;var rsi=Math.max(10,Math.min(90,50-(cp*8)+(Math.random()-0.5)*10));var macd=cp*1.2+(Math.random()-0.5)*0.5;var ms=macd>0?‘Bullish’:‘Bearish’;var tr,ts;if(cp>2){tr=‘Strong Uptrend’;ts=85;}else if(cp>0.5){tr=‘Uptrend’;ts=65;}else if(cp>-0.5){tr=‘Sideways’;ts=45;}else if(cp>-2){tr=‘Downtrend’;ts=30;}else{tr=‘Strong Downtrend’;ts=15;}var sup=(lo*0.98).toFixed(2),res=(hi*1.02).toFixed(2);var sig=computeSignal(s);var vol=Math.abs(cp)+Math.abs(hi-lo)/p*100;var rl,rs,rc;if(vol>4){rl=‘High’;rs=80;rc=’#ef4444’;}else if(vol>2){rl=‘Medium’;rs=50;rc=’#f59e0b’;}else{rl=‘Low’;rs=25;rc=’#10b981’;}var sl=(parseFloat(sup)*0.97).toFixed(2),rr=((parseFloat(res)-parseFloat(sup))/Math.max(0.01,parseFloat(sup)-parseFloat(sl))).toFixed(1);return{rsi:rsi,ms:ms,tr:tr,ts:ts,sup:sup,res:res,sig:sig.signal,sc:sig.cls,rl:rl,rs:rs,rc:rc,vol:vol,sl:sl,rr:rr,shortTerm:cp>=0?‘Bullish (+’+cp.toFixed(2)+’%)’:‘Cautious (’+cp.toFixed(2)+’%)’,longTerm:ts>50?‘Favorable (’+tr+’)’:‘Challenged (’+tr.toLowerCase()+’)’};}
function renderAnalysisCard(s,chartId){var a=genAnalysis(s);var ch=chartId?’<div class="section-card"><div class="section-label">Price Chart — ‘+s.symbol+’</div><div class="chart-legend"><span class="chart-legend-item"><span class="chart-legend-dot" style="background-color:#f59e0b"></span>EMA</span><span class="chart-legend-item"><span class="chart-legend-dot" style="background-color:#8b5cf6"></span>BB</span><span class="chart-legend-item"><span class="chart-legend-dot" style="background-color:#06b6d4"></span>RSI</span><span class="chart-legend-item"><span class="chart-legend-dot" style="background-color:#3b82f6"></span>MACD</span></div><div class="analysis-chart-wrap"><canvas id="'+chartId+'"></canvas></div></div>’:’’;return ch+’<div class="section-card"><div class="section-label">Signal</div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span class="signal-badge '+a.sc+'">’+a.sig+’</span><span style="font-family:monospace;font-size:13px;color:#64748b">Score: ‘+s.score+’/100</span></div><p class="analysis-text">’+s.symbol+’ $’+s.price.toFixed(2)+’ (’+(s.changePercent>=0?’+’:’’)+s.changePercent.toFixed(2)+’%). RSI ‘+a.rsi.toFixed(1)+’. MACD ‘+a.ms+’. <strong>’+a.sig+’</strong></p></div><div class="section-card"><div class="section-label">Technicals</div><div class="metric-grid"><div><div class="metric-label">RSI</div><div class="metric-value" style="color:'+(a.rsi<30?'#10b981':a.rsi>70?'#ef4444':'#fff')+'">’+a.rsi.toFixed(1)+’</div></div><div><div class="metric-label">MACD</div><div class="metric-value '+(a.ms==='Bullish'?'positive':'negative')+'">’+a.ms+’</div></div><div><div class="metric-label">Support</div><div class="metric-value action-entry">$’+a.sup+’</div></div><div><div class="metric-label">Resistance</div><div class="metric-value action-target">$’+a.res+’</div></div></div></div><div class="section-card"><div class="section-label">Fundamentals</div><div class="metric-grid mb-md"><div><div class="metric-label">Mkt Cap</div><div class="metric-value" style="font-size:15px">’+fmtN(s.marketCap)+’</div></div><div><div class="metric-label">P/E</div><div class="metric-value">’+(s.pe||‘N/A’)+‘x</div></div><div><div class="metric-label">Volume</div><div class="metric-value" style="font-size:15px">’+fmtN(s.volume)+’</div></div><div><div class="metric-label">Prev</div><div class="metric-value" style="font-size:15px">$’+(s.prevClose||0).toFixed(2)+’</div></div></div></div><div class="section-card"><div class="section-label">Risk</div><div style="display:flex;justify-content:space-between"><span style="font-size:18px;font-weight:700;color:#fff">’+a.rl+’</span><span style="font-family:monospace;font-size:14px;color:#64748b">Vol ‘+a.vol.toFixed(1)+’%</span></div><div class="risk-bar-track"><div class="risk-bar-fill" style="width:'+a.rs+'%;background-color:'+a.rc+'"></div></div></div><div class="section-card"><div class="section-label">Levels</div><div class="action-grid"><div><div class="action-label">Entry</div><div class="action-value action-entry">$’+a.sup+’</div></div><div><div class="action-label">Target</div><div class="action-value action-target">$’+a.res+’</div></div><div><div class="action-label">Stop</div><div class="action-value action-stop">$’+a.sl+’</div></div></div><p class="analysis-text mt-md text-center">R/R: ‘+a.rr+’:1</p></div>’;}

function renderStockCard(s,showTag){
var sp=s.changePercent>=0;var sig=computeSignal(s);
var tagHtml=’’;if(showTag&&s.tag){if(s.tag===‘gainer’)tagHtml=’<span class="trending-badge trending-gainer">▲ GAINER</span>’;else if(s.tag===‘loser’)tagHtml=’<span class="trending-badge trending-loser">▼ LOSER</span>’;else if(s.tag===‘active’)tagHtml=’<span class="trending-badge trending-active">★ ACTIVE</span>’;}
return ‘<div class="stock-card-wrap" id="scw_'+s.symbol+'" data-sym="'+s.symbol+'"><div class="stock-card-delete" onclick="deleteStock(\''+s.symbol+'\')">DELETE</div><div class="stock-card" id="sc_'+s.symbol+'" onclick="openDetail(\''+s.symbol+'\')"><div class="stock-header"><div><div class="stock-symbol">’+s.symbol+tagHtml+’</div><div class="stock-name">’+s.name+’</div></div><div><div class="stock-score">’+s.score+’</div><div style="text-align:right"><span class="signal-badge '+sig.cls+'" style="font-size:9px;padding:3px 8px">’+sig.signal+’</span></div></div></div><div class="stock-divider"></div><div class="stock-price-row"><div class="stock-price" id="price_'+s.symbol+'">$’+(s.price||0).toFixed(2)+’</div><div class="stock-change '+(sp?'positive':'negative')+'">’+(sp?’+’:’’)+(s.changePercent||0).toFixed(2)+’%</div></div></div></div>’;
}

function renderStocks(){
/* Filter by signal */
var allStocks=state.stocks.slice();
var filtered=state.signalFilter===‘all’?allStocks:allStocks.filter(function(s){return computeSignal(s).key===state.signalFilter;});
var tv=0,tc=0;for(var i=0;i<state.stocks.length;i++){tv+=state.stocks[i].price;tc+=state.stocks[i].change;}
var tp=tv?tc/tv*100:0;var ip=tc>=0;
var upd=state.lastUpdated?‘Updated ‘+state.lastUpdated.toLocaleTimeString([],{hour:‘2-digit’,minute:‘2-digit’}):’’;
var ws2=state.wsConnected?’<span class="live-dot"></span>LIVE’:’’;
var h=’<div class="portfolio-card"><div style="display:flex;justify-content:space-between;align-items:center"><div class="portfolio-label">Portfolio Value</div><div style="font-size:11px;color:#64748b;font-family:monospace">’+upd+’ ‘+ws2+’</div></div><div class="portfolio-value" id="pVal" data-v="0">$’+tv.toFixed(2)+’</div><div class="portfolio-change '+(ip?'positive':'negative')+'">$’+(ip?’+’:’’)+tc.toFixed(2)+’ (’+(ip?’+’:’’)+tp.toFixed(2)+’%)</div></div>’;
/* Your watchlist stocks */
h+=’<div class="source-label">YOUR WATCHLIST</div><div class="stock-list">’;
for(var j=0;j<filtered.length;j++)h+=renderStockCard(filtered[j],false);
if(!filtered.length)h+=’<div style="text-align:center;padding:24px;color:#64748b">No stocks match this signal filter</div>’;
h+=’</div>’;
/* Trending stocks from market scanner */
if(state.trendingStocks.length>0){
var tFiltered=state.signalFilter===‘all’?state.trendingStocks:state.trendingStocks.filter(function(s){return computeSignal(s).key===state.signalFilter;});
if(tFiltered.length>0){
h+=’<div class="source-label">TRENDING — TOP MOVERS</div><div class="stock-list">’;
for(var k=0;k<tFiltered.length;k++)h+=renderStockCard(tFiltered[k],true);
h+=’</div>’;
}
}
document.getElementById(‘stockListContainer’).innerHTML=h;
requestAnimationFrame(function(){animateCount(document.getElementById(‘pVal’),tv,’$’,’’,700);});
setupSwipe();setupDrag();
}
/* Swipe */
var swS={el:null,sx:0,dx:0};function setupSwipe(){var cards=document.querySelectorAll(’.stock-card’);for(var i=0;i<cards.length;i++){cards[i].addEventListener(‘touchstart’,swS1,{passive:true});cards[i].addEventListener(‘touchmove’,swS2,{passive:false});cards[i].addEventListener(‘touchend’,swS3,{passive:true});}}
function closeAllSwipes(){var s=document.querySelectorAll(’.stock-card.swiped’);for(var i=0;i<s.length;i++)s[i].classList.remove(‘swiped’);}
function swS1(e){closeAllSwipes();swS.el=this;swS.sx=e.touches[0].clientX;swS.dx=0;}
function swS2(e){if(!swS.el)return;swS.dx=e.touches[0].clientX-swS.sx;if(Math.abs(swS.dx)>10&&swS.dx<0)e.preventDefault();}
function swS3(){if(!swS.el)return;if(swS.dx<-60)swS.el.classList.add(‘swiped’);swS.el=null;}
function deleteStock(sym){watchlists[activeWatchlist]=watchlists[activeWatchlist].filter(function(s){return s.symbol!==sym;});state.stocks=state.stocks.filter(function(s){return s.symbol!==sym;});saveWL();renderStocks();showToast(sym+’ removed’);}
/* Drag */
var dragState={el:null,idx:-1,sy:0,active:false};
function setupDrag(){var wraps=document.querySelectorAll(’.stock-card-wrap’);for(var i=0;i<wraps.length;i++)wraps[i].addEventListener(‘touchstart’,dragStart,{passive:true});}
function dragStart(e){if(e.target.classList.contains(‘stock-card-delete’))return;dragState.el=this;dragState.sy=e.touches[0].clientY;this._lp=setTimeout(function(){dragState.el.querySelector(’.stock-card’).classList.add(‘dragging’);if(navigator.vibrate)navigator.vibrate(30);dragState.active=true;document.addEventListener(‘touchmove’,dragMove,{passive:false});document.addEventListener(‘touchend’,dragEnd,{passive:true});},500);}
function dragMove(e){if(!dragState.active)return;e.preventDefault();dragState.el.style.transform=‘translateY(’+(e.touches[0].clientY-dragState.sy)+‘px)’;dragState.el.style.zIndex=‘50’;}
function dragEnd(){clearTimeout(dragState.el._lp);if(!dragState.active){dragState.el=null;return;}document.removeEventListener(‘touchmove’,dragMove);document.removeEventListener(‘touchend’,dragEnd);dragState.el.querySelector(’.stock-card’).classList.remove(‘dragging’);dragState.el.style.transform=’’;dragState.el.style.zIndex=’’;dragState.active=false;dragState.el=null;}
/* Watchlist */
function renderWLS(){var sel=document.getElementById(‘watchlistSelect’);sel.innerHTML=Object.keys(watchlists).map(function(n){return ‘<option value=”’+n+’”’+(n===activeWatchlist?’ selected’:’’)+’>’+n+’ (’+watchlists[n].length+’)</option>’;}).join(’’);}
function switchWatchlist(){activeWatchlist=document.getElementById(‘watchlistSelect’).value;saveWL();loadDemoData();renderStocks();loadRealData().then(function(){renderStocks();});}
function openWatchlistModal(m){var modal=document.getElementById(‘watchlistModal’);var t=document.getElementById(‘wlModalTitle’);var inp=document.getElementById(‘wlNameInput’);var b=document.getElementById(‘wlModalBtns’);modal.classList.add(‘active’);if(m===‘new’){t.textContent=‘New Watchlist’;inp.value=’’;b.innerHTML=’<button class="wl-btn-cancel" onclick="closeWM()">Cancel</button><button class="wl-btn-save" onclick="createWL()">Create</button>’;}else{t.textContent=‘Edit: ‘+activeWatchlist;inp.value=activeWatchlist;var d=activeWatchlist!==‘Portfolio’?’<button class="wl-btn-delete" onclick="deleteWL()">Delete</button>’:’’;b.innerHTML=’<button class="wl-btn-cancel" onclick="closeWM()">Cancel</button>’+d+’<button class="wl-btn-save" onclick="renameWL()">Save</button>’;}}
function closeWM(){document.getElementById(‘watchlistModal’).classList.remove(‘active’);}
function createWL(){var n=document.getElementById(‘wlNameInput’).value.trim();if(!n||watchlists[n])return;watchlists[n]=[];activeWatchlist=n;saveWL();renderWLS();closeWM();loadDemoData();renderStocks();showToast(n+’ created’);}
function renameWL(){var n=document.getElementById(‘wlNameInput’).value.trim();if(!n||n===activeWatchlist){closeWM();return;}watchlists[n]=watchlists[activeWatchlist];delete watchlists[activeWatchlist];activeWatchlist=n;saveWL();renderWLS();closeWM();showToast(‘Renamed’);}
function deleteWL(){if(activeWatchlist===‘Portfolio’)return;delete watchlists[activeWatchlist];activeWatchlist=‘Portfolio’;saveWL();renderWLS();closeWM();loadDemoData();renderStocks();showToast(‘Deleted’);}
/* Search */
var sTimer=null;var sIn=document.getElementById(‘searchInput’);var sRes=document.getElementById(‘searchResults’);
sIn.addEventListener(‘input’,function(){clearTimeout(sTimer);var q=this.value.trim();if(q.length<1){sRes.classList.remove(‘show’);return;}if(q.length<2){showSR([]);return;}sTimer=setTimeout(function(){sfetch(FMP+’/search?query=’+encodeURIComponent(q)+’&limit=10&apikey=’+FK).then(function(d){if(d&&Array.isArray(d)&&d.length>0){showSR(d.filter(function(r){return r.symbol&&r.symbol.indexOf(’.’)<0;}).slice(0,10).map(function(r){return{symbol:r.symbol,description:r.name||r.symbol};}));return;}showSR([]);});},300);});
sIn.addEventListener(‘blur’,function(){setTimeout(function(){sRes.classList.remove(‘show’);},200);});
function showSR(r){if(!r.length){sRes.innerHTML=’<div style="padding:16px;text-align:center;color:#64748b;font-size:13px">Type to search any ticker</div>’;sRes.classList.add(‘show’);return;}var ex={};for(var i=0;i<state.stocks.length;i++)ex[state.stocks[i].symbol]=true;sRes.innerHTML=r.map(function(r){var il=ex[r.symbol];var sn=(r.description||r.symbol).replace(/’/g,”\’”).replace(/”/g,’’);return ‘<div class=“search-result-item” onclick=”’+(il?“openDetail(’”+r.symbol+”’);sRes.classList.remove(‘show’);sIn.value=’’;”:“addStock(’”+r.symbol+”’,’”+sn+”’)”)+’”><div><div class="search-result-sym">’+r.symbol+’</div><div class="search-result-name">’+(r.description||’’)+’</div></div><div class="search-result-add">’+(il?‘View’:’+ Add’)+’</div></div>’;}).join(’’);sRes.classList.add(‘show’);}
function addStock(sym,name){if(state.stocks.some(function(s){return s.symbol===sym;}))return;sIn.value=’’;sRes.classList.remove(‘show’);showToast(‘Adding ‘+sym+’…’);var obj={symbol:sym,name:name||sym,sector:‘tech’,price:0,change:0,changePercent:0,high:0,low:0,open:0,prevClose:0,volume:0,marketCap:0,pe:0,score:50};state.stocks.push(obj);watchlists[activeWatchlist].push({symbol:sym,name:name||sym,sector:‘tech’});saveWL();Promise.all([fetchQ(sym),fetchProfile(sym)]).then(function(res){var d=res[0];var prof=res[1];for(var j=0;j<state.stocks.length;j++){if(state.stocks[j].symbol===sym){if(d&&d.c>0){state.stocks[j].price=d.c;state.stocks[j].change=d.d||0;state.stocks[j].changePercent=d.dp||0;state.stocks[j].high=d.h||d.c;state.stocks[j].low=d.l||d.c;state.stocks[j].open=d.o||d.c;state.stocks[j].prevClose=d.pc||d.c;if(d.marketCap)state.stocks[j].marketCap=d.marketCap;if(d.pe)state.stocks[j].pe=d.pe;state.stocks[j].score=scoreStock(d,sym);setCQ(sym,d);}if(prof){state.stocks[j].name=prof.name;state.stocks[j].sector=prof.sector;var wl=watchlists[activeWatchlist];for(var w=0;w<wl.length;w++){if(wl[w].symbol===sym){wl[w].name=prof.name;wl[w].sector=prof.sector;break;}}saveWL();}break;}}renderStocks();renderWLS();showToast(sym+’ added’);});}
/* ═══════════════════════════════════════════
Views: Detail, Analysis Tabs, News, Paper Trade, Settings
═══════════════════════════════════════════ */

/* Detail Modal */
function openDetail(sym){var s=findStock(sym);if(!s)return;curSym=sym;curTF=‘1M’;document.getElementById(‘detailSymbol’).textContent=sym;document.getElementById(‘detailName’).textContent=s.name;var ip=s.changePercent>=0;
document.getElementById(‘detailContent’).innerHTML=’<div class="detail-price-block"><div class="detail-price" id="dPrice" data-v="0">$’+s.price.toFixed(2)+’</div><div class="detail-change-row"><div class="detail-change-val '+(ip?'positive':'negative')+'">’+(ip?’+’:’’)+’$’+s.change.toFixed(2)+’</div><div class="detail-change-val '+(ip?'positive':'negative')+'">’+’(’+(ip?’+’:’’)+s.changePercent.toFixed(2)+’%)</div></div></div>’
+’<div class="chart-card"><div class="section-label">Price Chart</div><div class="chart-legend"><span class="chart-legend-item"><span class="chart-legend-dot" style="background-color:#f59e0b"></span>EMA</span><span class="chart-legend-item"><span class="chart-legend-dot" style="background-color:#8b5cf6"></span>BB</span><span class="chart-legend-item"><span class="chart-legend-dot" style="background-color:#06b6d4"></span>RSI</span><span class="chart-legend-item"><span class="chart-legend-dot" style="background-color:#3b82f6"></span>MACD</span></div><div class="indicator-toggles"><button class="ind-toggle'+(state.indicators.ema?' active':'')+'" data-ind="ema" onclick="toggleIndicator(\'ema\')">EMA</button><button class="ind-toggle'+(state.indicators.bb?' active':'')+'" data-ind="bb" onclick="toggleIndicator(\'bb\')">BB</button><button class="ind-toggle'+(state.indicators.rsi?' active':'')+'" data-ind="rsi" onclick="toggleIndicator(\'rsi\')">RSI</button><button class="ind-toggle'+(state.indicators.macd?' active':'')+'" data-ind="macd" onclick="toggleIndicator(\'macd\')">MACD</button></div><div class="chart-timeframes" id="chartTFRow"><button class="tf-btn" onclick="switchTF(\'1D\')">1D</button><button class="tf-btn" onclick="switchTF(\'1W\')">1W</button><button class="tf-btn active" onclick="switchTF(\'1M\')">1M</button><button class="tf-btn" onclick="switchTF(\'3M\')">3M</button><button class="tf-btn" onclick="switchTF(\'1Y\')">1Y</button></div><div class="chart-wrap-tall" id="chartWrap"><div class="chart-loading"><span class="pull-spinner"></span></div></div></div>’
+renderAnalysisCard(s,null)
+’<div class="section-card"><div class="section-label">Position Sizer</div><div class="sizer-row"><span class="sizer-label">Account $</span><input class="trade-input" id="sizerAcct" type="number" value="10000" onchange="calcPosition(\''+sym+'\')"></div><div class="sizer-row"><span class="sizer-label">Risk %</span><input class="trade-input" id="sizerRisk" type="number" value="2" onchange="calcPosition(\''+sym+'\')"></div><div class="sizer-result" id="sizerResult"><div class="sizer-big">0</div><div style="color:#64748b;font-size:12px;margin-top:4px">shares</div></div></div>’
+’<div class="section-card" id="dEarnings"><div class="skeleton-block"></div></div>’
+’<div class="section-card" id="dAnalyst"><div class="skeleton-block"></div></div>’
+’<div class="section-card" id="dDividend"><div class="skeleton-block"></div></div>’
+’<div class="section-card" id="dNews"><div class="skeleton-block"></div></div>’;
document.getElementById(‘detailModal’).classList.add(‘active’);document.getElementById(‘detailModal’).scrollTop=0;
requestAnimationFrame(function(){animateCount(document.getElementById(‘dPrice’),s.price,’$’,’’,800);});
setTimeout(function(){renderChart(sym,curTF);calcPosition(sym);},350);
/* Earnings */
Promise.all([fetchEarnings(sym),fetchEarningsCalendar(sym)]).then(function(r){var ear=r[0];var cal=r[1];var el=document.getElementById(‘dEarnings’);if(!el)return;var h=’<div class="section-label">Earnings</div>’;if(cal&&cal.date)h+=’<div class="earnings-next">Next: ‘+cal.date+’</div>’;h+=’<table class="earnings-table"><thead><tr><th>Qtr</th><th>EPS</th><th>Est</th><th>Rev</th></tr></thead><tbody>’;if(ear&&ear.quarters){ear.quarters.slice(0,4).forEach(function(q){var b=q.eps>=q.epsEstimated;h+=’<tr><td>’+q.date+’</td><td class="'+(b?'beat':'miss')+'">$’+q.eps.toFixed(2)+’</td><td>$’+(q.epsEstimated||0).toFixed(2)+’</td><td>’+fmtN(q.revenue)+’</td></tr>’;});}h+=’</tbody></table>’;
/* Earnings Surprise Predictor */
if(ear&&ear.quarters&&ear.quarters.length>=3){var beats=0;ear.quarters.forEach(function(q){if(q.eps>=q.epsEstimated)beats++;});var pct=Math.round(beats/ear.quarters.length*100);h+=’<div style="margin-top:16px;padding:16px;background:#1a1f2e;border-radius:12px"><div class="metric-label">Earnings Surprise Predictor</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px"><span style="font-size:24px;font-weight:700;color:'+(pct>=60?'#10b981':'#f59e0b')+'">’+pct+’%</span><span style="font-size:13px;color:#94a3b8">chance of beating estimates</span></div><div class="risk-bar-track" style="margin-top:8px"><div class="risk-bar-fill" style="width:'+pct+'%;background-color:'+(pct>=60?'#10b981':'#f59e0b')+'"></div></div><div style="font-size:11px;color:#64748b;margin-top:6px">Based on ‘+ear.quarters.length+’ quarters: ‘+beats+’ beats, ‘+(ear.quarters.length-beats)+’ misses</div></div>’;}
el.innerHTML=h;});
/* Analyst */
Promise.all([fetchAnalystRatings(sym),fetchPriceTarget(sym)]).then(function(r){var rat=r[0];var pt=r[1];var el=document.getElementById(‘dAnalyst’);if(!el)return;var total=rat.buy+rat.hold+rat.sell||1;var h=’<div class="section-label">Analyst Ratings</div><div class="analyst-bar-wrap"><div class="analyst-bar"><div class="analyst-bar-seg analyst-bar-buy" style="width:'+((rat.buy/total)*100)+'%">’+rat.buy+’</div><div class="analyst-bar-seg analyst-bar-hold" style="width:'+((rat.hold/total)*100)+'%">’+rat.hold+’</div><div class="analyst-bar-seg analyst-bar-sell" style="width:'+((rat.sell/total)*100)+'%">’+rat.sell+’</div></div><div class="analyst-labels"><span>Buy</span><span>Hold</span><span>Sell</span></div></div>’;if(pt)h+=’<div class="metric-grid"><div><div class="metric-label">Low</div><div class="metric-value action-stop">$’+pt.low.toFixed(2)+’</div></div><div><div class="metric-label">Consensus</div><div class="metric-value action-entry">$’+pt.avg.toFixed(2)+’</div></div><div><div class="metric-label">High</div><div class="metric-value action-target">$’+pt.high.toFixed(2)+’</div></div><div><div class="metric-label">Upside</div><div class="metric-value" style="color:'+(pt.avg>s.price?'#10b981':'#ef4444')+'">’+(pt.avg>s.price?’+’:’’)+((pt.avg-s.price)/s.price*100).toFixed(1)+’%</div></div></div>’;if(rat.firms&&rat.firms.length){h+=’<div style="margin-top:16px">’;rat.firms.forEach(function(f){h+=’<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-size:13px;color:#fff">’+f.firm+’</span><span style="font-family:monospace;font-size:12px;color:#64748b">’+f.grade+’ ‘+f.date+’</span></div>’;});h+=’</div>’;}el.innerHTML=h;});
/* Dividend */
fetchDividend(sym).then(function(d){var el=document.getElementById(‘dDividend’);if(!el)return;if(!d||!d.length){el.innerHTML=’<div class="section-label">Dividend</div><p class="analysis-text">No dividend data available.</p>’;return;}var h=’<div class="section-label">Dividend History</div><table class="earnings-table"><thead><tr><th>Date</th><th>Dividend</th><th>Adj</th></tr></thead><tbody>’;d.forEach(function(dv){h+=’<tr><td>’+dv.date+’</td><td style="color:#10b981">$’+(dv.dividend||0).toFixed(4)+’</td><td>$’+(dv.adjDividend||dv.dividend||0).toFixed(4)+’</td></tr>’;});h+=’</tbody></table>’;if(s.price>0&&d[0]){var annYield=(d[0].dividend*4/s.price*100).toFixed(2);h+=’<div style="margin-top:12px;text-align:center"><span style="font-family:monospace;font-size:20px;font-weight:700;color:#10b981">’+annYield+’%</span><span style="font-size:12px;color:#64748b;margin-left:8px">est. annual yield</span></div>’;}el.innerHTML=h;});
/* News */
fetchNews(sym).then(function(a){var el=document.getElementById(‘dNews’);if(el)el.innerHTML=’<div class="section-label">News</div>’+(a.length?a.slice(0,5).map(function(it){return rnNI(it,true);}).join(’’):’<p class="analysis-text">No news.</p>’);});
}
function switchTF(tf){curTF=tf;var btns=document.querySelectorAll(’#chartTFRow .tf-btn’);for(var i=0;i<btns.length;i++)btns[i].className=btns[i].textContent===tf?‘tf-btn active’:‘tf-btn’;if(curSym)renderChart(curSym,tf);}
function closeDetail(){document.getElementById(‘detailModal’).classList.remove(‘active’);}
/* Position Sizer */
function calcPosition(sym){var s=findStock(sym);if(!s||!s.price)return;var acct=parseFloat(document.getElementById(‘sizerAcct’).value)||10000;var risk=parseFloat(document.getElementById(‘sizerRisk’).value)||2;var a=genAnalysis(s);var sl=parseFloat(a.sl)||s.price*0.97;var riskPerShare=Math.abs(s.price-sl);if(riskPerShare<0.01)riskPerShare=s.price*0.03;var riskAmt=acct*(risk/100);var shares=Math.floor(riskAmt/riskPerShare);var el=document.getElementById(‘sizerResult’);if(el)el.innerHTML=’<div class="sizer-big">’+shares+’</div><div style="color:#64748b;font-size:12px;margin-top:4px">shares @ $’+s.price.toFixed(2)+’</div><div style="color:#64748b;font-size:11px;margin-top:2px">Risk: $’+riskAmt.toFixed(0)+’ | Stop: $’+sl+’</div>’;}

/* === News Sentiment === */
var BULL=[‘upgrade’,‘beat’,‘surge’,‘rally’,‘soar’,‘gains’,‘outperform’,‘strong’,‘positive’,‘record’,‘bullish’,‘buy’,‘profit’,‘growth’,‘exceeds’,‘partnership’,‘launch’,‘approved’,‘breakthrough’,‘expand’,‘dividend’];
var BEAR=[‘downgrade’,‘miss’,‘plunge’,‘decline’,‘drop’,‘fall’,‘underperform’,‘weak’,‘negative’,‘loss’,‘bearish’,‘sell’,‘warning’,‘cut’,‘layoff’,‘recall’,‘lawsuit’,‘investigation’,‘fraud’,‘debt’,‘concern’,‘risk’,‘delay’];
function sentiment(h){var hl=h.toLowerCase();var bu=0,be=0;for(var i=0;i<BULL.length;i++)if(hl.indexOf(BULL[i])>=0)bu++;for(var j=0;j<BEAR.length;j++)if(hl.indexOf(BEAR[j])>=0)be++;if(bu>be)return{l:‘Bullish’,c:‘bullish’,i:’▲’};if(be>bu)return{l:‘Bearish’,c:‘bearish’,i:’▼’};return{l:‘Neutral’,c:‘neutral’,i:’▬’};}
function extractTK(h,sym){var tk=[];if(sym)tk.push(sym);var m=h.match(/$[A-Z]{1,5}/g);if(m)m.forEach(function(x){var t=x.substring(1);if(tk.indexOf(t)<0)tk.push(t);});for(var i=0;i<state.stocks.length;i++){var s=state.stocks[i];if(h.indexOf(s.symbol)>=0&&tk.indexOf(s.symbol)<0)tk.push(s.symbol);}return tk.slice(0,3);}
function demoNews(sym){var s=findStock(sym);var nm=s?s.name:sym;return[nm+’ Reports Strong Quarter’,‘Analysts Upgrade ‘+sym+’ to Outperform’,nm+’ Partnership Expands Market’,sym+’ Faces Regulatory Concerns’,sym+’ Revenue Growth Accelerates’].map(function(h,i){return{headline:h,source:[‘Reuters’,‘Bloomberg’,‘CNBC’,‘MarketWatch’,‘WSJ’][i],mono:[‘RE’,‘BL’,‘CN’,‘MW’,‘WS’][i],url:’#’,datetime:Date.now()/1000-(i+1)*7200,hoursAgo:(i+1)*2,relSym:sym};});}
function fetchNews(sym){if(state.newsCache[sym]&&Date.now()-state.newsCache[sym].ts<300000)return Promise.resolve(state.newsCache[sym].data);var today=new Date().toISOString().split(‘T’)[0];var wa=new Date(Date.now()-7*864e5).toISOString().split(‘T’)[0];return apiFetch(’/company-news?symbol=’+sym+’&from=’+wa+’&to=’+today).then(function(d){if(d&&Array.isArray(d)&&d.length>0){var arr=d.slice(0,10).map(function(i){return{headline:i.headline,source:i.source||‘Unknown’,mono:(i.source||‘UN’).substring(0,2).toUpperCase(),url:i.url||’#’,datetime:i.datetime,hoursAgo:Math.max(1,Math.floor((Date.now()/1000-i.datetime)/3600)),relSym:sym};});state.newsCache[sym]={data:arr,ts:Date.now()};return arr;}var dm=demoNews(sym);state.newsCache[sym]={data:dm,ts:Date.now()};return dm;});}
function rnNI(it,compact){var t=it.hoursAgo<24?it.hoursAgo+‘h’:Math.floor(it.hoursAgo/24)+‘d’;var sn=sentiment(it.headline);var tk=extractTK(it.headline,it.relSym);var sr=’<div class="news-sentiment">’;for(var i=0;i<tk.length;i++)sr+=’<span class="news-ticker-tag" onclick="event.stopPropagation();tryOpen(\''+tk[i]+'\')">’+tk[i]+’</span>’;sr+=’<span class="news-signal '+sn.c+'">’+sn.i+’ ‘+sn.l+’</span></div>’;return ‘<div class="news-item"><div class="news-source-row"><div class="news-monogram">’+it.mono+’</div><div class="news-source-name">’+it.source+’</div><div class="news-time">’+t+’</div></div><div class="news-headline">’+it.headline+’</div>’+sr+(it.url&&it.url!==’#’&&!compact?’<a class="news-link" href="'+it.url+'" target="_blank">Read article</a>’:’’)+’</div>’;}
function tryOpen(sym){if(findStock(sym)){openDetail(sym);return;}addStock(sym,sym);setTimeout(function(){openDetail(sym);},1500);}

/* Analysis View */
function switchAT(tab){state.analysisSubtab=tab;var btns=document.querySelectorAll(’#analysisSubtabs .analysis-subtab’);for(var i=0;i<btns.length;i++){var t=btns[i].textContent.toLowerCase();btns[i].className=btns[i].getAttribute(‘onclick’).indexOf(”’”+tab+”’”)>=0?‘analysis-subtab active’:‘analysis-subtab’;}renderAT();}
function renderAT(){var c=document.getElementById(‘analysisTabContent’);if(!c)return;
if(state.analysisSubtab===‘stock’){c.innerHTML=’<select class="analysis-stock-select" id="asSel"></select><div id="asContent"></div>’;var sel=document.getElementById(‘asSel’);sel.innerHTML=state.stocks.map(function(s){return ‘<option value=”’+s.symbol+’”’+(s.symbol===state.analysisSymbol?’ selected’:’’)+’>’+s.symbol+’ - ‘+s.name+’</option>’;}).join(’’);sel.onchange=function(){state.analysisSymbol=this.value;renderASC();};renderASC();}
else if(state.analysisSubtab===‘heatmap’){c.innerHTML=’<div class="section-card"><div class="section-label">Sector Heatmap</div><p class="analysis-text mb-md">Size = market cap, color = daily change</p><div class="heatmap-wrap"><canvas id="hmC"></canvas></div></div>’;raf2(function(){drawHeatmap(‘hmC’);});}
else if(state.analysisSubtab===‘compare’){var o=state.stocks.map(function(s){return ‘<option value="'+s.symbol+'">’+s.symbol+’</option>’;}).join(’’);c.innerHTML=’<div class="section-card"><div class="section-label">Peer Comparison</div><div class="peer-selectors"><select class="peer-select" id="peerSel1" onchange="renderPeerCompare()">’+o+’</select><select class="peer-select" id="peerSel2" onchange="renderPeerCompare()">’+o+’</select><select class="peer-select" id="peerSel3" onchange="renderPeerCompare()"><option value="">Optional</option>’+o+’</select></div><div id="peerContent"></div></div>’;if(state.stocks.length>=2){document.getElementById(‘peerSel2’).selectedIndex=1;renderPeerCompare();}}
else if(state.analysisSubtab===‘scores’){var o2=state.stocks.map(function(s){return ‘<option value="'+s.symbol+'">’+s.symbol+’</option>’;}).join(’’);c.innerHTML=’<div class="section-card"><div class="section-label">Score History</div><select class="analysis-stock-select" id="scSel" onchange="drawScoreChart(\'scC\',this.value)">’+o2+’</select><div class="score-chart-wrap"><canvas id="scC"></canvas></div></div>’;raf2(function(){drawScoreChart(‘scC’,state.stocks[0]?state.stocks[0].symbol:‘NVDA’);});}
else if(state.analysisSubtab===‘mtf’){var o3=state.stocks.map(function(s){return ‘<option value="'+s.symbol+'">’+s.symbol+’</option>’;}).join(’’);c.innerHTML=’<div class="section-card"><div class="section-label">Multi-Timeframe</div><select class="analysis-stock-select" id="mtfSel" onchange="renderMTF()">’+o3+’</select><div class="mtf-grid" id="mtfGrid"></div></div>’;renderMTF();}
else if(state.analysisSubtab===‘corr’){c.innerHTML=’<div class="section-card"><div class="section-label">Correlation Matrix</div><p class="analysis-text mb-md">Correlation between your stocks</p><div class="corr-wrap"><canvas id="corrC"></canvas></div></div>’;raf2(function(){drawCorrelation(‘corrC’);});}
else if(state.analysisSubtab===‘alloc’){c.innerHTML=’<div class="section-card"><div class="section-label">Portfolio Allocation</div><div class="pie-wrap"><canvas id="pieC"></canvas></div><div class="pie-legend" id="pieLegend"></div></div>’;raf2(function(){drawPie(‘pieC’);});}
else if(state.analysisSubtab===‘perf’){c.innerHTML=’<div class="section-card"><div class="section-label">Portfolio Performance</div><p class="analysis-text mb-md">Daily portfolio value over time</p><div class="perf-wrap"><canvas id="perfC"></canvas></div></div>’;raf2(function(){drawPerfChart(‘perfC’);});}
else if(state.analysisSubtab===‘econ’){c.innerHTML=’<div class="section-card"><div class="section-label">Economic Calendar</div><div id="econContent"><div class="skeleton-block"></div></div></div>’;fetchEconCalendar().then(function(evts){var el=document.getElementById(‘econContent’);if(!el)return;if(!evts.length){el.innerHTML=’<p class="analysis-text">No upcoming events found.</p>’;return;}el.innerHTML=evts.map(function(ev){var imp=ev.impact||‘medium’;return ‘<div class="econ-item"><div class="econ-date">’+(ev.date||‘TBD’)+’</div><div class="econ-title">’+(ev.event||‘Economic Event’)+’</div><span class="econ-impact econ-'+imp+'">’+imp.toUpperCase()+’</span>’+(ev.country?’<span style="font-size:11px;color:#64748b;margin-left:8px">’+ev.country+’</span>’:’’)+’</div>’;}).join(’’);});}
else if(state.analysisSubtab===‘div’){var o4=state.stocks.map(function(s){return ‘<option value="'+s.symbol+'">’+s.symbol+’</option>’;}).join(’’);c.innerHTML=’<div class="section-card"><div class="section-label">Dividend Tracker</div><div id="divContent"><div class="skeleton-block"></div></div></div>’;var divH=’’;var loaded=0;var total2=Math.min(state.stocks.length,10);if(!total2){c.querySelector(’#divContent’).innerHTML=’<p class="analysis-text">No stocks to check.</p>’;return;}for(var di=0;di<total2;di++){(function(sym){fetchDividend(sym).then(function(d){loaded++;if(d&&d.length>0){var s2=findStock(sym);var yld=s2&&s2.price>0?(d[0].dividend*4/s2.price*100).toFixed(2):‘N/A’;divH+=’<div class="div-row"><span class="div-sym">’+sym+’</span><span style="font-size:13px;color:#94a3b8">$’+(d[0].dividend||0).toFixed(4)+’</span><span class="div-yield">’+yld+’%</span></div>’;}if(loaded>=total2){var el2=document.getElementById(‘divContent’);if(el2)el2.innerHTML=divH||’<p class="analysis-text">No dividends found.</p>’;}});})(state.stocks[di].symbol);}}
else if(state.analysisSubtab===‘predict’){var o5=state.stocks.map(function(s){return ‘<option value="'+s.symbol+'">’+s.symbol+’</option>’;}).join(’’);c.innerHTML=’<div class="section-card"><div class="section-label">Earnings Surprise Predictor</div><select class="analysis-stock-select" id="predSel" onchange="renderPredict()">’+o5+’</select><div id="predContent"><div class="skeleton-block"></div></div></div>’;renderPredict();}
else if(state.analysisSubtab===‘volume’){var o6=state.stocks.map(function(s){return ‘<option value="'+s.symbol+'">’+s.symbol+’</option>’;}).join(’’);c.innerHTML=’<div class="section-card"><div class="section-label">Volume Analysis</div><select class="analysis-stock-select" id="volSel" onchange="renderVolAnalysis()">’+o6+’</select><div id="volContent"></div></div>’;renderVolAnalysis();}
}
function raf2(fn){requestAnimationFrame(function(){requestAnimationFrame(fn);});}
function renderASC(){var s=findStock(state.analysisSymbol);if(!s)return;var cid=‘ac_’+s.symbol;document.getElementById(‘asContent’).innerHTML=renderAnalysisCard(s,cid);setTimeout(function(){renderAChart(s.symbol,cid);},100);}
/* Multi-timeframe */
function renderMTF(){var sym=(document.getElementById(‘mtfSel’)||{}).value||state.stocks[0].symbol;var grid=document.getElementById(‘mtfGrid’);if(!grid)return;grid.innerHTML=’’;var tfs=[‘1D’,‘1W’,‘1M’,‘3M’];tfs.forEach(function(tf){var cell=document.createElement(‘div’);cell.className=‘mtf-cell’;cell.innerHTML=’<div class="mtf-label">’+tf+’</div><div style="height:120px"><canvas id="mtf_'+tf+'"></canvas></div>’;grid.appendChild(cell);loadChartData(sym,tf).then(function(candles){var el=document.getElementById(‘mtf_’+tf);if(!el)return;var w=cell.clientWidth-16;var h=120;var dpr=window.devicePixelRatio||1;el.width=w*dpr;el.height=h*dpr;el.style.width=w+‘px’;el.style.height=h+‘px’;var ctx=el.getContext(‘2d’);ctx.scale(dpr,dpr);/* Simple line */ctx.strokeStyle=candles[candles.length-1].close>=candles[0].close?’#10b981’:’#ef4444’;ctx.lineWidth=1.5;var hi=-Infinity,lo=Infinity;candles.forEach(function(c){if(c.close>hi)hi=c.close;if(c.close<lo)lo=c.close;});var rng=hi-lo||1;ctx.beginPath();candles.forEach(function(c,i){var x=i/(candles.length-1)*w;var y=5+(1-(c.close-lo)/rng)*(h-10);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();});});}
/* Predict */
function renderPredict(){var sym=(document.getElementById(‘predSel’)||{}).value||state.stocks[0].symbol;var el=document.getElementById(‘predContent’);if(!el)return;el.innerHTML=’<div class="skeleton-block"></div>’;fetchEarnings(sym).then(function(ear){if(!ear||!ear.quarters||ear.quarters.length<2){el.innerHTML=’<p class="analysis-text">Insufficient earnings data.</p>’;return;}var beats=0;ear.quarters.forEach(function(q){if(q.eps>=q.epsEstimated)beats++;});var pct=Math.round(beats/ear.quarters.length*100);var avgSurprise=0;ear.quarters.forEach(function(q){if(q.epsEstimated)avgSurprise+=(q.eps-q.epsEstimated)/Math.abs(q.epsEstimated)*100;});avgSurprise=ear.quarters.length?(avgSurprise/ear.quarters.length).toFixed(1):0;el.innerHTML=’<div style="text-align:center;padding:20px"><div style="font-size:48px;font-weight:700;color:'+(pct>=60?'#10b981':'#f59e0b')+'">’+pct+’%</div><div style="font-size:14px;color:#94a3b8;margin-top:4px">Probability of beating estimates</div></div><div class="metric-grid" style="margin-top:16px"><div><div class="metric-label">Beats</div><div class="metric-value positive">’+beats+’</div></div><div><div class="metric-label">Misses</div><div class="metric-value negative">’+(ear.quarters.length-beats)+’</div></div><div><div class="metric-label">Avg Surprise</div><div class="metric-value" style="color:'+(avgSurprise>=0?'#10b981':'#ef4444')+'">’+avgSurprise+’%</div></div><div><div class="metric-label">Quarters</div><div class="metric-value">’+ear.quarters.length+’</div></div></div>’;});}
/* Volume Analysis */
function renderVolAnalysis(){var sym=(document.getElementById(‘volSel’)||{}).value||state.stocks[0].symbol;var el=document.getElementById(‘volContent’);if(!el)return;var s=findStock(sym);if(!s){el.innerHTML=’<p class="analysis-text">No data.</p>’;return;}var avgVol=s.volume;var ratio=avgVol>0?(s.volume/avgVol).toFixed(2):‘N/A’;var unusual=s.volume>avgVol*1.5;el.innerHTML=’<div class="metric-grid" style="margin-top:16px"><div><div class="metric-label">Current Vol</div><div class="metric-value">’+fmtS(s.volume)+’</div></div><div><div class="metric-label">Relative</div><div class="metric-value" style="color:'+(unusual?'#f59e0b':'#94a3b8')+'">’+ratio+‘x</div></div></div>’+(unusual?’<div style="margin-top:16px;padding:12px;background:rgba(245,158,11,0.08);border-radius:10px;text-align:center"><span style="font-size:13px;font-weight:600;color:#f59e0b">⚠ Unusual Volume Detected</span><p class="analysis-text mt-sm">Volume significantly above average. Potential institutional activity.</p></div>’:’<div style="margin-top:16px;padding:12px;background:rgba(16,185,129,0.08);border-radius:10px;text-align:center"><span style="font-size:13px;color:#10b981">Volume within normal range</span></div>’);}

/* === Paper Trading === */
function renderTrade(){var c=document.getElementById(‘tradeContent’);if(!c)return;var o=state.stocks.map(function(s){return ‘<option value="'+s.symbol+'">’+s.symbol+’ $’+s.price.toFixed(2)+’</option>’;}).join(’’);var pnl=0;var wins=0;var closed=trades.filter(function(t){return t.closed;});closed.forEach(function(t){pnl+=t.pnl||0;if((t.pnl||0)>0)wins++;});var wr=closed.length?Math.round(wins/closed.length*100):0;c.innerHTML=’<div class="section-card"><div class="section-label">Paper Account</div><div class="metric-grid"><div><div class="metric-label">Balance</div><div class="metric-value" style="font-size:22px;color:#3b82f6">$’+paperBalance.toFixed(2)+’</div></div><div><div class="metric-label">Total P&L</div><div class="metric-value '+(pnl>=0?'positive':'negative')+'" style="font-size:22px">’+(pnl>=0?’+’:’’)+pnl.toFixed(2)+’</div></div><div><div class="metric-label">Win Rate</div><div class="metric-value">’+wr+’%</div></div><div><div class="metric-label">Trades</div><div class="metric-value">’+trades.length+’</div></div></div></div><div class="section-card"><div class="section-label">New Trade</div><select class="analysis-stock-select" id="tradeSym">’+o+’</select><div class="trade-form"><input class="trade-input" id="tradeQty" type="number" placeholder="Shares" value="10"><input class="trade-input" id="tradePrice" type="number" placeholder="Price" step="0.01"></div><div style="display:flex;gap:8px"><button class="trade-btn trade-btn-buy" style="flex:1" onclick="execTrade(\'BUY\')">BUY</button><button class="trade-btn trade-btn-sell" style="flex:1" onclick="execTrade(\'SELL\')">SELL</button></div></div>’
+’<div class="section-card"><div class="section-label">Open Positions</div><div id="openPos"></div></div>’
+’<div class="section-card"><div class="section-label">Trade Journal</div><div id="tradeJournal"></div></div>’;
/* Auto-fill price */
var tSel=document.getElementById(‘tradeSym’);tSel.onchange=function(){var s=findStock(this.value);if(s)document.getElementById(‘tradePrice’).value=s.price.toFixed(2);};var s0=findStock(tSel.value);if(s0)document.getElementById(‘tradePrice’).value=s0.price.toFixed(2);
renderOpenPos();renderJournal();}
function execTrade(side){var sym=document.getElementById(‘tradeSym’).value;var qty=parseInt(document.getElementById(‘tradeQty’).value)||0;var price=parseFloat(document.getElementById(‘tradePrice’).value)||0;if(!qty||!price){showToast(‘Enter qty & price’);return;}var cost=qty*price;if(side===‘BUY’&&cost>paperBalance){showToast(‘Insufficient balance’);return;}var trade={id:Date.now(),sym:sym,side:side,qty:qty,price:price,date:new Date().toISOString().split(‘T’)[0],closed:false,pnl:0};if(side===‘BUY’)paperBalance-=cost;else paperBalance+=cost;trades.push(trade);saveTrades();saveBalance();renderTrade();showToast(side+’ ‘+qty+’ ‘+sym+’ @ $’+price.toFixed(2));sendNotification(side+’ ‘+sym,‘Executed ‘+qty+’ shares @ $’+price.toFixed(2));}
function closeTrade(id){for(var i=0;i<trades.length;i++){if(trades[i].id===id&&!trades[i].closed){var t=trades[i];var s=findStock(t.sym);var cp=s?s.price:t.price;t.closePrice=cp;t.closed=true;if(t.side===‘BUY’){t.pnl=(cp-t.price)*t.qty;paperBalance+=cp*t.qty;}else{t.pnl=(t.price-cp)*t.qty;paperBalance-=cp*t.qty;}saveTrades();saveBalance();renderTrade();showToast(‘Closed ‘+t.sym+’ P&L: $’+t.pnl.toFixed(2));break;}}}
function renderOpenPos(){var el=document.getElementById(‘openPos’);if(!el)return;var open=trades.filter(function(t){return !t.closed;});if(!open.length){el.innerHTML=’<p class="analysis-text text-center">No open positions</p>’;return;}el.innerHTML=open.map(function(t){var s=findStock(t.sym);var cp=s?s.price:t.price;var upnl=t.side===‘BUY’?(cp-t.price)*t.qty:(t.price-cp)*t.qty;return ‘<div class="trade-journal-item"><div><div style="font-family:monospace;font-weight:700;color:#fff">’+t.sym+’ <span class="'+(t.side==='BUY'?'positive':'negative')+'">’+t.side+’</span></div><div style="font-size:12px;color:#64748b">’+t.qty+’ @ $’+t.price.toFixed(2)+’</div></div><div style="text-align:right"><div class="'+(upnl>=0?'positive':'negative')+'" style="font-family:monospace;font-weight:700">’+(upnl>=0?’+’:’’)+upnl.toFixed(2)+’</div><button style="font-size:11px;color:#ef4444;background:none;border:1px solid #ef4444;border-radius:6px;padding:3px 8px;cursor:pointer;margin-top:4px" onclick="closeTrade('+t.id+')">Close</button></div></div>’;}).join(’’);}
function renderJournal(){var el=document.getElementById(‘tradeJournal’);if(!el)return;var closed=trades.filter(function(t){return t.closed;}).reverse().slice(0,20);if(!closed.length){el.innerHTML=’<p class="analysis-text text-center">No closed trades</p>’;return;}el.innerHTML=closed.map(function(t){return ‘<div class="trade-journal-item"><div><div style="font-family:monospace;font-weight:700;color:#fff">’+t.sym+’ ‘+t.side+’</div><div style="font-size:12px;color:#64748b">’+t.qty+’ @ $’+t.price.toFixed(2)+’ → $’+(t.closePrice||0).toFixed(2)+’ | ‘+t.date+’</div></div><div class="'+(t.pnl>=0?'positive':'negative')+'" style="font-family:monospace;font-weight:700">’+(t.pnl>=0?’+’:’’)+t.pnl.toFixed(2)+’</div></div>’;}).join(’’);}

/* === News View === */
function rnNewsView(){var syms=[‘all’];for(var i=0;i<state.stocks.length;i++)syms.push(state.stocks[i].symbol);document.getElementById(‘newsFilterRow’).innerHTML=syms.map(function(s){return ‘<button class="sector-tab'+(s===state.newsSymbol?' active':'')+'" onclick="filterNews(\''+s+'\')" style="margin-right:8px">’+(s===‘all’?‘Top Stories’:s)+’</button>’;}).join(’’);updNews();}
function filterNews(s){state.newsSymbol=s;var b=document.querySelectorAll(’#newsFilterRow .sector-tab’);for(var i=0;i<b.length;i++)b[i].className=b[i].textContent===(s===‘all’?‘Top Stories’:s)?‘sector-tab active’:‘sector-tab’;updNews();}
function updNews(){var c=document.getElementById(‘newsContent’);c.innerHTML=’<div class="skeleton-block"></div>’;if(state.newsSymbol===‘all’){var all=[];var syms=state.stocks.slice(0,8).map(function(s){return s.symbol;});var idx=0;function nx(){if(idx>=syms.length){all.sort(function(a,b){return b.datetime-a.datetime;});c.innerHTML=all.length?’<div class="section-card">’+all.map(function(it){return rnNI(it,false);}).join(’’)+’</div>’:’<div class="section-card"><p class="analysis-text text-center">No news.</p></div>’;return;}fetchNews(syms[idx]).then(function(n){for(var i=0;i<Math.min(2,n.length);i++)all.push(n[i]);idx++;nx();});}nx();}else{fetchNews(state.newsSymbol).then(function(a){c.innerHTML=a.length?’<div class="section-card">’+a.map(function(it){return rnNI(it,false);}).join(’’)+’</div>’:’<div class="section-card"><p class="analysis-text text-center">No news.</p></div>’;});}}

/* === View Switching === */
function switchView(v){state.currentView=v;var views=document.querySelectorAll(’.view’);for(var i=0;i<views.length;i++)views[i].classList.remove(‘active’);var tabs=document.querySelectorAll(’.tab-item’);for(var j=0;j<tabs.length;j++)tabs[j].classList.remove(‘active’);document.getElementById(v+‘View’).classList.add(‘active’);document.querySelector(’.tab-item[data-view=”’+v+’”]’).classList.add(‘active’);if(v===‘analysis’)renderAT();if(v===‘news’)rnNewsView();if(v===‘ai’)renderAI();if(v===‘trade’)renderTrade();if(v===‘settings’)rnSettings();}
/* ═══════════════════════════════════════════
Settings, Themes, PWA, Notifications, Export, Init
═══════════════════════════════════════════ */
function applyTheme(){document.body.className=’’;if(state.settings.theme===‘light’)document.body.classList.add(‘theme-light’);else if(state.settings.theme===‘oled’)document.body.classList.add(‘theme-oled’);document.querySelector(‘meta[name=“theme-color”]’).content=state.settings.theme===‘light’?’#f8fafc’:state.settings.theme===‘oled’?’#000000’:’#0f1419’;}
function setTheme(t){state.settings.theme=t;saveSt();applyTheme();rnSettings();showToast(t+’ theme’);}
function setAccent(c){state.settings.accent=c;saveSt();rnSettings();}
function rnSettings(){var s=state.settings;document.getElementById(‘settingsContent’).innerHTML=
‘<div class="setting-group"><div class="setting-group-title">API Keys</div><div class="setting-row" style="display:block"><div class="setting-label">Finnhub API Key</div><div style="display:flex;margin-top:8px"><input type="text" class="setting-input" style="flex:1;width:auto;text-align:left;font-size:12px" id="apiKeyInput" value="'+s.apiKey+'"><button class="setting-btn" onclick="saveApiKey()" style="margin-left:8px">Save</button></div></div><div class="setting-row" style="display:block"><div class="setting-label">Anthropic API Key</div><div class="setting-desc">Powers AI features (optional)</div><div style="display:flex;margin-top:8px"><input type="password" class="setting-input" style="flex:1;width:auto;text-align:left;font-size:12px" id="anthKeyInput" value="'+(s.anthropicKey||'')+'"><button class="setting-btn" onclick="saveAnthKey()" style="margin-left:8px;background:#8b5cf6">Save</button></div></div></div>’
+’<div class="setting-group"><div class="setting-group-title">Appearance</div><div class="setting-row" style="display:block"><div class="setting-label">Theme</div><div class="theme-options"><div class="theme-opt'+(s.theme==='dark'?' active':'')+'" onclick="setTheme(\'dark\')" style="background:#0f1419;color:#fff">Dark</div><div class="theme-opt'+(s.theme==='light'?' active':'')+'" onclick="setTheme(\'light\')" style="background:#f8fafc;color:#334155">Light</div><div class="theme-opt'+(s.theme==='oled'?' active':'')+'" onclick="setTheme(\'oled\')" style="background:#000;color:#fff">OLED</div></div></div><div class="setting-row" style="display:block"><div class="setting-label">Accent Color</div><div class="color-options">’+ACCENTS.map(function(c){return ‘<div class="color-opt'+(c===s.accent?' active':'')+'" style="background-color:'+c+'" onclick="setAccent(\''+c+'\')"></div>’;}).join(’’)+’</div></div></div>’
+’<div class="setting-group"><div class="setting-group-title">Display</div><div class="setting-row"><div><div class="setting-label">Compact View</div></div><div class="toggle'+(s.compactView?' active':'')+'" onclick="toggleSetting(\'compactView\')"></div></div><div class="setting-row"><div><div class="setting-label">Pre-Market Data</div></div><div class="toggle'+(s.showPreMarket?' active':'')+'" onclick="toggleSetting(\'showPreMarket\')"></div></div></div>’
+’<div class="setting-group"><div class="setting-group-title">Notifications</div><div class="setting-row"><div><div class="setting-label">Push Alerts</div><div class="setting-desc">Price alerts & earnings</div></div><div class="toggle'+(s.notifications?' active':'')+'" onclick="toggleNotif()"></div></div></div>’
+’<div class="setting-group"><div class="setting-group-title">Data</div><div class="setting-row"><div><div class="setting-label">Auto-Refresh</div></div><div class="toggle'+(s.autoRefresh?' active':'')+'" onclick="toggleSetting(\'autoRefresh\')"></div></div><div class="setting-row"><div><div class="setting-label">Interval (sec)</div></div><input type="number" class="setting-input" id="refInput" value="'+s.refreshInterval+'" min="10" max="300" onchange="saveRI()"></div><div class="setting-row"><div class="setting-label">WebSocket Stream</div><button class="setting-btn" onclick="connectWS()">Connect</button></div><div class="setting-row" style="border:none"><div class="setting-label">Manual Refresh</div><button class="setting-btn" onclick="manualRefresh()">Refresh Now</button></div></div>’
+’<div class="setting-group"><div class="setting-group-title">Export</div><div class="export-btns"><button class="export-btn" onclick="exportCSV()">Export CSV</button><button class="export-btn" onclick="exportJSON()">Export JSON</button><button class="export-btn" onclick="sharePortfolio()">Share</button></div></div>’
+’<div class="setting-group"><div class="setting-group-title">Reset</div><div class="setting-row"><div class="setting-label">Reset Defaults</div><button class="setting-btn danger" onclick="resetStocks()">Reset</button></div><div class="setting-row"><div class="setting-label">Reset Paper Account</div><button class="setting-btn danger" onclick="resetPaper()">Reset</button></div><div class="setting-row" style="border:none"><div class="setting-label">Clear Cache</div><button class="setting-btn danger" onclick="clearCache()">Clear</button></div></div>’
+’<div class="setting-group"><div class="setting-group-title">About</div><div class="about-block"><div class="about-title">Bulls Eye Pro</div><div class="about-version">v15.0 Professional Edition</div><p class="about-text">AI-powered market scanner. Claude integration. Universal tickers. Signal-based filtering. WebSocket streaming. RSI, Bollinger, EMA, MACD indicators. Interactive charts. Paper trading. Portfolio analytics. 3 themes. PWA offline. 8 AI features.</p></div></div>’;}
function toggleSetting(k){state.settings[k]=!state.settings[k];saveSt();rnSettings();if(k===‘autoRefresh’)setupAR();showToast(k+’ ’+(state.settings[k]?‘on’:‘off’));}
function saveApiKey(){state.settings.apiKey=document.getElementById(‘apiKeyInput’).value.trim();saveSt();showToast(‘Finnhub key saved’);}
function saveAnthKey(){state.settings.anthropicKey=document.getElementById(‘anthKeyInput’).value.trim();saveSt();showToast(state.settings.anthropicKey?‘Anthropic key saved’:‘Key removed’);}
function saveRI(){var v=parseInt(document.getElementById(‘refInput’).value)||60;v=Math.max(10,Math.min(300,v));state.settings.refreshInterval=v;saveSt();if(state.settings.autoRefresh)setupAR();showToast(’Interval: ’+v+‘s’);}
function saveSt(){try{localStorage.setItem(‘bep_settings’,JSON.stringify(state.settings));}catch(e){}}
function resetStocks(){watchlists[‘Portfolio’]=DEFAULT_STOCKS.slice();activeWatchlist=‘Portfolio’;saveWL();renderWLS();loadDemoData();renderStocks();showToast(‘Reset’);}
function resetPaper(){paperBalance=10000;trades=[];saveBalance();saveTrades();showToast(‘Paper account reset’);}
function clearCache(){var keys=[];for(var i=0;i<localStorage.length;i++){var k=localStorage.key(i);if(k&&k.indexOf(‘bep_q_’)===0)keys.push(k);}for(var j=0;j<keys.length;j++)localStorage.removeItem(keys[j]);state.newsCache={};showToast(‘Cleared ‘+keys.length+’ items’);}
function manualRefresh(){showToast(‘Refreshing…’);DS=‘auto’;var stocks=getAS();for(var i=0;i<stocks.length;i++)localStorage.removeItem(‘bep_q_’+stocks[i].symbol);loadRealData().then(function(){renderStocks();fetchTrendingStocks();if(state.usingDemo)showToast(‘APIs unavailable’);});}
var arTimer=null;function setupAR(){if(arTimer)clearInterval(arTimer);if(state.settings.autoRefresh)arTimer=setInterval(function(){DS=‘auto’;loadRealData().then(function(){renderStocks();});},state.settings.refreshInterval*1000);}
function toggleNotif(){if(!(‘Notification’ in window)){showToast(‘Not supported’);return;}if(Notification.permission===‘granted’){state.settings.notifications=!state.settings.notifications;saveSt();rnSettings();showToast(‘Notifications ‘+(state.settings.notifications?‘on’:‘off’));}else{Notification.requestPermission().then(function(p){state.settings.notifications=p===‘granted’;saveSt();rnSettings();});}}
function sendNotification(title,body){if(!state.settings.notifications||!(‘Notification’ in window)||Notification.permission!==‘granted’)return;try{new Notification(‘Bulls Eye: ‘+title,{body:body});}catch(e){}}
function exportCSV(){var csv=‘Symbol,Name,Price,Change%,Score,Signal,MarketCap,PE\n’;state.stocks.forEach(function(s){var sig=computeSignal(s);csv+=s.symbol+’,’+s.name.replace(/,/g,’ ‘)+’,’+s.price.toFixed(2)+’,’+s.changePercent.toFixed(2)+’,’+s.score+’,’+sig.signal+’,’+(s.marketCap||0)+’,’+(s.pe||0)+’\n’;});downloadFile(‘bulls_eye_’+new Date().toISOString().split(‘T’)[0]+’.csv’,csv,‘text/csv’);showToast(‘CSV exported’);}
function exportJSON(){var data={watchlists:watchlists,trades:trades,balance:paperBalance,settings:state.settings,exported:new Date().toISOString()};downloadFile(‘bulls_eye_backup.json’,JSON.stringify(data,null,2),‘application/json’);showToast(‘JSON exported’);}
function downloadFile(name,content,type){var blob=new Blob([content],{type:type});var url=URL.createObjectURL(blob);var a=document.createElement(‘a’);a.href=url;a.download=name;a.click();URL.revokeObjectURL(url);}
function sharePortfolio(){var text=‘Bulls Eye Pro Portfolio\n\n’;state.stocks.forEach(function(s){var sig=computeSignal(s);text+=s.symbol+’ $’+s.price.toFixed(2)+’ (’+(s.changePercent>=0?’+’:’’)+s.changePercent.toFixed(2)+’%) ‘+sig.signal+’\n’;});if(navigator.share){navigator.share({title:‘Bulls Eye Pro’,text:text}).catch(function(){});}else{navigator.clipboard.writeText(text).then(function(){showToast(‘Copied to clipboard’);}).catch(function(){});}}
var deferredPrompt=null;window.addEventListener(‘beforeinstallprompt’,function(e){e.preventDefault();deferredPrompt=e;var b=document.getElementById(‘pwaBanner’);if(b)b.classList.add(‘show’);});
function installPWA(){if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(function(){deferredPrompt=null;document.getElementById(‘pwaBanner’).classList.remove(‘show’);});}}
function registerSW(){if(‘serviceWorker’ in navigator){navigator.serviceWorker.register(‘sw.js’).catch(function(){});}}
/* Pull to Refresh */
var pY2=0,pAct=false,pOK=false;var pInd=document.getElementById(‘pullIndicator’);var pTxt=document.getElementById(‘pullText’);
document.getElementById(‘stocksView’).addEventListener(‘touchstart’,function(e){if(window.scrollY<=5&&state.currentView===‘stocks’){pY2=e.touches[0].clientY;pAct=true;pOK=false;}},{passive:true});
document.getElementById(‘stocksView’).addEventListener(‘touchmove’,function(e){if(!pAct)return;var dy=e.touches[0].clientY-pY2;if(dy>10&&window.scrollY<=5){pInd.classList.add(‘pulling’);pTxt.textContent=dy>80?‘Release to refresh’:‘Pull to refresh’;pOK=dy>80;}else pInd.classList.remove(‘pulling’);},{passive:true});
document.getElementById(‘stocksView’).addEventListener(‘touchend’,function(){if(!pAct)return;pAct=false;if(pOK){pTxt.innerHTML=’<span class="pull-spinner"></span> Refreshing…’;pInd.classList.add(‘refreshing’);DS=‘auto’;loadRealData().then(function(){renderStocks();fetchTrendingStocks();});}setTimeout(function(){pInd.classList.remove(‘pulling’);pInd.classList.remove(‘refreshing’);pTxt.textContent=‘Pull to refresh’;},600);});
/* Init */
function init(){applyTheme();renderWLS();loadDemoData();renderStocks();loadRealData().then(function(){renderStocks();});fetchTrendingStocks();setupAR();registerSW();setTimeout(function(){connectWS();},3000);}
init();
/* ═══════════════════════════════════════════
AI Intelligence — Claude-Powered Features
═══════════════════════════════════════════ */
var AI_FEATURES=[
{id:‘chat’,icon:’💬’,title:‘AI Stock Chat’,desc:‘Ask Claude anything about any stock. Get instant analysis, comparisons, and recommendations.’,badge:‘Interactive’},
{id:‘brief’,icon:’📊’,title:‘AI Market Brief’,desc:‘Daily market summary with key movers, sector trends, and what to watch today.’,badge:‘Daily’},
{id:‘ideas’,icon:’💡’,title:‘AI Trade Ideas’,desc:‘AI-generated trade setups with entry, exit, stop-loss, and detailed reasoning.’,badge:‘Pro’},
{id:‘review’,icon:’🔍’,title:‘AI Portfolio Review’,desc:‘Comprehensive portfolio audit. Diversification analysis, risk scoring, and rebalancing suggestions.’,badge:‘Pro’},
{id:‘patterns’,icon:’📈’,title:‘AI Pattern Recognition’,desc:‘Detect chart patterns: head & shoulders, double bottoms, wedges, flags, and more.’,badge:‘Technical’},
{id:‘sentiment’,icon:’🧠’,title:‘AI Sentiment Digest’,desc:‘Aggregate news sentiment across your entire portfolio. Bullish/bearish trend analysis.’,badge:‘Intelligence’},
{id:‘similar’,icon:’🔗’,title:‘Stocks Like This’,desc:‘Discover similar stocks based on your holdings. Sector, momentum, and fundamental matching.’,badge:‘Discovery’},
{id:‘risk’,icon:’🛡’,title:‘AI Risk Report’,desc:‘Portfolio-wide risk scoring. Concentration risk, correlation analysis, and hedging suggestions.’,badge:‘Pro’}
];

function renderAI(){
var c=document.getElementById(‘aiContent’);if(!c)return;
if(state.aiView===‘menu’){
var keyStatus=state.settings.anthropicKey?’<div style="padding:12px 16px;background:rgba(16,185,129,0.08);border-radius:10px;margin-bottom:16px;font-size:13px;color:#10b981">✓ Claude API key configured</div>’:’<div style="padding:12px 16px;background:rgba(139,92,246,0.08);border-radius:12px;margin-bottom:16px"><div style="font-size:13px;color:#8b5cf6;font-weight:600;margin-bottom:8px">Connect Claude AI for full features</div><div class="ai-key-row"><input class="ai-key-input" id="aiKeyInput" type="password" placeholder="sk-ant-..."><button class="ai-key-save" onclick="saveAIKey()">Save</button></div><div style="font-size:11px;color:#64748b;margin-top:6px">Features work without a key using algorithmic analysis. Add key for Claude-powered insights.</div></div>’;
c.innerHTML=keyStatus+AI_FEATURES.map(function(f){return ‘<div class="ai-card" onclick="openAIFeature(\''+f.id+'\')"><div class="ai-card-icon">’+f.icon+’</div><div class="ai-card-title">’+f.title+’</div><div class="ai-card-desc">’+f.desc+’</div><span class="ai-card-badge ai-badge-pro">’+f.badge+’</span></div>’;}).join(’’);
}else{
c.innerHTML=’<button class="ai-back-btn" onclick="state.aiView=\'menu\';renderAI()">← Back to AI Menu</button><div id="aiFeatureContent"></div>’;
renderAIFeature(state.aiView);
}
}
function saveAIKey(){var k=document.getElementById(‘aiKeyInput’).value.trim();state.settings.anthropicKey=k;saveSt();showToast(k?‘API key saved’:‘Key removed’);renderAI();}
function openAIFeature(id){state.aiView=id;renderAI();}

function callClaude(prompt,callback){
if(!state.settings.anthropicKey){callback(null,‘No API key. Using algorithmic analysis.’);return;}
var stockContext=‘Portfolio: ‘+state.stocks.map(function(s){return s.symbol+’ $’+s.price.toFixed(2)+’ (’+((s.changePercent>=0?’+’:’’)+s.changePercent.toFixed(2))+’%) Score:’+s.score;}).join(’, ‘);
fetch(‘https://api.anthropic.com/v1/messages’,{
method:‘POST’,
headers:{‘Content-Type’:‘application/json’,‘x-api-key’:state.settings.anthropicKey,‘anthropic-version’:‘2023-06-01’,‘anthropic-dangerous-direct-browser-access’:‘true’},
body:JSON.stringify({model:‘claude-sonnet-4-20250514’,max_tokens:1500,messages:[{role:‘user’,content:stockContext+’\n\n’+prompt}]})
}).then(function(r){return r.json();}).then(function(d){
if(d.content&&d.content[0])callback(d.content[0].text,null);
else callback(null,d.error?d.error.message:‘API error’);
}).catch(function(e){callback(null,e.message||‘Connection failed’);});
}

function renderAIFeature(id){
var fc=document.getElementById(‘aiFeatureContent’);if(!fc)return;
if(id===‘chat’){renderAIChat(fc);}
else if(id===‘brief’){renderAIBrief(fc);}
else if(id===‘ideas’){renderAIIdeas(fc);}
else if(id===‘review’){renderAIReview(fc);}
else if(id===‘patterns’){renderAIPatterns(fc);}
else if(id===‘sentiment’){renderAISentiment(fc);}
else if(id===‘similar’){renderAISimilar(fc);}
else if(id===‘risk’){renderAIRisk(fc);}
}

/* ═══ AI CHAT ═══ */
function renderAIChat(fc){
fc.innerHTML=’<div class="section-card"><div class="ai-chat-container"><div class="ai-chat-messages" id="aiChatMsgs">’+state.aiMessages.map(function(m){return ‘<div class="ai-msg '+(m.role==='user'?'ai-msg-user':'ai-msg-ai')+'">’+m.text+’</div>’;}).join(’’)+’</div><div class="ai-chat-input-row"><input class="ai-chat-input" id="aiChatIn" type="text" placeholder="Ask about any stock..." onkeypress="if(event.key===\'Enter\')sendAIChat()"><button class="ai-send-btn" onclick="sendAIChat()">➤</button></div></div></div>’;
var msgs=document.getElementById(‘aiChatMsgs’);if(msgs)msgs.scrollTop=msgs.scrollHeight;
}
function sendAIChat(){
var inp=document.getElementById(‘aiChatIn’);var q=inp.value.trim();if(!q)return;inp.value=’’;
state.aiMessages.push({role:‘user’,text:q});
var msgs=document.getElementById(‘aiChatMsgs’);
msgs.innerHTML+=’<div class="ai-msg ai-msg-user">’+q+’</div><div class="ai-typing" id="aiTyping">Claude is thinking…</div>’;
msgs.scrollTop=msgs.scrollHeight;
callClaude(‘You are a stock market analyst. Answer concisely: ‘+q,function(resp,err){
var el=document.getElementById(‘aiTyping’);if(el)el.remove();
var answer=resp||algoChat(q);
state.aiMessages.push({role:‘ai’,text:answer});
msgs.innerHTML+=’<div class="ai-msg ai-msg-ai">’+answer+’</div>’;
msgs.scrollTop=msgs.scrollHeight;
});
}
function algoChat(q){
var ql=q.toLowerCase();var sym=null;
for(var i=0;i<state.stocks.length;i++){if(ql.indexOf(state.stocks[i].symbol.toLowerCase())>=0){sym=state.stocks[i];break;}}
if(sym){var sig=computeSignal(sym);return ‘<strong>’+sym.symbol+’</strong> is currently at <strong>$’+sym.price.toFixed(2)+’</strong> (’+(sym.changePercent>=0?’+’:’’)+sym.changePercent.toFixed(2)+’%).<br><br>Signal: <strong>’+sig.signal+’</strong> (Score: ‘+sym.score+’/100)<br>Market Cap: ‘+fmtN(sym.marketCap)+’<br>P/E: ‘+(sym.pe||‘N/A’)+‘x<br><br>’+(sym.changePercent>0?‘Showing positive momentum. ‘:‘Facing headwinds. ‘)+‘Consider checking the Analysis tab for detailed technicals.’;}
if(ql.indexOf(‘best’)>=0||ql.indexOf(‘top’)>=0||ql.indexOf(‘recommend’)>=0){var sorted=state.stocks.slice().sort(function(a,b){return b.score-a.score;}).slice(0,5);return ‘Top stocks by score:<br><br>’+sorted.map(function(s,i){return (i+1)+’. <strong>’+s.symbol+’</strong> — Score: ‘+s.score+’ | $’+s.price.toFixed(2)+’ (’+(s.changePercent>=0?’+’:’’)+s.changePercent.toFixed(2)+’%)’;}).join(’<br>’);}
if(ql.indexOf(‘portfolio’)>=0||ql.indexOf(‘how’)>=0){var tv=0,tc=0;state.stocks.forEach(function(s){tv+=s.price;tc+=s.change;});var tp=tv?tc/tv*100:0;return ‘Portfolio overview:<br><br>Total value: <strong>$’+tv.toFixed(2)+’</strong><br>Change: ‘+(tp>=0?’+’:’’)+tp.toFixed(2)+’%<br>Stocks: ‘+state.stocks.length+’<br><br>’+(tp>0?‘Portfolio is in positive territory today.’:‘Portfolio is down today. Consider reviewing your positions.’);}
return ‘I can help with stock analysis. Try asking about a specific ticker (e.g. “Tell me about NVDA”), or ask for “top stocks”, “portfolio review”, or any market question.’;}

/* ═══ AI MARKET BRIEF ═══ */
function renderAIBrief(fc){
fc.innerHTML=’<div class="section-card"><div class="section-label">Daily Market Brief</div><div id="aiBriefContent"><div class="ai-typing">Generating market brief…</div></div></div>’;
callClaude(‘Generate a concise daily market brief. Cover: 1) Overall market sentiment 2) Key movers 3) Sectors to watch 4) Key risk events. Be actionable and concise.’,function(resp,err){
var el=document.getElementById(‘aiBriefContent’);if(!el)return;
if(resp){el.innerHTML=’<div class="ai-msg-ai">’+resp.replace(/\n/g,’<br>’)+’</div>’;return;}
/* Algorithmic brief */
var gainers=state.stocks.slice().sort(function(a,b){return b.changePercent-a.changePercent;});
var losers=state.stocks.slice().sort(function(a,b){return a.changePercent-b.changePercent;});
var avgChg=0;state.stocks.forEach(function(s){avgChg+=s.changePercent;});avgChg=state.stocks.length?avgChg/state.stocks.length:0;
var sentiment=avgChg>0.5?‘Bullish’:avgChg<-0.5?‘Bearish’:‘Mixed’;
el.innerHTML=’<div class="ai-result-card"><div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:12px">Market Sentiment: <span style="color:'+(avgChg>=0?'#10b981':'#ef4444')+'">’+sentiment+’</span></div><div style="font-size:14px;color:#94a3b8;line-height:1.8">Average portfolio change: <strong>’+(avgChg>=0?’+’:’’)+avgChg.toFixed(2)+’%</strong><br><br><strong>Top Gainer:</strong> ‘+gainers[0].symbol+’ (’+(gainers[0].changePercent>=0?’+’:’’)+gainers[0].changePercent.toFixed(2)+’%)<br><strong>Top Loser:</strong> ‘+losers[0].symbol+’ (’+losers[0].changePercent.toFixed(2)+’%)<br><br>’+(state.trendingStocks.length?’<strong>Trending:</strong> ‘+state.trendingStocks.slice(0,5).map(function(s){return s.symbol;}).join(’, ‘):’’)+’<br><br><strong>Recommendation:</strong> ‘+(avgChg>1?‘Markets showing strength. Look for pullback entries on quality names.’:avgChg<-1?‘Defensive posture recommended. Consider tightening stops.’:‘Choppy market. Be selective, focus on highest-conviction setups.’)+’</div></div>’;
});
}

/* ═══ AI TRADE IDEAS ═══ */
function renderAIIdeas(fc){
fc.innerHTML=’<div class="section-card"><div class="section-label">AI Trade Ideas</div><div id="aiIdeasContent"><div class="ai-typing">Generating trade ideas…</div></div></div>’;
callClaude(‘Based on the portfolio data, generate 3 specific trade ideas with entry price, target price, stop loss, and brief reasoning. Format clearly.’,function(resp,err){
var el=document.getElementById(‘aiIdeasContent’);if(!el)return;
if(resp){el.innerHTML=’<div class="ai-msg-ai">’+resp.replace(/\n/g,’<br>’)+’</div>’;return;}
var sorted=state.stocks.slice().sort(function(a,b){return b.score-a.score;});
var ideas=sorted.slice(0,3).map(function(s){var a=genAnalysis(s);return ‘<div class="ai-trade-idea"><div><span class="ai-trade-sym">’+s.symbol+’</span><span class="ai-trade-signal '+a.sc+'" style="background:'+(a.sc.indexOf('buy')>=0?'rgba(16,185,129,0.12)':'rgba(245,158,11,0.12)')+'">’+a.sig+’</span></div><div class="metric-grid" style="margin-top:12px"><div><div class="metric-label">Entry</div><div class="metric-value action-entry" style="font-size:15px">$’+a.sup+’</div></div><div><div class="metric-label">Target</div><div class="metric-value action-target" style="font-size:15px">$’+a.res+’</div></div><div><div class="metric-label">Stop</div><div class="metric-value action-stop" style="font-size:15px">$’+a.sl+’</div></div><div><div class="metric-label">R/R</div><div class="metric-value" style="font-size:15px">’+a.rr+’:1</div></div></div><p class="analysis-text mt-sm">’+s.symbol+’ shows ‘+a.tr.toLowerCase()+’. RSI at ‘+a.rsi.toFixed(0)+’ with ‘+a.ms.toLowerCase()+’ MACD. ‘+(a.rsi<30?‘Oversold bounce potential.’:a.rsi>70?‘Extended — wait for pullback.’:‘Momentum supports entry.’)+’</p></div>’;}).join(’’);
el.innerHTML=ideas;
});
}

/* ═══ AI PORTFOLIO REVIEW ═══ */
function renderAIReview(fc){
fc.innerHTML=’<div class="section-card"><div class="section-label">Portfolio Review</div><div id="aiReviewContent"><div class="ai-typing">Analyzing portfolio…</div></div></div>’;
callClaude(‘Provide a comprehensive portfolio review. Cover: diversification, risk concentration, sector allocation, overweight/underweight positions, and specific recommendations to improve the portfolio.’,function(resp,err){
var el=document.getElementById(‘aiReviewContent’);if(!el)return;
if(resp){el.innerHTML=’<div class="ai-msg-ai">’+resp.replace(/\n/g,’<br>’)+’</div>’;return;}
/* Algorithmic review */
var sectors={};var totalMC=0;var buys=0,holds=0,sells=0;
state.stocks.forEach(function(s){sectors[s.sector]=(sectors[s.sector]||0)+1;totalMC+=s.marketCap;var sig=computeSignal(s);if(sig.key.indexOf(‘buy’)>=0)buys++;else if(sig.key===‘hold’)holds++;else sells++;});
var sectorList=Object.keys(sectors).map(function(k){return k+’: ‘+sectors[k];}).join(’, ‘);
var concentration=Object.keys(sectors).length;
el.innerHTML=’<div class="ai-result-card"><div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:16px">Portfolio Health Score</div><div style="text-align:center;margin:16px 0"><span style="font-size:48px;font-weight:700;color:'+(concentration>=3?'#10b981':'#f59e0b')+'">’+Math.min(95,60+concentration*8)+’</span><span style="font-size:16px;color:#64748b">/100</span></div><div class="metric-grid" style="margin:16px 0"><div><div class="metric-label">Sectors</div><div class="metric-value">’+concentration+’</div></div><div><div class="metric-label">Stocks</div><div class="metric-value">’+state.stocks.length+’</div></div><div><div class="metric-label">Buy Signals</div><div class="metric-value positive">’+buys+’</div></div><div><div class="metric-label">Sell Signals</div><div class="metric-value negative">’+sells+’</div></div></div><p class="analysis-text" style="margin-top:12px"><strong>Allocation:</strong> ‘+sectorList+’<br><br><strong>Assessment:</strong> ‘+(concentration<3?‘Portfolio is concentrated. Consider diversifying across more sectors.’:concentration>=5?‘Well diversified across sectors.’:‘Moderate diversification.’)+’<br><br>’+(sells>buys?’<strong>Warning:</strong> More sell signals than buy signals. Consider reviewing weaker positions.’:’<strong>Positive:</strong> More buy signals. Portfolio momentum looks healthy.’)+’</p></div>’;
});
}

/* ═══ AI PATTERN RECOGNITION ═══ */
function renderAIPatterns(fc){
fc.innerHTML=’<div class="section-card"><div class="section-label">Pattern Recognition</div><select class="analysis-stock-select" id="patternSel" onchange="detectPatterns()">’+state.stocks.map(function(s){return ‘<option value="'+s.symbol+'">’+s.symbol+’</option>’;}).join(’’)+’</select><div id="patternContent"><div class="ai-typing">Scanning patterns…</div></div></div>’;
detectPatterns();
}
function detectPatterns(){
var sym=(document.getElementById(‘patternSel’)||{}).value||state.stocks[0].symbol;
var el=document.getElementById(‘patternContent’);if(!el)return;
var s=findStock(sym);if(!s){el.innerHTML=’<p class="analysis-text">No data.</p>’;return;}
callClaude(‘Analyze ‘+sym+’ at $’+s.price.toFixed(2)+’ with change ‘+s.changePercent.toFixed(2)+’%. Identify any chart patterns (head and shoulders, double bottom, wedge, flag, triangle, cup and handle). Be specific about pattern stage and implications.’,function(resp){
if(resp){el.innerHTML=’<div class="ai-msg-ai">’+resp.replace(/\n/g,’<br>’)+’</div>’;return;}
/* Algorithmic pattern detection */
var cp=s.changePercent;var patterns=[];
if(cp>0&&cp<2)patterns.push({name:‘Ascending Channel’,confidence:72,bias:‘Bullish’,desc:‘Price trending higher within a defined channel. Watch for breakout above resistance.’});
if(cp>3)patterns.push({name:‘Momentum Breakout’,confidence:68,bias:‘Bullish’,desc:‘Strong move above recent range. Volume confirmation needed for continuation.’});
if(cp<-1&&cp>-3)patterns.push({name:‘Pullback to Support’,confidence:65,bias:‘Neutral’,desc:‘Testing support level after recent move. Watch for bounce or breakdown.’});
if(cp<-3)patterns.push({name:‘Breakdown Pattern’,confidence:70,bias:‘Bearish’,desc:‘Breaking below key support. Wait for stabilization before entry.’});
if(Math.abs(cp)<0.5)patterns.push({name:‘Consolidation/Triangle’,confidence:60,bias:‘Neutral’,desc:‘Price compressing in tight range. Breakout direction will determine next move.’});
if(!patterns.length)patterns.push({name:‘No Clear Pattern’,confidence:40,bias:‘Neutral’,desc:‘No recognizable pattern detected at current price levels.’});
el.innerHTML=patterns.map(function(p){return ‘<div class="ai-result-card" style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:16px;font-weight:700;color:#fff">’+p.name+’</span><span style="font-family:monospace;font-size:13px;color:'+(p.bias==='Bullish'?'#10b981':p.bias==='Bearish'?'#ef4444':'#f59e0b')+'">’+p.bias+’</span></div><div class="risk-bar-track" style="margin:8px 0"><div class="risk-bar-fill" style="width:'+p.confidence+'%;background-color:#8b5cf6"></div></div><div style="display:flex;justify-content:space-between;font-size:11px;color:#64748b"><span>Confidence</span><span>’+p.confidence+’%</span></div><p class="analysis-text mt-sm">’+p.desc+’</p></div>’;}).join(’’);
});
}

/* ═══ AI SENTIMENT DIGEST ═══ */
function renderAISentiment(fc){
fc.innerHTML=’<div class="section-card"><div class="section-label">Sentiment Digest</div><div id="sentContent"><div class="ai-typing">Analyzing sentiment…</div></div></div>’;
var analyzed=0;var results=[];
state.stocks.slice(0,10).forEach(function(s){
fetchNews(s.symbol).then(function(news){
var bull=0,bear=0;news.forEach(function(n){var sn=sentiment(n.headline);if(sn.c===‘bullish’)bull++;else if(sn.c===‘bearish’)bear++;});
results.push({symbol:s.symbol,bull:bull,bear:bear,total:news.length,score:bull-bear});
analyzed++;
if(analyzed>=Math.min(state.stocks.length,10)){
results.sort(function(a,b){return b.score-a.score;});
var el=document.getElementById(‘sentContent’);if(!el)return;
var totalBull=0,totalBear=0;results.forEach(function(r){totalBull+=r.bull;totalBear+=r.bear;});
var overall=totalBull>totalBear?‘Bullish’:totalBull<totalBear?‘Bearish’:‘Neutral’;
el.innerHTML=’<div class="ai-result-card" style="text-align:center;margin-bottom:16px"><div style="font-size:14px;color:#64748b;margin-bottom:4px">Overall Sentiment</div><div style="font-size:28px;font-weight:700;color:'+(overall==='Bullish'?'#10b981':overall==='Bearish'?'#ef4444':'#f59e0b')+'">’+overall+’</div><div style="font-size:13px;color:#94a3b8;margin-top:8px">’+totalBull+’ bullish / ‘+totalBear+’ bearish signals</div></div>’+results.map(function(r){return ‘<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.04)"><span style="font-family:monospace;font-weight:700;color:#fff">’+r.symbol+’</span><div><span class="positive" style="margin-right:12px">▲ ‘+r.bull+’</span><span class="negative">▼ ‘+r.bear+’</span></div></div>’;}).join(’’);
}
});
});
}

/* ═══ AI SIMILAR STOCKS ═══ */
function renderAISimilar(fc){
fc.innerHTML=’<div class="section-card"><div class="section-label">Stocks Like Yours</div><select class="analysis-stock-select" id="simSel" onchange="findSimilar()">’+state.stocks.map(function(s){return ‘<option value="'+s.symbol+'">’+s.symbol+’ - ‘+s.name+’</option>’;}).join(’’)+’</select><div id="simContent"><div class="ai-typing">Finding similar stocks…</div></div></div>’;
findSimilar();
}
function findSimilar(){
var sym=(document.getElementById(‘simSel’)||{}).value||state.stocks[0].symbol;
var el=document.getElementById(‘simContent’);if(!el)return;
var s=findStock(sym);if(!s){el.innerHTML=’<p class="analysis-text">No data.</p>’;return;}
fmpFetch(’/stock-screener?marketCapMoreThan=’+Math.max(1e9,(s.marketCap||1e9)*0.3)+’&marketCapLowerThan=’+((s.marketCap||50e9)*3)+’&limit=10’).then(function(d){
if(!d||!Array.isArray(d)||!d.length){el.innerHTML=’<p class="analysis-text">No similar stocks found.</p>’;return;}
var filtered=d.filter(function(r){return r.symbol!==sym&&r.symbol.indexOf(’.’)<0;}).slice(0,6);
el.innerHTML=filtered.map(function(r){return ‘<div class="stock-card" style="margin-bottom:8px;padding:16px" onclick="addStock(\''+r.symbol+'\',\''+(r.companyName||r.symbol).replace(/'/g,'')+'\')">’+’<div class="stock-header"><div><div class="stock-symbol">’+r.symbol+’</div><div class="stock-name">’+(r.companyName||’’)+’</div></div><div style="text-align:right"><div style="font-family:monospace;font-weight:700;color:#94a3b8">$’+(r.price||0).toFixed(2)+’</div><div class="search-result-add" style="margin-top:4px">+ Add</div></div></div></div>’;}).join(’’);
});
}

/* ═══ AI RISK REPORT ═══ */
function renderAIRisk(fc){
fc.innerHTML=’<div class="section-card"><div class="section-label">Risk Report</div><div id="riskContent"><div class="ai-typing">Calculating risk…</div></div></div>’;
callClaude(‘Analyze portfolio risk. Cover: concentration risk, sector exposure, correlation risk, maximum drawdown potential, and hedging suggestions. Be specific.’,function(resp){
var el=document.getElementById(‘riskContent’);if(!el)return;
if(resp){el.innerHTML=’<div class="ai-msg-ai">’+resp.replace(/\n/g,’<br>’)+’</div>’;return;}
var sectors={};var maxExp=0;var maxSym=’’;
state.stocks.forEach(function(s){sectors[s.sector]=(sectors[s.sector]||0)+s.marketCap;if(s.marketCap>maxExp){maxExp=s.marketCap;maxSym=s.symbol;}});
var sectorCount=Object.keys(sectors).length;
var concRisk=sectorCount<=2?‘High’:sectorCount<=4?‘Medium’:‘Low’;
var avgVol=0;state.stocks.forEach(function(s){avgVol+=Math.abs(s.changePercent);});avgVol=state.stocks.length?avgVol/state.stocks.length:0;
var overallRisk=avgVol>3?85:avgVol>1.5?55:30;
el.innerHTML=’<div class="ai-result-card" style="text-align:center;margin-bottom:16px"><div style="font-size:14px;color:#64748b">Overall Risk Level</div><div style="font-size:48px;font-weight:700;color:'+(overallRisk>65?'#ef4444':overallRisk>40?'#f59e0b':'#10b981')+'">’+overallRisk+’<span style="font-size:20px">/100</span></div></div><div class="metric-grid"><div><div class="metric-label">Concentration</div><div class="metric-value" style="color:'+(concRisk==='High'?'#ef4444':'#f59e0b')+'">’+concRisk+’</div></div><div><div class="metric-label">Sectors</div><div class="metric-value">’+sectorCount+’</div></div><div><div class="metric-label">Avg Volatility</div><div class="metric-value">’+avgVol.toFixed(1)+’%</div></div><div><div class="metric-label">Largest Position</div><div class="metric-value" style="font-size:14px">’+maxSym+’</div></div></div><div style="margin-top:16px"><div class="metric-label" style="margin-bottom:8px">Suggestions</div><p class="analysis-text">’+(sectorCount<3?’⚠ Add positions in different sectors to reduce concentration risk.<br>’:’✓ Decent sector diversification.<br>’)+(avgVol>2?’⚠ High average volatility. Consider reducing position sizes.<br>’:’✓ Volatility within normal range.<br>’)+’• Consider hedging with inverse ETFs or options during uncertain markets.</p></div>’;
});
}
</script></body></html>
