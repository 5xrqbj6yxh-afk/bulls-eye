<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bull's Eye">
    <meta name="theme-color" content="#070710">
    <title>Bull's Eye Pro v8.0</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
/* ============================
   THEME VARIABLES
============================ */
:root {
    --bg-void: #070710;
    --bg-base: #0d0d1a;
    --bg-surface: #141425;
    --bg-raised: #1b1b30;
    --bg-overlay: #22223a;
    --neon-green: #00ffa3;
    --neon-cyan: #00d4ff;
    --neon-red: #ff3366;
    --neon-amber: #ffb800;
    --neon-purple: #bf7fff;
    --neon-blue: #4d9fff;
    --text-bright: #f0f0ff;
    --text-main: #c8c8e0;
    --text-dim: #7070a0;
    --text-ghost: #404060;
    --border-subtle: rgba(255,255,255,0.06);
    --border-mid: rgba(255,255,255,0.10);
    --glow-green: rgba(0,255,163,0.25);
    --glow-red: rgba(255,51,102,0.25);
    --skeleton-base: #1b1b30;
    --skeleton-shine: #252540;
    --radius-sm: 10px;
    --radius-md: 16px;
    --radius-lg: 22px;
    --radius-xl: 28px;
}
[data-theme="light"] {
    --bg-void: #f0f2f8;
    --bg-base: #e8eaf4;
    --bg-surface: #ffffff;
    --bg-raised: #f5f6fc;
    --bg-overlay: #eceef8;
    --text-bright: #0d0d2a;
    --text-main: #2a2a50;
    --text-dim: #6060a0;
    --text-ghost: #a0a0c0;
    --border-subtle: rgba(0,0,50,0.08);
    --border-mid: rgba(0,0,50,0.14);
    --skeleton-base: #e0e2f0;
    --skeleton-shine: #f0f2fc;
    --neon-green: #00b070;
    --neon-cyan: #008fcc;
    --neon-red: #cc1144;
    --neon-amber: #cc8800;
    --neon-purple: #7733cc;
    --neon-blue: #2266cc;
    --glow-green: rgba(0,176,112,0.15);
    --glow-red: rgba(204,17,68,0.15);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:'DM Sans',sans-serif; background:var(--bg-void); color:var(--text-main); overflow-x:hidden; -webkit-font-smoothing:antialiased; min-height:100vh; transition:background 0.35s, color 0.35s; }

/* ambient */
.bg-ambient { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
.bg-ambient::before { content:''; position:absolute; top:-30%; left:-20%; width:60%; height:60%; background:radial-gradient(ellipse,rgba(0,255,163,0.04) 0%,transparent 70%); animation:drift1 18s ease-in-out infinite; }
.bg-ambient::after { content:''; position:absolute; bottom:-20%; right:-20%; width:55%; height:55%; background:radial-gradient(ellipse,rgba(0,212,255,0.04) 0%,transparent 70%); animation:drift2 22s ease-in-out infinite; }
[data-theme="light"] .bg-ambient::before, [data-theme="light"] .bg-ambient::after { display:none; }
@keyframes drift1 { 0%,100%{transform:translate(0,0)} 50%{transform:translate(8%,6%)} }
@keyframes drift2 { 0%,100%{transform:translate(0,0)} 50%{transform:translate(-6%,-8%)} }

.app-wrap { max-width:430px; margin:0 auto; position:relative; z-index:1; padding-bottom:90px; }

/* ============================
   HEADER
============================ */
.header { position:sticky; top:0; z-index:90; background:linear-gradient(180deg,var(--bg-void) 0%,rgba(7,7,16,0.92) 100%); backdrop-filter:blur(24px) saturate(180%); -webkit-backdrop-filter:blur(24px) saturate(180%); border-bottom:1px solid var(--border-subtle); padding:max(env(safe-area-inset-top),16px) 20px 0; transition:background 0.35s; }
[data-theme="light"] .header { background:linear-gradient(180deg,var(--bg-void) 0%,rgba(240,242,248,0.95) 100%); }
.header-top { display:flex; justify-content:space-between; align-items:center; padding-bottom:14px; }
.logo { display:flex; align-items:center; gap:10px; }
.logo-mark { width:34px; height:34px; background:linear-gradient(145deg,var(--neon-green),var(--neon-cyan)); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; box-shadow:0 0 16px var(--glow-green),0 4px 12px rgba(0,0,0,0.4); animation:logoGlow 3s ease-in-out infinite; }
@keyframes logoGlow { 0%,100%{box-shadow:0 0 16px var(--glow-green),0 4px 12px rgba(0,0,0,0.3)} 50%{box-shadow:0 0 28px rgba(0,255,163,0.5),0 4px 12px rgba(0,0,0,0.3)} }
.logo-name { display:flex; flex-direction:column; }
.logo-title { font-family:'IBM Plex Mono',monospace; font-weight:700; font-size:17px; background:linear-gradient(90deg,var(--neon-green) 0%,var(--neon-cyan) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; letter-spacing:-0.3px; line-height:1; }
.logo-ver { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--text-ghost); letter-spacing:1px; }
.header-btns { display:flex; gap:6px; }
.hbtn { width:36px; height:36px; border-radius:var(--radius-sm); background:var(--bg-raised); border:1px solid var(--border-subtle); display:flex; align-items:center; justify-content:center; font-size:16px; cursor:pointer; position:relative; transition:transform 0.15s cubic-bezier(.4,0,.2,1), background 0.2s; }
.hbtn:active { transform:scale(0.88); background:var(--bg-overlay); }
.hbtn .dot { position:absolute; top:4px; right:4px; width:7px; height:7px; background:var(--neon-red); border-radius:50%; border:1.5px solid var(--bg-void); animation:dotPulse 2s ease-in-out infinite; }
@keyframes dotPulse { 0%,100%{box-shadow:0 0 0 0 var(--glow-red)} 50%{box-shadow:0 0 0 4px rgba(255,51,102,0)} }

/* stat pills */
.stat-row { display:flex; gap:8px; padding:0 0 16px 0; overflow-x:auto; scrollbar-width:none; }
.stat-row::-webkit-scrollbar { display:none; }
.stat-pill { flex-shrink:0; background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:10px 14px; min-width:88px; position:relative; overflow:hidden; transition:background 0.35s; }
.stat-pill::after { content:''; position:absolute; inset:0; background:linear-gradient(145deg,rgba(255,255,255,0.03) 0%,transparent 60%); pointer-events:none; }
.sp-label { font-size:10px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.8px; font-weight:700; margin-bottom:5px; }
.sp-value { font-family:'IBM Plex Mono',monospace; font-size:22px; font-weight:700; color:var(--text-bright); line-height:1; transition:color 0.3s; }

/* ============================
   SKELETON LOADER
============================ */
@keyframes shimmer { 0%{background-position:-400px 0} 100%{background-position:400px 0} }
.skeleton { background:linear-gradient(90deg,var(--skeleton-base) 25%,var(--skeleton-shine) 50%,var(--skeleton-base) 75%); background-size:800px 100%; animation:shimmer 1.4s ease-in-out infinite; border-radius:6px; }
.skel-card { background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-xl); padding:20px; margin-bottom:16px; }
.skel-row { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:18px; }
.skel-title { width:120px; height:30px; }
.skel-score { width:70px; height:60px; border-radius:8px; }
.skel-bar { height:8px; margin-bottom:10px; border-radius:4px; }
.skel-chart { height:120px; border-radius:var(--radius-md); margin-bottom:14px; }
.skel-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:14px; }
.skel-metric { height:60px; border-radius:var(--radius-sm); }

/* ============================
   NUMBER COUNTER FLASH
============================ */
@keyframes numFlash { 0%{background:rgba(0,255,163,0.18);transform:scale(1.08)} 100%{background:transparent;transform:scale(1)} }
.flash { animation:numFlash 0.5s cubic-bezier(.4,0,.2,1) forwards; border-radius:4px; }
@keyframes numFlashRed { 0%{background:rgba(255,51,102,0.18);transform:scale(1.08)} 100%{background:transparent;transform:scale(1)} }
.flash-red { animation:numFlashRed 0.5s cubic-bezier(.4,0,.2,1) forwards; border-radius:4px; }

/* ============================
   SWIPE CARDS
============================ */
.swipe-wrap { position:relative; touch-action:pan-y; overflow:hidden; border-radius:var(--radius-xl); margin-bottom:16px; }
.swipe-hint-watch { position:absolute; left:0; top:0; bottom:0; width:80px; display:flex; align-items:center; justify-content:center; background:rgba(0,255,163,0.12); border-radius:var(--radius-xl) 0 0 var(--radius-xl); font-size:28px; opacity:0; transition:opacity 0.15s; pointer-events:none; z-index:2; }
.swipe-hint-trade { position:absolute; right:0; top:0; bottom:0; width:80px; display:flex; align-items:center; justify-content:center; background:rgba(0,212,255,0.12); border-radius:0 var(--radius-xl) var(--radius-xl) 0; font-size:28px; opacity:0; transition:opacity 0.15s; pointer-events:none; z-index:2; }
.swipe-card-inner { transition:transform 0.12s ease; will-change:transform; }

/* ============================
   ACTIONS / TABS
============================ */
.action-zone { padding:16px 20px 12px; }
.analyze-btn { width:100%; padding:17px; background:linear-gradient(135deg,var(--neon-green) 0%,var(--neon-cyan) 100%); border:none; border-radius:var(--radius-lg); font-family:'IBM Plex Mono',monospace; font-size:15px; font-weight:700; color:var(--bg-void); cursor:pointer; position:relative; overflow:hidden; box-shadow:0 6px 24px var(--glow-green),0 2px 8px rgba(0,0,0,0.4); transition:transform 0.2s cubic-bezier(.34,1.56,.64,1), box-shadow 0.2s; letter-spacing:0.5px; }
.analyze-btn:active { transform:scale(0.97); box-shadow:0 2px 12px var(--glow-green); }
.analyze-btn.scanning { background:var(--bg-raised); color:var(--neon-green); box-shadow:none; border:1px solid rgba(0,255,163,0.2); }
.scan-progress { position:absolute; bottom:0; left:0; height:2px; background:linear-gradient(90deg,var(--neon-green),var(--neon-cyan)); border-radius:1px; width:0%; transition:width 0.3s ease; }
.chips-row { padding:0 20px 14px; display:flex; gap:8px; overflow-x:auto; scrollbar-width:none; }
.chips-row::-webkit-scrollbar { display:none; }
.chip { flex-shrink:0; background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:20px; padding:7px 15px; font-size:12px; font-weight:700; color:var(--text-dim); cursor:pointer; transition:all 0.2s cubic-bezier(.4,0,.2,1); }
.chip:active { transform:scale(0.93); }
.chip.on { background:rgba(0,255,163,0.1); border-color:rgba(0,255,163,0.38); color:var(--neon-green); box-shadow:0 0 12px rgba(0,255,163,0.08); }
.sort-row { padding:0 20px 14px; display:flex; gap:8px; align-items:center; }
.sort-label { font-size:11px; color:var(--text-ghost); font-weight:700; white-space:nowrap; }
.sort-select { background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:7px 12px; font-size:12px; font-weight:600; color:var(--text-main); font-family:'DM Sans',sans-serif; flex:1; }
select:focus { outline:none; }
.tab-bar { margin:0 20px 16px; background:var(--bg-surface); border-radius:var(--radius-md); padding:4px; display:flex; gap:3px; border:1px solid var(--border-subtle); }
.tab { flex:1; background:transparent; border:none; border-radius:12px; padding:11px 4px; font-size:11px; font-weight:700; color:var(--text-ghost); cursor:pointer; transition:all 0.25s cubic-bezier(.4,0,.2,1); letter-spacing:0.1px; }
.tab.on { background:var(--bg-overlay); color:var(--text-bright); box-shadow:0 2px 12px rgba(0,0,0,0.4); }
.tab:active { transform:scale(0.95); }
.pane { display:none; animation:paneIn 0.3s cubic-bezier(.4,0,.2,1); }
.pane.on { display:block; }
@keyframes paneIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

/* ============================
   MACRO PANEL
============================ */
.macro-panel { margin:0 20px 16px; background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px; }
.macro-title { font-size:10px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:1px; font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:6px; }
.macro-live { width:6px; height:6px; background:var(--neon-green); border-radius:50%; animation:dotPulse 2s infinite; }
.macro-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
.macro-item { background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:10px 8px; text-align:center; }
.macro-lbl { font-size:9px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.5px; font-weight:700; margin-bottom:4px; }
.macro-val { font-family:'IBM Plex Mono',monospace; font-size:15px; font-weight:700; line-height:1; }
.macro-chg { font-size:10px; font-weight:600; margin-top:3px; }

/* ============================
   BRIEFING SCREEN
============================ */
.briefing-overlay { position:fixed; inset:0; z-index:200; background:var(--bg-void); display:none; flex-direction:column; padding:max(env(safe-area-inset-top),24px) 20px 24px; animation:paneIn 0.4s ease; overflow-y:auto; }
.briefing-overlay.on { display:flex; }
.briefing-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
.briefing-date { font-family:'IBM Plex Mono',monospace; font-size:11px; color:var(--text-ghost); letter-spacing:1px; }
.briefing-close { width:36px; height:36px; background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; }
.briefing-close:active { transform:scale(0.9); }
.briefing-title { font-size:28px; font-weight:800; color:var(--text-bright); line-height:1.2; margin-bottom:4px; }
.briefing-sub { font-size:14px; color:var(--text-dim); margin-bottom:24px; }
.briefing-pick { background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-lg); padding:20px; margin-bottom:14px; position:relative; overflow:hidden; }
.bp-rank { position:absolute; top:0; right:0; background:linear-gradient(135deg,var(--neon-green),var(--neon-cyan)); color:var(--bg-void); font-family:'IBM Plex Mono',monospace; font-size:11px; font-weight:700; padding:6px 12px; border-radius:0 var(--radius-lg) 0 var(--radius-sm); }
.bp-ticker { font-family:'IBM Plex Mono',monospace; font-size:26px; font-weight:700; color:var(--text-bright); margin-bottom:4px; }
.bp-name { font-size:13px; color:var(--text-dim); margin-bottom:14px; }
.bp-row { display:flex; gap:10px; margin-bottom:12px; }
.bp-stat { background:var(--bg-raised); border-radius:var(--radius-sm); padding:10px 12px; flex:1; }
.bp-stat-lbl { font-size:9px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.5px; font-weight:700; margin-bottom:4px; }
.bp-stat-val { font-family:'IBM Plex Mono',monospace; font-size:18px; font-weight:700; color:var(--text-bright); }
.bp-summary { font-size:13px; color:var(--text-dim); line-height:1.6; }
.briefing-actions { display:flex; gap:8px; margin-top:20px; }
.briefing-btn { flex:1; padding:14px; border:none; border-radius:var(--radius-md); font-size:14px; font-weight:700; cursor:pointer; }
.briefing-btn.primary { background:linear-gradient(135deg,var(--neon-green),var(--neon-cyan)); color:var(--bg-void); }
.briefing-btn.secondary { background:var(--bg-raised); color:var(--text-main); border:1px solid var(--border-subtle); }

/* ============================
   STOCK CARD
============================ */
.stock-list { padding:0 20px; }
.stock-card { background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-xl); overflow:hidden; transition:box-shadow 0.3s; }
.stock-card.top-pick { border-color:rgba(0,255,163,0.18); box-shadow:0 0 0 1px rgba(0,255,163,0.08),0 8px 32px rgba(0,0,0,0.4); }
.card-top-bar { height:3px; background:linear-gradient(90deg,var(--neon-green),var(--neon-cyan),var(--neon-purple)); opacity:0; transition:opacity 0.3s; }
.top-pick .card-top-bar { opacity:1; }
.card-inner { padding:20px; }
.card-head { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:18px; }
.rank-tag { display:inline-flex; align-items:center; gap:5px; background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:8px; padding:4px 8px; font-family:'IBM Plex Mono',monospace; font-size:11px; font-weight:700; color:var(--text-dim); margin-bottom:10px; }
.rank-tag.gold { background:rgba(255,184,0,0.12); border-color:rgba(255,184,0,0.3); color:var(--neon-amber); }
.rank-tag.silver { background:rgba(160,160,200,0.12); border-color:rgba(160,160,200,0.3); color:#a0a0c8; }
.rank-tag.bronze { background:rgba(205,127,50,0.12); border-color:rgba(205,127,50,0.3); color:#cd7f32; }
.card-ticker { font-family:'IBM Plex Mono',monospace; font-size:28px; font-weight:700; color:var(--text-bright); letter-spacing:-1px; line-height:1; margin-bottom:5px; }
.card-name { font-size:12px; color:var(--text-dim); margin-bottom:10px; }
.tag-row { display:flex; gap:5px; flex-wrap:wrap; }
.tag { font-size:10px; font-weight:700; padding:3px 8px; border-radius:6px; letter-spacing:0.3px; text-transform:uppercase; }
.tag-sector { background:rgba(191,127,255,0.12); color:var(--neon-purple); border:1px solid rgba(191,127,255,0.25); }
.tag-date { background:rgba(77,159,255,0.12); color:var(--neon-blue); border:1px solid rgba(77,159,255,0.25); }
.tag-time { background:rgba(255,184,0,0.12); color:var(--neon-amber); border:1px solid rgba(255,184,0,0.25); }
.card-right { text-align:right; }
.main-score { font-family:'IBM Plex Mono',monospace; font-size:52px; font-weight:700; line-height:1; background:linear-gradient(160deg,var(--neon-green) 0%,var(--neon-cyan) 60%,var(--neon-purple) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:6px; }
.score-row { display:flex; gap:5px; justify-content:flex-end; flex-wrap:wrap; }
.score-dot { font-family:'IBM Plex Mono',monospace; font-size:11px; color:var(--text-ghost); background:var(--bg-raised); padding:3px 7px; border-radius:6px; }

/* chart */
.chart-section { margin-bottom:18px; }
.chart-wrap { background:var(--bg-void); border:1px solid var(--border-subtle); border-radius:var(--radius-md); overflow:hidden; }
[data-theme="light"] .chart-wrap { background:var(--bg-raised); }
/* Big price header like the screenshot */
.chart-price-header { padding:14px 14px 6px; }
.cph-price { font-family:'IBM Plex Mono',monospace; font-size:32px; font-weight:700; color:var(--text-bright); line-height:1; letter-spacing:-1px; }
.cph-price sup { font-size:16px; font-weight:500; vertical-align:super; letter-spacing:0; }
.cph-change { font-size:14px; font-weight:700; margin-top:5px; display:flex; align-items:center; gap:4px; }
.cph-change .arr { font-size:16px; }
/* Main candle chart */
.chart-canvas-main { position:relative; height:200px; padding:0 14px 0 14px; }
/* RSI sub-panel */
.rsi-label { padding:6px 14px 2px; display:flex; justify-content:space-between; align-items:center; }
.rsi-title { font-family:'IBM Plex Mono',monospace; font-size:9px; color:var(--text-ghost); letter-spacing:0.5px; }
.rsi-val { font-family:'IBM Plex Mono',monospace; font-size:11px; font-weight:700; }
.chart-canvas-rsi { position:relative; height:56px; padding:0 14px; border-top:1px solid var(--border-subtle); }
/* Timeframe bar */
.tf-bar { display:flex; padding:10px 10px; gap:2px; border-top:1px solid var(--border-subtle); }
.tf-btn { flex:1; background:transparent; border:none; border-radius:20px; padding:8px 4px; font-family:'IBM Plex Mono',monospace; font-size:12px; font-weight:700; color:var(--text-ghost); cursor:pointer; transition:all 0.2s cubic-bezier(.4,0,.2,1); }
.tf-btn:active { transform:scale(0.88); }
.tf-btn.on { background:var(--bg-overlay); color:var(--text-bright); box-shadow:0 2px 8px rgba(0,0,0,0.3); }
/* chart indicator toggles */
.chart-ind-row { display:flex; gap:5px; padding:8px 14px 4px; }
.ind-chip { font-family:'IBM Plex Mono',monospace; font-size:9px; font-weight:700; padding:3px 8px; border-radius:4px; cursor:pointer; border:1px solid transparent; transition:all 0.15s; }
.ind-chip.ma20 { color:#ffb800; border-color:rgba(255,184,0,0.3); background:rgba(255,184,0,0.08); }
.ind-chip.ma50 { color:#4d9fff; border-color:rgba(77,159,255,0.3); background:rgba(77,159,255,0.08); }
.ind-chip.vwap { color:#bf7fff; border-color:rgba(191,127,255,0.3); background:rgba(191,127,255,0.08); }
.ind-chip.bb { color:#00d4ff; border-color:rgba(0,212,255,0.3); background:rgba(0,212,255,0.08); }
.ind-chip.off { opacity:0.35; }
/* stats row below chart */
.chart-stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:0; border-top:1px solid var(--border-subtle); }
.csr-item { padding:10px 10px; }
.csr-item:not(:last-child) { border-right:1px solid var(--border-subtle); }
.csr-label { font-size:9px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.5px; font-weight:700; margin-bottom:3px; }
.csr-value { font-family:'IBM Plex Mono',monospace; font-size:13px; font-weight:700; color:var(--text-bright); }
.csr-sub { font-size:10px; font-weight:600; margin-top:1px; }
/* legacy alias */
.chart-overlay-stats { display:none; }
.cos-item {} .cos-label {} .cos-value {} .cos-change {}

/* metrics */
.metrics-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:18px; }
.mbox { background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px; position:relative; overflow:hidden; }
.mbox::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:var(--accent-line,var(--neon-green)); opacity:0.5; }
.mbox.green { --accent-line:var(--neon-green); }
.mbox.red { --accent-line:var(--neon-red); }
.mbox.blue { --accent-line:var(--neon-blue); }
.mbox.amber { --accent-line:var(--neon-amber); }
.mbox.cyan { --accent-line:var(--neon-cyan); }
.mbox.purple { --accent-line:var(--neon-purple); }
.mbox-label { font-size:9px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.7px; font-weight:700; margin-bottom:6px; }
.mbox-value { font-family:'IBM Plex Mono',monospace; font-size:17px; font-weight:700; color:var(--text-bright); line-height:1; display:inline-block; }
.mbox-sub { font-size:10px; color:var(--text-ghost); margin-top:4px; }
.pos { color:var(--neon-green) !important; }
.neg { color:var(--neon-red) !important; }

/* score bars */
.score-bars { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:18px; }
.sbar-item { background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px; }
.sbar-label { font-size:10px; color:var(--text-ghost); font-weight:700; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
.sbar-track { height:5px; background:rgba(255,255,255,0.05); border-radius:3px; overflow:hidden; margin-bottom:6px; }
.sbar-fill { height:100%; background:linear-gradient(90deg,var(--neon-green),var(--neon-cyan)); border-radius:3px; width:0%; transition:width 1s cubic-bezier(.4,0,.2,1); }
.sbar-nums { display:flex; justify-content:space-between; align-items:center; }
.sbar-val { font-family:'IBM Plex Mono',monospace; font-size:15px; font-weight:700; color:var(--text-bright); }
.sbar-pct { font-size:10px; color:var(--text-ghost); }

/* news section */
.news-section { background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px; margin-bottom:18px; }
.news-title { font-size:11px; font-weight:700; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:12px; display:flex; align-items:center; gap:6px; }
.news-item { display:flex; gap:10px; padding:10px 0; border-bottom:1px solid var(--border-subtle); }
.news-item:last-child { border-bottom:none; padding-bottom:0; }
.news-sentiment { width:4px; border-radius:2px; flex-shrink:0; }
.news-body { flex:1; }
.news-headline { font-size:12px; font-weight:600; color:var(--text-main); line-height:1.4; margin-bottom:4px; }
.news-meta { display:flex; gap:8px; font-size:10px; color:var(--text-ghost); }
.news-source { font-weight:700; }

/* earnings call sentiment */
/* ── analyst predictions section ── */
.analyst-section { background:linear-gradient(145deg,rgba(77,159,255,0.07),rgba(0,212,255,0.03)); border:1px solid rgba(77,159,255,0.2); border-radius:var(--radius-md); padding:16px; margin-bottom:18px; }
.analyst-tag { font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700; color:var(--neon-blue); background:rgba(77,159,255,0.1); border:1px solid rgba(77,159,255,0.25); padding:4px 10px; border-radius:6px; letter-spacing:1px; text-transform:uppercase; display:inline-block; margin-bottom:14px; }
/* consensus bar */
.consensus-block { background:rgba(255,255,255,0.03); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px; margin-bottom:14px; }
.cb-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.cb-verdict { font-family:'IBM Plex Mono',monospace; font-size:16px; font-weight:700; }
.cb-count { font-size:11px; color:var(--text-ghost); }
.consensus-bar { display:flex; height:10px; border-radius:5px; overflow:hidden; gap:1px; margin-bottom:8px; }
.cb-sb { background:#00ffa3; flex-shrink:0; } .cb-b { background:#33cc88; flex-shrink:0; }
.cb-h { background:var(--neon-amber); flex-shrink:0; } .cb-s { background:#ff7799; flex-shrink:0; } .cb-ss { background:var(--neon-red); flex-shrink:0; }
.cb-legend { display:flex; gap:10px; flex-wrap:wrap; }
.cb-leg-item { display:flex; align-items:center; gap:4px; font-size:10px; color:var(--text-ghost); }
.cb-dot { width:8px; height:8px; border-radius:2px; flex-shrink:0; }
/* price target range */
.pt-block { background:rgba(255,255,255,0.03); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px; margin-bottom:14px; }
.pt-top { display:flex; justify-content:space-between; margin-bottom:10px; }
.pt-lbl { font-size:10px; color:var(--text-ghost); font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
.pt-nums { display:flex; gap:14px; }
.pt-num { text-align:center; }
.pt-num-val { font-family:'IBM Plex Mono',monospace; font-size:16px; font-weight:700; }
.pt-num-sub { font-size:9px; color:var(--text-ghost); text-transform:uppercase; margin-top:1px; }
.pt-track { position:relative; height:8px; background:rgba(255,255,255,0.06); border-radius:4px; margin:4px 0 8px; }
.pt-range-fill { position:absolute; height:100%; background:linear-gradient(90deg,var(--neon-green),var(--neon-cyan)); border-radius:4px; opacity:0.6; }
.pt-cur-marker { position:absolute; width:3px; height:16px; background:var(--neon-amber); border-radius:2px; top:-4px; box-shadow:0 0 6px var(--neon-amber); }
.pt-upside { font-size:12px; font-weight:700; margin-top:4px; }
/* individual analyst cards */
.analyst-cards-title { font-size:10px; color:var(--text-ghost); font-weight:700; text-transform:uppercase; letter-spacing:0.6px; margin-bottom:8px; }
.analyst-cards { display:flex; flex-direction:column; gap:8px; margin-bottom:14px; }
.analyst-card { background:rgba(255,255,255,0.02); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px; transition:background 0.2s; }
.ac-row1 { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:4px; }
.ac-analyst { font-size:13px; font-weight:700; color:var(--text-main); }
.ac-firm { font-size:11px; color:var(--text-ghost); }
.ac-right { text-align:right; }
.ac-pt { font-family:'IBM Plex Mono',monospace; font-size:20px; font-weight:700; color:var(--text-bright); line-height:1; }
.ac-rating { font-size:10px; font-weight:700; padding:3px 9px; border-radius:5px; margin-top:4px; display:inline-block; }
.ac-buy { background:rgba(0,255,163,0.12); color:var(--neon-green); }
.ac-outperform { background:rgba(0,212,255,0.12); color:var(--neon-cyan); }
.ac-hold { background:rgba(255,184,0,0.12); color:var(--neon-amber); }
.ac-underperform { background:rgba(255,51,102,0.12); color:var(--neon-red); }
.ac-sell { background:rgba(255,51,102,0.2); color:var(--neon-red); }
.ac-row2 { display:flex; align-items:center; gap:8px; margin-top:8px; }
.ac-change { font-size:11px; font-weight:700; }
.ac-comment { font-size:11px; color:var(--text-dim); line-height:1.5; flex:1; }
/* bull bear case */
.bull-bear-row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.bb-case { border-radius:var(--radius-sm); padding:12px; }
.bb-bull { background:rgba(0,255,163,0.05); border:1px solid rgba(0,255,163,0.18); }
.bb-bear { background:rgba(255,51,102,0.05); border:1px solid rgba(255,51,102,0.18); }
.bb-title { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; display:flex; align-items:center; gap:4px; }
.bb-bull .bb-title { color:var(--neon-green); }
.bb-bear .bb-title { color:var(--neon-red); }
.bb-pt { font-family:'IBM Plex Mono',monospace; font-size:18px; font-weight:700; margin-bottom:6px; }
.bb-bull .bb-pt { color:var(--neon-green); }
.bb-bear .bb-pt { color:var(--neon-red); }
.bb-text { font-size:11px; line-height:1.5; color:var(--text-dim); }

/* AI section */
.ai-section { background:linear-gradient(145deg,rgba(191,127,255,0.06),rgba(0,212,255,0.04)); border:1px solid rgba(191,127,255,0.18); border-radius:var(--radius-md); padding:16px; margin-bottom:18px; }
.ai-header { display:flex; align-items:center; gap:8px; margin-bottom:16px; }
.ai-tag { font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700; color:var(--neon-purple); background:rgba(191,127,255,0.1); border:1px solid rgba(191,127,255,0.25); padding:4px 10px; border-radius:6px; letter-spacing:1px; text-transform:uppercase; }
.ai-verdict-row { display:flex; gap:8px; margin-bottom:16px; }
.verdict-pill { flex:1; padding:12px; border-radius:var(--radius-sm); text-align:center; }
.verdict-pill.bull { background:rgba(0,255,163,0.1); border:1px solid rgba(0,255,163,0.2); }
.verdict-pill.bear { background:rgba(255,51,102,0.1); border:1px solid rgba(255,51,102,0.2); }
.verdict-pill.neut { background:rgba(255,184,0,0.1); border:1px solid rgba(255,184,0,0.2); }
.vp-label { font-size:9px; text-transform:uppercase; letter-spacing:0.8px; font-weight:700; color:var(--text-ghost); margin-bottom:4px; }
.vp-main { font-family:'IBM Plex Mono',monospace; font-size:15px; font-weight:700; }
.verdict-pill.bull .vp-main { color:var(--neon-green); }
.verdict-pill.bear .vp-main { color:var(--neon-red); }
.verdict-pill.neut .vp-main { color:var(--neon-amber); }
.vp-conf { font-size:10px; color:var(--text-dim); margin-top:2px; }
.ai-signals { display:flex; flex-direction:column; gap:10px; }
.signal-row { background:rgba(255,255,255,0.02); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px; }
.signal-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.signal-name { display:flex; align-items:center; gap:6px; font-size:12px; font-weight:700; color:var(--text-main); }
.signal-badge { font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700; padding:3px 8px; border-radius:5px; }
.sb-bull { background:rgba(0,255,163,0.12); color:var(--neon-green); }
.sb-bear { background:rgba(255,51,102,0.12); color:var(--neon-red); }
.sb-neut { background:rgba(255,184,0,0.12); color:var(--neon-amber); }
.signal-detail { font-size:12px; color:var(--text-dim); line-height:1.5; }
.signal-bar-row { display:flex; align-items:center; gap:8px; margin-top:6px; }
.signal-track { flex:1; height:4px; background:rgba(255,255,255,0.05); border-radius:2px; overflow:hidden; }
.signal-fill { height:100%; border-radius:2px; transition:width 1s cubic-bezier(.4,0,.2,1); }
.sf-green { background:var(--neon-green); }
.sf-red { background:var(--neon-red); }
.sf-amber { background:var(--neon-amber); }
.signal-pct { font-family:'IBM Plex Mono',monospace; font-size:11px; color:var(--text-dim); white-space:nowrap; }
.sent-bar { display:flex; height:5px; border-radius:3px; overflow:hidden; margin:6px 0; }
.sent-pos { background:var(--neon-green); }
.sent-neu { background:var(--neon-amber); }
.sent-neg { background:var(--neon-red); }
.sent-labels { display:flex; gap:12px; }
.sent-lbl { font-size:10px; color:var(--text-ghost); }
.sent-lbl span { font-weight:700; color:var(--text-dim); }

/* entry section */
.entry-section { background:linear-gradient(145deg,rgba(0,255,163,0.05),rgba(0,212,255,0.04)); border:1px solid rgba(0,255,163,0.18); border-radius:var(--radius-md); padding:16px; margin-bottom:18px; }
.entry-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
.entry-tag { font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700; color:var(--neon-green); background:rgba(0,255,163,0.1); border:1px solid rgba(0,255,163,0.25); padding:4px 10px; border-radius:6px; letter-spacing:1px; text-transform:uppercase; }
.rr-pill { font-family:'IBM Plex Mono',monospace; font-size:12px; font-weight:700; padding:4px 10px; border-radius:6px; }
.rr-good { background:rgba(0,255,163,0.1); color:var(--neon-green); border:1px solid rgba(0,255,163,0.2); }
.rr-ok { background:rgba(255,184,0,0.1); color:var(--neon-amber); border:1px solid rgba(255,184,0,0.2); }
.rr-bad { background:rgba(255,51,102,0.1); color:var(--neon-red); border:1px solid rgba(255,51,102,0.2); }
.price-ladder { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px; }
.price-rung { background:rgba(255,255,255,0.02); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px; }
.rung-label { font-size:10px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.6px; font-weight:700; margin-bottom:4px; }
.rung-price { font-family:'IBM Plex Mono',monospace; font-size:20px; font-weight:700; line-height:1; margin-bottom:3px; }
.rung-note { font-size:10px; color:var(--text-ghost); }
.rung-entry .rung-price { color:var(--neon-green); }
.rung-target1 .rung-price { color:var(--neon-cyan); }
.rung-target2 .rung-price { color:var(--neon-blue); }
.rung-stop .rung-price { color:var(--neon-red); }
.entry-timeline { background:rgba(255,255,255,0.02); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px; margin-bottom:10px; }
.etl-label { font-size:10px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.6px; font-weight:700; margin-bottom:10px; }
.etl-track { position:relative; height:4px; background:rgba(255,255,255,0.05); border-radius:2px; margin-bottom:8px; }
.etl-zone { position:absolute; height:100%; background:linear-gradient(90deg,var(--neon-green),var(--neon-cyan)); border-radius:2px; opacity:0.6; }
.etl-now { position:absolute; width:10px; height:10px; background:var(--neon-green); border-radius:50%; top:50%; transform:translateY(-50%); box-shadow:0 0 8px var(--neon-green); }
.etl-labels { display:flex; justify-content:space-between; font-size:10px; color:var(--text-ghost); }
.entry-strategy { font-size:12px; color:var(--text-dim); line-height:1.6; padding:10px; background:rgba(255,255,255,0.02); border-radius:var(--radius-sm); border-left:2px solid var(--neon-green); }

/* position sizing */
.sizer-section { background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px; margin-bottom:18px; }
.sizer-title { font-size:11px; font-weight:700; color:var(--neon-cyan); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:12px; display:flex; align-items:center; gap:6px; }
.sizer-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
.sizer-field { background:rgba(255,255,255,0.03); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:10px; }
.sizer-lbl { font-size:9px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.6px; font-weight:700; margin-bottom:6px; }
.sizer-val { font-family:'IBM Plex Mono',monospace; font-size:18px; font-weight:700; color:var(--text-bright); }
.sizer-sub { font-size:10px; color:var(--text-ghost); margin-top:2px; }
.sizer-slider { width:100%; margin-top:4px; }
.sizer-note { font-size:12px; color:var(--text-dim); line-height:1.5; border-left:2px solid var(--neon-cyan); padding-left:8px; }

/* card actions */
.card-actions { display:flex; gap:8px; }
.cta { flex:1; background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px 6px; font-size:12px; font-weight:700; color:var(--text-dim); cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px; transition:all 0.2s cubic-bezier(.4,0,.2,1); }
.cta-icon { font-size:18px; }
.cta:active { transform:scale(0.91); background:var(--bg-overlay); }
.cta.on { background:rgba(0,255,163,0.1); border-color:rgba(0,255,163,0.3); color:var(--neon-green); }
.cta.trade-cta { background:rgba(0,212,255,0.08); border-color:rgba(0,212,255,0.2); color:var(--neon-cyan); }

/* ============================
   HEATMAP WITH ROTATION
============================ */
.heatmap-pad { padding:0 20px; }
.rotation-panel { background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px; margin-bottom:16px; }
.rp-title { font-size:11px; font-weight:700; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:12px; }
.rotation-item { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid var(--border-subtle); }
.rotation-item:last-child { border-bottom:none; }
.ri-sector { flex:1; font-size:13px; font-weight:600; color:var(--text-main); }
.ri-bar-wrap { flex:2; height:6px; background:rgba(255,255,255,0.05); border-radius:3px; overflow:hidden; }
.ri-bar { height:100%; border-radius:3px; }
.ri-in { background:var(--neon-green); }
.ri-out { background:var(--neon-red); }
.ri-arrow { font-size:16px; flex-shrink:0; }
.ri-pct { font-family:'IBM Plex Mono',monospace; font-size:12px; font-weight:700; flex-shrink:0; min-width:50px; text-align:right; }
.heatmap-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.heat-cell { border-radius:var(--radius-md); padding:20px 16px; text-align:center; position:relative; overflow:hidden; border:1px solid var(--border-subtle); background:var(--bg-surface); }
.heat-cell::before { content:''; position:absolute; inset:0; opacity:0.08; pointer-events:none; }
.heat-hot::before { background:var(--neon-green); }
.heat-hot .heat-score { color:var(--neon-green); }
.heat-warm::before { background:var(--neon-amber); }
.heat-warm .heat-score { color:var(--neon-amber); }
.heat-cold::before { background:var(--neon-red); }
.heat-cold .heat-score { color:var(--neon-red); }
.heat-sector { font-size:12px; font-weight:700; color:var(--text-dim); margin-bottom:8px; }
.heat-score { font-family:'IBM Plex Mono',monospace; font-size:36px; font-weight:700; line-height:1; margin-bottom:4px; }
.heat-count { font-size:11px; color:var(--text-ghost); }
.heat-bar { height:3px; background:rgba(255,255,255,0.05); border-radius:2px; margin-top:10px; overflow:hidden; }
.heat-bar-fill { height:100%; border-radius:2px; opacity:0.7; }

/* ============================
   PORTFOLIO / JOURNAL
============================ */
.port-pad { padding:0 20px; }
.port-summary { background:linear-gradient(145deg,rgba(0,255,163,0.07),rgba(0,212,255,0.05)); border:1px solid rgba(0,255,163,0.15); border-radius:var(--radius-lg); padding:20px; margin-bottom:16px; }
.port-label { font-size:11px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:6px; font-weight:700; }
.port-value { font-family:'IBM Plex Mono',monospace; font-size:36px; font-weight:700; color:var(--text-bright); line-height:1; margin-bottom:8px; }
.port-pl { font-family:'IBM Plex Mono',monospace; font-size:18px; font-weight:700; margin-bottom:4px; }
.port-meta { font-size:12px; color:var(--text-ghost); }
.trade-card { background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:16px; margin-bottom:10px; }
.tc-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.tc-ticker { font-family:'IBM Plex Mono',monospace; font-size:20px; font-weight:700; color:var(--text-bright); }
.tc-pl { font-family:'IBM Plex Mono',monospace; font-size:16px; font-weight:700; }
.tc-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; font-size:12px; color:var(--text-dim); margin-bottom:10px; }
.journal-field { background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:8px; margin-bottom:6px; }
.journal-label { font-size:9px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.5px; font-weight:700; margin-bottom:4px; }
.journal-note { font-size:12px; color:var(--text-dim); line-height:1.5; }
textarea.journal-input { width:100%; background:transparent; border:none; color:var(--text-main); font-family:'DM Sans',sans-serif; font-size:12px; resize:none; outline:none; min-height:50px; }
.trade-btn-row { display:flex; gap:6px; }
.close-trade-btn { flex:1; background:rgba(255,51,102,0.1); border:1px solid rgba(255,51,102,0.2); border-radius:var(--radius-sm); padding:10px; font-size:12px; font-weight:700; color:var(--neon-red); cursor:pointer; transition:all 0.2s; }
.close-trade-btn:active { transform:scale(0.97); background:rgba(255,51,102,0.2); }
.outcome-btn { background:rgba(0,255,163,0.08); border:1px solid rgba(0,255,163,0.2); border-radius:var(--radius-sm); padding:10px 14px; font-size:12px; font-weight:700; color:var(--neon-green); cursor:pointer; }
.journal-section { margin-top:20px; }
.js-title { font-size:13px; font-weight:700; color:var(--text-main); margin-bottom:12px; display:flex; align-items:center; gap:6px; }
.js-entry { background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px; margin-bottom:10px; }
.jse-head { display:flex; justify-content:space-between; margin-bottom:8px; }
.jse-ticker { font-family:'IBM Plex Mono',monospace; font-size:15px; font-weight:700; color:var(--text-bright); }
.jse-date { font-size:11px; color:var(--text-ghost); }
.jse-outcome { display:inline-flex; align-items:center; gap:4px; font-size:11px; font-weight:700; padding:3px 8px; border-radius:6px; margin-bottom:8px; }
.outcome-win { background:rgba(0,255,163,0.12); color:var(--neon-green); }
.outcome-loss { background:rgba(255,51,102,0.12); color:var(--neon-red); }
.outcome-open { background:rgba(255,184,0,0.12); color:var(--neon-amber); }
.jse-note { font-size:12px; color:var(--text-dim); line-height:1.5; }

/* ============================
   CHECKLIST
============================ */
.checklist-modal { position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.8); backdrop-filter:blur(12px); display:none; align-items:flex-end; }
.checklist-modal.on { display:flex; animation:modalFadeIn 0.25s ease; }
.checklist-sheet { width:100%; max-width:430px; margin:0 auto; background:var(--bg-base); border-radius:24px 24px 0 0; border-top:1px solid var(--border-mid); padding:0 20px calc(env(safe-area-inset-bottom) + 24px); max-height:88vh; overflow-y:auto; animation:sheetUp 0.32s cubic-bezier(.4,0,.2,1); }
.cl-handle { width:36px; height:4px; background:var(--border-mid); border-radius:2px; margin:12px auto 20px; }
.cl-title { font-size:20px; font-weight:700; color:var(--text-bright); margin-bottom:4px; }
.cl-sub { font-size:13px; color:var(--text-dim); margin-bottom:20px; }
.cl-section { margin-bottom:20px; }
.cl-section-title { font-size:11px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.8px; font-weight:700; margin-bottom:10px; }
.cl-item { display:flex; align-items:flex-start; gap:12px; padding:12px; background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); margin-bottom:8px; cursor:pointer; transition:all 0.2s; }
.cl-item.done { background:rgba(0,255,163,0.05); border-color:rgba(0,255,163,0.15); }
.cl-item:active { transform:scale(0.98); }
.cl-check { width:22px; height:22px; border-radius:6px; border:2px solid var(--border-mid); display:flex; align-items:center; justify-content:center; font-size:12px; flex-shrink:0; transition:all 0.2s; }
.cl-item.done .cl-check { background:var(--neon-green); border-color:var(--neon-green); }
.cl-text { flex:1; }
.cl-item-title { font-size:13px; font-weight:600; color:var(--text-main); margin-bottom:2px; }
.cl-item-sub { font-size:11px; color:var(--text-ghost); }
.cl-item.done .cl-item-title { color:var(--text-ghost); text-decoration:line-through; }
.cl-progress { height:4px; background:rgba(255,255,255,0.05); border-radius:2px; overflow:hidden; margin-bottom:6px; }
.cl-progress-fill { height:100%; background:linear-gradient(90deg,var(--neon-green),var(--neon-cyan)); border-radius:2px; transition:width 0.4s ease; }
.cl-progress-label { font-size:11px; color:var(--text-ghost); text-align:right; }

/* ============================
   PRESETS MODAL
============================ */
.preset-saved-item { background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px 14px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
.psi-name { font-size:14px; font-weight:700; color:var(--text-main); }
.psi-weights { font-size:11px; color:var(--text-ghost); font-family:'IBM Plex Mono',monospace; margin-top:2px; }
.psi-actions { display:flex; gap:6px; }
.psi-load { background:rgba(0,255,163,0.1); border:1px solid rgba(0,255,163,0.2); color:var(--neon-green); border-radius:6px; padding:6px 12px; font-size:12px; font-weight:700; cursor:pointer; }
.psi-del { background:rgba(255,51,102,0.1); border:1px solid rgba(255,51,102,0.2); color:var(--neon-red); border-radius:6px; padding:6px 10px; font-size:12px; cursor:pointer; }
.preset-name-input { width:100%; background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px; font-size:14px; color:var(--text-main); font-family:'DM Sans',sans-serif; margin-bottom:10px; }
.preset-name-input:focus { outline:none; border-color:rgba(0,255,163,0.3); }

/* ============================
   BOTTOM NAV / MODALS
============================ */
.bnav { position:fixed; bottom:0; left:0; right:0; background:rgba(13,13,26,0.92); backdrop-filter:blur(24px) saturate(180%); -webkit-backdrop-filter:blur(24px) saturate(180%); border-top:1px solid var(--border-subtle); padding:6px 8px calc(env(safe-area-inset-bottom) + 6px); display:flex; justify-content:space-around; z-index:90; }
[data-theme="light"] .bnav { background:rgba(232,234,244,0.95); }
.bnav-item { display:flex; flex-direction:column; align-items:center; gap:3px; padding:8px 14px; border-radius:var(--radius-sm); cursor:pointer; transition:all 0.2s; }
.bnav-item:active { transform:scale(0.88); }
.bnav-icon { font-size:22px; transition:filter 0.2s; }
.bnav-label { font-size:10px; font-weight:700; color:var(--text-ghost); letter-spacing:0.3px; transition:color 0.2s; }
.bnav-item.on .bnav-icon { filter:drop-shadow(0 0 6px var(--neon-green)); }
.bnav-item.on .bnav-label { color:var(--neon-green); }

.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); z-index:180; display:none; align-items:flex-end; }
.modal-bg.on { display:flex; animation:modalFadeIn 0.25s ease; }
@keyframes modalFadeIn { from{opacity:0} to{opacity:1} }
.modal-sheet { width:100%; max-width:430px; margin:0 auto; background:var(--bg-base); border-radius:24px 24px 0 0; border-top:1px solid var(--border-mid); padding:0 20px calc(env(safe-area-inset-bottom) + 24px); max-height:88vh; overflow-y:auto; animation:sheetUp 0.32s cubic-bezier(.4,0,.2,1); }
@keyframes sheetUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.sheet-handle { width:36px; height:4px; background:var(--border-mid); border-radius:2px; margin:12px auto 20px; }
.sheet-title { font-size:20px; font-weight:700; color:var(--text-bright); margin-bottom:20px; }
.setting-group { margin-bottom:22px; }
.sg-label { font-size:11px; color:var(--text-ghost); text-transform:uppercase; letter-spacing:0.8px; font-weight:700; margin-bottom:10px; }
.preset-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.preset-btn { background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:13px; font-size:13px; font-weight:700; color:var(--text-dim); cursor:pointer; transition:all 0.2s; }
.preset-btn:active { transform:scale(0.95); }
.preset-btn.on { background:rgba(0,255,163,0.1); border-color:rgba(0,255,163,0.3); color:var(--neon-green); }
.slider-block { background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:14px; margin-bottom:8px; }
.sb-row { display:flex; justify-content:space-between; margin-bottom:10px; }
.sb-name { font-size:13px; font-weight:600; color:var(--text-main); }
.sb-val { font-family:'IBM Plex Mono',monospace; font-size:13px; font-weight:700; color:var(--neon-green); }
input[type=range] { -webkit-appearance:none; width:100%; height:5px; background:rgba(255,255,255,0.08); border-radius:3px; outline:none; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:22px; height:22px; border-radius:11px; background:linear-gradient(135deg,var(--neon-green),var(--neon-cyan)); box-shadow:0 2px 8px var(--glow-green); cursor:pointer; }
.save-preset-btn { width:100%; background:rgba(0,255,163,0.1); border:1px solid rgba(0,255,163,0.3); border-radius:var(--radius-sm); padding:13px; font-size:13px; font-weight:700; color:var(--neon-green); cursor:pointer; margin-top:6px; }

/* toast */
.toast { position:fixed; top:calc(env(safe-area-inset-top) + 72px); left:20px; right:20px; background:var(--bg-raised); border:1px solid var(--border-mid); border-radius:var(--radius-md); padding:14px 16px; display:none; align-items:center; gap:10px; z-index:250; box-shadow:0 8px 32px rgba(0,0,0,0.6); }
.toast.on { display:flex; animation:toastIn 0.3s cubic-bezier(.34,1.56,.64,1); }
@keyframes toastIn { from{opacity:0;transform:translateY(-16px)} to{opacity:1;transform:translateY(0)} }
.toast-ico { font-size:22px; }
.toast-msg { font-size:13px; font-weight:600; color:var(--text-main); flex:1; }

.empty { text-align:center; padding:60px 20px; }
.empty-ico { font-size:56px; margin-bottom:14px; opacity:0.2; }
.empty-t { font-size:17px; font-weight:700; color:var(--text-dim); margin-bottom:6px; }
.empty-s { font-size:13px; color:var(--text-ghost); }

/* theme toggle btn */
.theme-toggle { display:flex; align-items:center; justify-content:space-between; background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px; cursor:pointer; }
.tt-label { font-size:14px; font-weight:600; color:var(--text-main); }
.tt-switch { width:44px; height:24px; background:var(--bg-overlay); border-radius:12px; position:relative; transition:background 0.3s; }
.tt-thumb { width:18px; height:18px; background:var(--text-ghost); border-radius:9px; position:absolute; top:3px; left:3px; transition:transform 0.3s, background 0.3s; }
[data-theme="light"] .tt-switch { background:rgba(0,176,112,0.2); }
[data-theme="light"] .tt-thumb { transform:translateX(20px); background:var(--neon-green); }

/* install prompt */
.install-prompt { margin:0 20px 16px; background:linear-gradient(135deg,rgba(0,255,163,0.08),rgba(0,212,255,0.06)); border:1px solid rgba(0,255,163,0.2); border-radius:var(--radius-md); padding:14px; display:none; align-items:center; gap:12px; }
.install-prompt.on { display:flex; }
.ip-icon { font-size:28px; }
.ip-text { flex:1; }
.ip-title { font-size:13px; font-weight:700; color:var(--text-bright); margin-bottom:2px; }
.ip-sub { font-size:11px; color:var(--text-dim); }
.ip-btn { background:var(--neon-green); color:var(--bg-void); border:none; border-radius:8px; padding:8px 14px; font-size:12px; font-weight:700; cursor:pointer; flex-shrink:0; }
.ip-btn:active { transform:scale(0.95); }
.ip-close { font-size:18px; color:var(--text-ghost); cursor:pointer; padding:4px; }

/* ============================
   V7 — LIVE API BANNER
============================ */
.api-banner { margin:0 20px 12px; border-radius:var(--radius-md); padding:11px 14px; display:flex; align-items:center; gap:10px; border:1px solid; }
.api-banner.live { background:rgba(0,255,163,0.07); border-color:rgba(0,255,163,0.25); }
.api-banner.mock { background:rgba(255,184,0,0.07); border-color:rgba(255,184,0,0.25); }
.api-banner.err  { background:rgba(255,51,102,0.07); border-color:rgba(255,51,102,0.25); }
.ab-dot { width:8px;height:8px;border-radius:50%;flex-shrink:0; }
.api-banner.live .ab-dot { background:var(--neon-green);animation:dotPulse 2s infinite; }
.api-banner.mock .ab-dot { background:var(--neon-amber); }
.api-banner.err  .ab-dot { background:var(--neon-red); }
.ab-text { flex:1;font-size:12px;font-weight:600; }
.api-banner.live .ab-text { color:var(--neon-green); }
.api-banner.mock .ab-text { color:var(--neon-amber); }
.api-banner.err  .ab-text { color:var(--neon-red); }
.ab-btn { font-size:11px;font-weight:700;padding:5px 10px;border-radius:6px;cursor:pointer;border:none;flex-shrink:0;font-family:'IBM Plex Mono',monospace; }
.api-banner.live .ab-btn { background:rgba(0,255,163,0.15);color:var(--neon-green); }
.api-banner.mock .ab-btn { background:rgba(255,184,0,0.15);color:var(--neon-amber); }
.api-banner.err  .ab-btn { background:rgba(255,51,102,0.15);color:var(--neon-red); }
.api-key-block { background:var(--bg-raised);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:14px;margin-bottom:14px; }
.akb-label { font-size:10px;color:var(--text-ghost);text-transform:uppercase;letter-spacing:.7px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px; }
.akb-status { width:7px;height:7px;border-radius:50%; }
.akb-input { width:100%;background:var(--bg-overlay);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);padding:11px;font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--text-main);outline:none;margin-bottom:8px;box-sizing:border-box; }
.akb-input:focus { border-color:rgba(0,255,163,0.3); }
.akb-input::placeholder { color:var(--text-ghost);font-family:'DM Sans',sans-serif;font-size:12px; }
.akb-row { display:flex;gap:6px; }
.akb-save { flex:1;background:linear-gradient(135deg,var(--neon-green),var(--neon-cyan));color:var(--bg-void);border:none;border-radius:var(--radius-sm);padding:10px;font-size:12px;font-weight:700;cursor:pointer;font-family:'IBM Plex Mono',monospace; }
.akb-clear { background:rgba(255,51,102,0.1);color:var(--neon-red);border:1px solid rgba(255,51,102,0.2);border-radius:var(--radius-sm);padding:10px 14px;font-size:12px;font-weight:700;cursor:pointer; }
.api-note { font-size:11px;color:var(--text-ghost);line-height:1.6;margin-top:6px; }
.api-note a { color:var(--neon-cyan);text-decoration:none; }

/* ============================
   V7 — COUNTDOWN TIMER
============================ */
.countdown-badge { display:inline-flex;align-items:center;gap:5px;border-radius:8px;padding:5px 10px;margin-bottom:8px; }
.countdown-badge.hours { background:rgba(255,51,102,0.15);border:1px solid rgba(255,51,102,0.4);animation:countPulse 1.4s ease-in-out infinite; }
.countdown-badge.days  { background:rgba(255,184,0,0.1);border:1px solid rgba(255,184,0,0.3); }
.countdown-badge.weeks { background:rgba(77,159,255,0.1);border:1px solid rgba(77,159,255,0.25); }
@keyframes countPulse { 0%,100%{opacity:1}50%{opacity:.65} }
.cd-text { font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:700; }
.countdown-badge.hours .cd-text { color:var(--neon-red); }
.countdown-badge.days  .cd-text { color:var(--neon-amber); }
.countdown-badge.weeks .cd-text { color:var(--neon-blue); }

/* ============================
   V7 — COLLAPSIBLE SECTIONS
============================ */
.section-toggle { display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:12px 0 8px;user-select:none;-webkit-tap-highlight-color:transparent; }
.st-title { font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim); }
.st-arrow { font-size:12px;color:var(--text-ghost);transition:transform .3s cubic-bezier(.4,0,.2,1);line-height:1; }
.st-arrow.open { transform:rotate(180deg); }
.collapsible-body { overflow:hidden;transition:max-height .35s cubic-bezier(.4,0,.2,1),opacity .25s ease; }
.collapsible-body.closed { max-height:0!important;opacity:0; }

/* ============================
   V7 — PIN
============================ */
.pin-strip { height:3px;background:linear-gradient(90deg,var(--neon-purple),var(--neon-blue));display:none; }
.stock-card.pinned .pin-strip { display:block; }
.cta.pin-cta { background:rgba(191,127,255,0.08);border-color:rgba(191,127,255,0.2);color:var(--neon-purple); }
.cta.pin-cta.on { background:rgba(191,127,255,0.2);border-color:var(--neon-purple); }

/* ============================
   V7 — SCREENING MODAL
============================ */
.screen-group-lbl { font-size:11px;color:var(--text-ghost);font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:10px; }
.screen-row { display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px; }
.screen-field { background:var(--bg-raised);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);padding:12px; }
.screen-lbl { font-size:10px;color:var(--text-ghost);text-transform:uppercase;letter-spacing:.6px;font-weight:700;margin-bottom:8px;display:flex;justify-content:space-between; }
.screen-lbl span { color:var(--neon-green);font-family:'IBM Plex Mono',monospace;font-weight:700; }
input[type=range].screen-range { width:100%;accent-color:var(--neon-green); }
.screen-sector-grid { display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:14px; }
.ssg-btn { background:var(--bg-raised);border:1px solid var(--border-subtle);border-radius:8px;padding:9px 4px;font-size:11px;font-weight:700;color:var(--text-dim);cursor:pointer;text-align:center;transition:all .2s; }
.ssg-btn.on { background:rgba(0,255,163,0.1);border-color:rgba(0,255,163,0.3);color:var(--neon-green); }
.ssg-btn:active { transform:scale(.93); }
.apply-screen-btn { width:100%;background:linear-gradient(135deg,var(--neon-green),var(--neon-cyan));border:none;border-radius:var(--radius-md);padding:16px;font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:700;color:var(--bg-void);cursor:pointer;margin-top:4px; }
.apply-screen-btn:active { transform:scale(.98); }
.reset-screen-btn { width:100%;background:transparent;border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:12px;font-size:13px;font-weight:700;color:var(--text-dim);cursor:pointer;margin-top:8px; }
.screen-active-dot { display:none;position:absolute;top:-3px;right:-3px;width:10px;height:10px;background:var(--neon-green);border-radius:50%;border:2px solid var(--bg-void); }
.screen-active-dot.on { display:block; }
.filter-btn-wrap { position:relative; }
.results-count { font-size:11px;color:var(--text-ghost);margin-top:6px;text-align:center; }

/* ============================
   V7 — EARNINGS HISTORY
============================ */
.history-section { border-radius:var(--radius-md);overflow:hidden;margin-bottom:4px; }
.hs-inner { background:var(--bg-raised);border:1px solid var(--border-subtle);border-radius:var(--radius-md);overflow:hidden; }
.hs-streak { display:inline-flex;align-items:center;gap:5px;background:rgba(0,255,163,0.08);border:1px solid rgba(0,255,163,0.2);border-radius:6px;padding:5px 10px;font-size:11px;font-weight:700;color:var(--neon-green);margin:10px 12px 0; }
.hs-streak.miss { background:rgba(255,51,102,0.08);border-color:rgba(255,51,102,0.2);color:var(--neon-red); }
.hs-table { width:100%;border-collapse:collapse;margin-top:8px; }
.hs-table th { font-size:9px;color:var(--text-ghost);text-transform:uppercase;letter-spacing:.6px;font-weight:700;padding:8px 10px;text-align:right;border-bottom:1px solid var(--border-subtle); }
.hs-table th:first-child { text-align:left; }
.hs-table td { font-size:11px;padding:8px 10px;border-bottom:1px solid var(--border-subtle);font-family:'IBM Plex Mono',monospace;text-align:right;color:var(--text-dim); }
.hs-table td:first-child { text-align:left;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--text-main); }
.hs-table tr:last-child td { border-bottom:none; }
.hb { font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px; }
.hb-beat { background:rgba(0,255,163,0.12);color:var(--neon-green); }
.hb-miss { background:rgba(255,51,102,0.12);color:var(--neon-red); }
.hb-line { background:rgba(255,184,0,0.12);color:var(--neon-amber); }
.rxn-pos { color:var(--neon-green); }
.rxn-neg { color:var(--neon-red); }

/* ============================
   V7 — OPTIONS SNAPSHOT
============================ */
.options-section { background:linear-gradient(145deg,rgba(191,127,255,0.05),rgba(77,159,255,0.04));border:1px solid rgba(191,127,255,0.18);border-radius:var(--radius-md);padding:16px;margin-bottom:4px; }
.opt-tag { font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:700;color:var(--neon-purple);background:rgba(191,127,255,0.1);border:1px solid rgba(191,127,255,0.25);padding:4px 10px;border-radius:6px;letter-spacing:1px;text-transform:uppercase;display:inline-block;margin-bottom:12px; }
.opt-summary { display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px; }
.opt-box { background:rgba(255,255,255,0.03);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);padding:10px;text-align:center; }
.opt-box-lbl { font-size:9px;color:var(--text-ghost);text-transform:uppercase;letter-spacing:.5px;font-weight:700;margin-bottom:5px; }
.opt-box-val { font-family:'IBM Plex Mono',monospace;font-size:16px;font-weight:700;color:var(--text-bright); }
.opt-box-sub { font-size:10px;color:var(--text-ghost);margin-top:2px; }
.chain-title { font-size:10px;color:var(--text-ghost);font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px; }
.chain-hdr { display:grid;grid-template-columns:1.2fr .7fr .7fr 1fr .7fr .7fr 1.2fr;gap:3px;padding:6px 8px;background:rgba(255,255,255,0.03);border-radius:6px 6px 0 0; }
.chain-hdr span { font-size:9px;color:var(--text-ghost);font-weight:700;text-transform:uppercase;text-align:center; }
.chain-hdr span:first-child { text-align:left; }
.chain-hdr span:last-child { text-align:right; }
.chain-row { display:grid;grid-template-columns:1.2fr .7fr .7fr 1fr .7fr .7fr 1.2fr;gap:3px;padding:7px 8px;border-bottom:1px solid var(--border-subtle);align-items:center; }
.chain-row.atm { background:rgba(255,184,0,0.06); }
.chain-row:last-child { border-bottom:none; }
.chain-cell { font-family:'IBM Plex Mono',monospace;font-size:10px;text-align:center; }
.chain-cell.call { color:var(--neon-green); }
.chain-cell.put  { color:var(--neon-red); }
.chain-cell.strike { font-size:11px;font-weight:700;color:var(--text-bright); }
.chain-row.atm .chain-cell.strike { color:var(--neon-amber); }
.chain-cell:first-child { text-align:left; }
.chain-cell:last-child  { text-align:right; }

/* ============================
   DRILL-DOWN FULL SCREEN
============================ */
.drilldown-overlay {
    position:fixed; inset:0; z-index:999; background:var(--bg-base);
    transform:translateY(100%); transition:transform 0.4s cubic-bezier(.2,.8,.3,1);
    display:flex; flex-direction:column; overflow:hidden;
}
.drilldown-overlay.open { transform:translateY(0); }
.dd-header {
    display:flex; align-items:center; gap:12px; padding:14px 16px 10px;
    border-bottom:1px solid var(--border-subtle); flex-shrink:0;
    background:var(--bg-surface);
}
.dd-back { width:36px;height:36px;border-radius:50%;background:var(--bg-raised);border:none;
    color:var(--text-bright);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0; }
.dd-name { flex:1; }
.dd-ticker { font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:700;color:var(--text-bright); }
.dd-fullname { font-size:11px;color:var(--text-dim);margin-top:1px; }
.dd-score-badge { width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;
    font-family:'IBM Plex Mono',monospace;font-weight:700;font-size:16px;flex-shrink:0; }
.dd-score-badge.hi  { background:rgba(0,255,163,0.15);color:var(--neon-green);border:1px solid rgba(0,255,163,0.3); }
.dd-score-badge.mid { background:rgba(255,184,0,0.15);color:var(--neon-amber);border:1px solid rgba(255,184,0,0.3); }
.dd-score-badge.lo  { background:rgba(255,51,102,0.15);color:var(--neon-red);border:1px solid rgba(255,51,102,0.3); }
.dd-body { flex:1; overflow-y:auto; padding-bottom:24px; }
.dd-price-row { padding:16px 16px 8px; }
.dd-price { font-family:'IBM Plex Mono',monospace;font-size:36px;font-weight:700;color:var(--text-bright); }
.dd-change { font-size:14px;font-weight:600;margin-top:4px; }
.dd-change.pos { color:var(--neon-green); }
.dd-change.neg { color:var(--neon-red); }
.dd-tf-row { display:flex;gap:6px;padding:0 16px 12px;overflow-x:auto; }
.dd-tf { padding:5px 12px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--border-mid);
    color:var(--text-dim);background:var(--bg-surface);cursor:pointer;flex-shrink:0; }
.dd-tf.active { background:var(--neon-green);color:#000;border-color:var(--neon-green); }
.dd-chart-wrap { height:280px;padding:0 4px;position:relative; }
.dd-chart-loading { position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    color:var(--text-dim);font-size:12px; }
.dd-metrics-grid { display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:16px 16px 8px; }
.dd-metric { background:var(--bg-surface);border-radius:10px;padding:10px;text-align:center;border:1px solid var(--border-subtle); }
.dd-metric-label { font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px; }
.dd-metric-val { font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:700;color:var(--text-bright);margin-top:3px; }
.dd-section { padding:12px 16px; }
.dd-section-title { font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;
    margin-bottom:10px;display:flex;align-items:center;gap:6px; }
.dd-news-item { display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border-subtle); }
.dd-news-item:last-child { border-bottom:none; }
.dd-news-dot { width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:5px; }
.dd-news-dot.pos { background:var(--neon-green); }
.dd-news-dot.neg { background:var(--neon-red); }
.dd-news-dot.neu { background:var(--text-ghost); }
.dd-news-text { font-size:12px;color:var(--text-main);line-height:1.5; }
.dd-news-meta { font-size:10px;color:var(--text-dim);margin-top:3px; }

/* ============================
   EARNINGS CALENDAR
============================ */
.cal-header { padding:16px 16px 8px; }
.cal-month { font-size:18px;font-weight:800;color:var(--text-bright);display:flex;align-items:center;gap:8px; }
.cal-nav { width:30px;height:30px;border-radius:50%;background:var(--bg-surface);border:1px solid var(--border-mid);
    color:var(--text-bright);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px; }
.cal-grid { display:grid;grid-template-columns:repeat(7,1fr);gap:2px;padding:0 12px 8px; }
.cal-dow { font-size:9px;font-weight:700;color:var(--text-dim);text-align:center;padding:6px 0;text-transform:uppercase; }
.cal-day { min-height:58px;background:var(--bg-surface);border-radius:8px;padding:5px;border:1px solid var(--border-subtle);
    cursor:pointer;transition:border-color 0.2s; }
.cal-day:hover { border-color:var(--neon-cyan); }
.cal-day.empty { background:transparent;border-color:transparent;cursor:default; }
.cal-day.today { border-color:var(--neon-cyan); }
.cal-day.has-earnings { border-color:rgba(0,255,163,0.3); }
.cal-day-num { font-size:11px;font-weight:700;color:var(--text-dim); }
.cal-day.today .cal-day-num { color:var(--neon-cyan); }
.cal-ear-chip { font-size:8px;font-weight:700;padding:2px 4px;border-radius:4px;margin-top:3px;
    background:rgba(0,255,163,0.12);color:var(--neon-green);border:1px solid rgba(0,255,163,0.2);
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer; }
.cal-ear-chip.mid { background:rgba(255,184,0,0.12);color:var(--neon-amber);border-color:rgba(255,184,0,0.2); }
.cal-ear-chip.lo  { background:rgba(255,51,102,0.12);color:var(--neon-red);border-color:rgba(255,51,102,0.2); }
.cal-legend { display:flex;gap:12px;padding:8px 16px 16px;flex-wrap:wrap; }
.cal-legend-item { display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text-dim); }
.cal-legend-dot { width:8px;height:8px;border-radius:50%; }
.cal-day-detail { padding:12px 16px; }
.cal-dd-title { font-size:12px;font-weight:700;color:var(--text-dim);margin-bottom:8px; }
.cal-dd-list { display:flex;flex-direction:column;gap:6px; }
.cal-dd-row { display:flex;align-items:center;gap:10px;background:var(--bg-surface);
    border-radius:10px;padding:10px 12px;cursor:pointer;border:1px solid var(--border-subtle); }
.cal-dd-row:active { background:var(--bg-raised); }
.cal-dd-ticker { font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;color:var(--text-bright);width:52px; }
.cal-dd-name { font-size:11px;color:var(--text-dim);flex:1; }
.cal-dd-time { font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600; }
.cal-dd-time.bmo { background:rgba(0,212,255,0.12);color:var(--neon-cyan); }
.cal-dd-time.amc { background:rgba(191,127,255,0.12);color:var(--neon-purple); }
.cal-dd-score { font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;width:28px;text-align:right; }

/* ============================
   SECTOR DEEP DIVE
============================ */
.sector-overlay {
    position:fixed; inset:0; z-index:998; background:var(--bg-base);
    transform:translateX(100%); transition:transform 0.35s cubic-bezier(.2,.8,.3,1);
    display:flex; flex-direction:column; overflow:hidden;
}
.sector-overlay.open { transform:translateX(0); }
.sector-header { display:flex;align-items:center;gap:12px;padding:14px 16px;
    border-bottom:1px solid var(--border-subtle);background:var(--bg-surface);flex-shrink:0; }
.sector-back { width:36px;height:36px;border-radius:50%;background:var(--bg-raised);border:none;
    color:var(--text-bright);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center; }
.sector-title { flex:1;font-size:16px;font-weight:800;color:var(--text-bright); }
.sector-badge { padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;
    background:rgba(0,212,255,0.12);color:var(--neon-cyan);border:1px solid rgba(0,212,255,0.2); }
.sector-body { flex:1;overflow-y:auto;padding-bottom:24px; }
.sector-stats { display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:14px 16px 6px; }
.sector-stat { background:var(--bg-surface);border-radius:10px;padding:10px;text-align:center;border:1px solid var(--border-subtle); }
.sector-stat-lbl { font-size:10px;color:var(--text-dim);text-transform:uppercase; }
.sector-stat-val { font-family:'IBM Plex Mono',monospace;font-size:15px;font-weight:700;color:var(--text-bright);margin-top:3px; }
.sector-chart-wrap { height:180px;padding:8px 16px; }
.sector-stocks-list { padding:0 16px; }
.sector-stock-row { display:flex;align-items:center;gap:10px;padding:10px 12px;
    background:var(--bg-surface);border-radius:12px;margin-bottom:6px;cursor:pointer;
    border:1px solid var(--border-subtle); }
.sector-stock-row:active { background:var(--bg-raised); }
.sector-rank { font-size:10px;color:var(--text-ghost);width:18px;font-weight:700; }
.sector-s-ticker { font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;color:var(--text-bright);width:52px; }
.sector-s-price { font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--text-dim);flex:1; }
.sector-s-change { font-size:11px;font-weight:600;width:55px;text-align:right; }
.sector-s-change.pos { color:var(--neon-green); }
.sector-s-change.neg { color:var(--neon-red); }
.sector-s-score { font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700;width:28px;text-align:right; }
.sector-bar-row { padding:6px 16px; }
.sector-bar-lbl { display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px; }
.sector-bar-lbl span:first-child { color:var(--text-dim); }
.sector-bar-lbl span:last-child { font-family:'IBM Plex Mono',monospace;font-weight:700;color:var(--text-bright); }
.sector-bar-track { height:6px;background:var(--bg-raised);border-radius:3px;overflow:hidden; }
.sector-bar-fill { height:100%;border-radius:3px;transition:width 0.8s cubic-bezier(.4,0,.2,1); }

/* ============================
   LIVE DATA INDICATOR
============================ */
.live-tag { display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;
    padding:2px 6px;border-radius:4px;background:rgba(0,255,163,0.12);
    color:var(--neon-green);border:1px solid rgba(0,255,163,0.25);vertical-align:middle;margin-left:6px; }
.live-tag::before { content:''; width:5px;height:5px;border-radius:50%;background:var(--neon-green);
    animation:livePulse 1.6s ease-in-out infinite; }
@keyframes livePulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.7)} }

/* Card tap cursor */
.stock-card { cursor:pointer; }
.stock-card:active { transform:scale(0.99); }

/* Sector badge clickable */
.sector-tag { cursor:pointer; }
.sector-tag:hover { opacity:0.85; border-color:var(--neon-cyan) !important; }

</style>
</head>
<body>
<div class="bg-ambient"></div>

<div class="toast" id="toast">
    <div class="toast-ico" id="toastIco">✓</div>
    <div class="toast-msg" id="toastMsg"></div>
</div>

<!-- DAILY BRIEFING -->
<div class="briefing-overlay" id="briefingOverlay">
    <div class="briefing-header">
        <div class="briefing-date" id="briefingDate"></div>
        <div class="briefing-close" onclick="closeBriefing()">✕</div>
    </div>
    <div style="margin-bottom:24px;">
        <div class="briefing-title">Good Morning.</div>
        <div class="briefing-sub">Today's top earnings opportunities</div>
    </div>
    <div id="briefingContent"></div>
    <div class="briefing-actions">
        <button class="briefing-btn primary" onclick="closeBriefing();runAnalysis()">🔍 Analyze All</button>
        <button class="briefing-btn secondary" onclick="closeBriefing()">Later</button>
    </div>
</div>

<!-- CHECKLIST -->
<div class="checklist-modal" id="checklistModal">
    <div class="checklist-sheet">
        <div class="cl-handle"></div>
        <div class="cl-title">☑️ Pre-Market</div>
        <div class="cl-sub">Complete before trading</div>
        <div style="margin-bottom:16px;">
            <div class="cl-progress"><div class="cl-progress-fill" id="clProgressBar" style="width:0%"></div></div>
            <div class="cl-progress-label" id="clProgressLabel">0 / 10 done</div>
        </div>
        <div id="checklistItems"></div>
        <button class="save-preset-btn" onclick="resetChecklist()" style="background:rgba(255,51,102,0.08);border-color:rgba(255,51,102,0.2);color:var(--neon-red);margin-top:8px;">Reset Checklist</button>
    </div>
</div>

<div class="app-wrap">

    <!-- HEADER -->
    <header class="header">
        <div class="header-top">
            <div class="logo">
                <div class="logo-mark">🎯</div>
                <div class="logo-name">
                    <div class="logo-title">BULL'S EYE</div>
                    <div class="logo-ver">v8.0 PRO</div>
                </div>
            </div>
            <div class="header-btns">
                <div class="hbtn" onclick="toggleTheme()" title="Toggle theme">🌙</div>
                <div class="hbtn" onclick="openChecklist()">☑️</div>
                <div class="hbtn" onclick="openModal('settingsModal')">⚙️</div>
                <div class="hbtn" onclick="openModal('alertsModal')">🔔<div class="dot" id="alertDot" style="display:none"></div></div>
                <div class="hbtn" onclick="openModal('watchlistModal')">⭐</div>
            </div>
        </div>
        <div class="stat-row">
            <div class="stat-pill"><div class="sp-label">Stocks</div><div class="sp-value" id="statTotal">—</div></div>
            <div class="stat-pill"><div class="sp-label">Avg</div><div class="sp-value" id="statAvg">—</div></div>
            <div class="stat-pill"><div class="sp-label">HiConf</div><div class="sp-value" id="statHi">—</div></div>
            <div class="stat-pill"><div class="sp-label">LowRisk</div><div class="sp-value" id="statLow">—</div></div>
            <div class="stat-pill"><div class="sp-label">P/L</div><div class="sp-value" id="statPL">$0</div></div>
        </div>
    </header>

    <!-- PWA INSTALL -->
    <div class="install-prompt" id="installPrompt">
        <div class="ip-icon">📲</div>
        <div class="ip-text">
            <div class="ip-title">Install Bull's Eye</div>
            <div class="ip-sub">Add to Home Screen for the full app experience</div>
        </div>
        <button class="ip-btn" id="installBtn">Install</button>
        <div class="ip-close" onclick="document.getElementById('installPrompt').classList.remove('on')">✕</div>
    </div>

    <!-- MACRO PANEL -->
    <div class="macro-panel" id="macroPanel">
        <div class="macro-title"><div class="macro-live"></div> MARKET CONTEXT</div>
        <div class="macro-grid" id="macroGrid"></div>
    </div>

    <!-- ANALYZE -->
    <div class="action-zone">
        <button class="analyze-btn" id="analyzeBtn" onclick="runAnalysis()">
            <span id="btnText">🚀 ANALYZE EARNINGS</span>
            <div class="scan-progress" id="scanProgress"></div>
        </button>
    </div>

    <!-- CHIPS -->
    <div class="chips-row" id="chipRow">
        <div class="chip on" data-f="all" onclick="setFilter('all')">All</div>
        <div class="chip" data-f="Technology" onclick="setFilter('Technology')">Tech</div>
        <div class="chip" data-f="Finance" onclick="setFilter('Finance')">Finance</div>
        <div class="chip" data-f="Healthcare" onclick="setFilter('Healthcare')">Health</div>
        <div class="chip" data-f="Energy" onclick="setFilter('Energy')">Energy</div>
        <div class="chip" data-f="Retail" onclick="setFilter('Retail')">Retail</div>
    </div>

    <!-- API BANNER -->
    <div class="api-banner mock" id="apiBanner">
        <div class="ab-dot"></div>
        <div class="ab-text" id="apiBannerText">Running on mock data</div>
        <button class="ab-btn" onclick="openModal('apiModal')">Connect API</button>
    </div>

    <!-- SORT + SCREEN -->
    <div class="sort-row" style="display:flex;align-items:center;gap:8px;">
        <div class="sort-label">SORT</div>
        <select class="sort-select" id="sortSel" onchange="renderStocks()" style="flex:1">
            <option value="overall">Overall Score</option>
            <option value="surprise">Earnings Surprise</option>
            <option value="revenue">Revenue Growth</option>
            <option value="confidence">Confidence</option>
            <option value="risk">Lowest Risk</option>
            <option value="rr">Risk/Reward</option>
        </select>
        <div class="filter-btn-wrap" style="flex-shrink:0">
            <div class="screen-active-dot" id="screenDot"></div>
            <button style="background:var(--bg-raised);border:1px solid var(--border-subtle);border-radius:8px;padding:8px 12px;font-size:12px;font-weight:700;color:var(--text-dim);cursor:pointer" onclick="openModal('screenModal')">🔎</button>
        </div>
    </div>

    <!-- TABS -->
    <div class="tab-bar">
        <button class="tab on" onclick="switchTab('stocks',this)">Stocks</button>
        <button class="tab" onclick="switchTab('heatmap',this)">Heatmap</button>
        <button class="tab" onclick="switchTab('calendar',this)">Calendar</button>
        <button class="tab" onclick="switchTab('portfolio',this)">Portfolio</button>
    </div>

    <!-- STOCKS -->
    <div class="pane on" id="pane-stocks">
        <div class="stock-list" id="stockList">
            <div class="empty">
                <div class="empty-ico">📡</div>
                <div class="empty-t">Ready to scan</div>
                <div class="empty-s">Tap Analyze to start</div>
            </div>
        </div>
    </div>

    <!-- HEATMAP -->
    <div class="pane" id="pane-heatmap">
        <div class="heatmap-pad">
            <div class="rotation-panel" id="rotationPanel">
                <div class="rp-title">💸 Sector Money Flow (30d)</div>
                <div id="rotationList"></div>
            </div>
            <div class="heatmap-grid" id="heatGrid">
                <div class="empty" style="grid-column:span 2">
                    <div class="empty-ico">🗺️</div><div class="empty-t">No data yet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- EARNINGS CALENDAR -->
    <div class="pane" id="pane-calendar">
        <div class="cal-header">
            <div class="cal-month">
                <button class="cal-nav" onclick="calNav(-1)">‹</button>
                <span id="calMonthLabel">Loading...</span>
                <button class="cal-nav" onclick="calNav(1)">›</button>
            </div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
        <div class="cal-legend">
            <div class="cal-legend-item"><div class="cal-legend-dot" style="background:var(--neon-green)"></div>Score ≥ 70</div>
            <div class="cal-legend-item"><div class="cal-legend-dot" style="background:var(--neon-amber)"></div>Score 45–69</div>
            <div class="cal-legend-item"><div class="cal-legend-dot" style="background:var(--neon-red)"></div>Score &lt; 45</div>
        </div>
        <div class="cal-day-detail" id="calDayDetail"></div>
    </div>

    <!-- PORTFOLIO -->
    <div class="pane" id="pane-portfolio">
        <div class="port-pad">
            <div class="port-summary">
                <div class="port-label">Portfolio Value</div>
                <div class="port-value" id="portValue">$100,000</div>
                <div class="port-pl pos" id="portPL">+$0.00 (0.00%)</div>
                <div class="port-meta" id="portMeta">0 active trades</div>
            </div>
            <div id="tradesList"></div>
            <div class="journal-section" id="journalSection" style="display:none">
                <div class="js-title">📓 Trade Journal</div>
                <div id="journalEntries"></div>
            </div>
        </div>
    </div>

</div>

<!-- BOTTOM NAV -->
<nav class="bnav">
    <div class="bnav-item on" onclick="bnavClick('stocks',this)"><div class="bnav-icon">📈</div><div class="bnav-label">Stocks</div></div>
    <div class="bnav-item" onclick="openBriefing()"><div class="bnav-icon">☀️</div><div class="bnav-label">Briefing</div></div>
    <div class="bnav-item" onclick="bnavClick('calendar',this)"><div class="bnav-icon">📅</div><div class="bnav-label">Calendar</div></div>
    <div class="bnav-item" onclick="bnavClick('portfolio',this)"><div class="bnav-icon">💼</div><div class="bnav-label">Portfolio</div></div>
    <div class="bnav-item" onclick="openChecklist()"><div class="bnav-icon">☑️</div><div class="bnav-label">Checklist</div></div>
</nav>

<!-- DRILL-DOWN OVERLAY -->
<div class="drilldown-overlay" id="drilldownOverlay">
    <div class="dd-header">
        <button class="dd-back" onclick="closeDrillDown()">←</button>
        <div class="dd-name">
            <div class="dd-ticker" id="ddTicker">--</div>
            <div class="dd-fullname" id="ddFullname">--</div>
        </div>
        <div class="dd-score-badge" id="ddScoreBadge">--</div>
    </div>
    <div class="dd-body" id="ddBody">
        <div class="dd-price-row">
            <div class="dd-price" id="ddPrice">$--</div>
            <div class="dd-change" id="ddChange">-- today</div>
        </div>
        <div class="dd-tf-row" id="ddTfRow">
            <button class="dd-tf" onclick="ddSetTf('5d',this)">5D</button>
            <button class="dd-tf active" onclick="ddSetTf('1mo',this)">1M</button>
            <button class="dd-tf" onclick="ddSetTf('3mo',this)">3M</button>
            <button class="dd-tf" onclick="ddSetTf('6mo',this)">6M</button>
            <button class="dd-tf" onclick="ddSetTf('1y',this)">1Y</button>
        </div>
        <div class="dd-chart-wrap" id="ddChartWrap">
            <div class="dd-chart-loading" id="ddChartLoading">📊 Loading chart...</div>
            <div id="ddChart" style="height:100%;width:100%"></div>
        </div>
        <div class="dd-metrics-grid" id="ddMetrics"></div>
        <div class="dd-section">
            <div class="dd-section-title">📰 News</div>
            <div id="ddNews"></div>
        </div>
        <div class="dd-section" id="ddExtraContent"></div>
    </div>
</div>

<!-- SECTOR DEEP DIVE OVERLAY -->
<div class="sector-overlay" id="sectorOverlay">
    <div class="sector-header">
        <button class="sector-back" onclick="closeSectorDive()">←</button>
        <div class="sector-title" id="sectorDiveTitle">Sector</div>
        <div class="sector-badge" id="sectorDiveBadge">--</div>
    </div>
    <div class="sector-body" id="sectorBody"></div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-bg" id="settingsModal" onclick="handleModalClick(event,'settingsModal')">
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">⚙️ Settings</div>

        <div class="setting-group">
            <div class="sg-label">Theme</div>
            <div class="theme-toggle" onclick="toggleTheme()">
                <div class="tt-label" id="themeLabel">Dark Mode</div>
                <div class="tt-switch"><div class="tt-thumb"></div></div>
            </div>
        </div>

        <div class="setting-group">
            <div class="sg-label">Scoring Strategy</div>
            <div class="preset-grid" id="presetGrid">
                <button class="preset-btn on" onclick="setPreset('balanced',this)">⚖️ Balanced</button>
                <button class="preset-btn" onclick="setPreset('growth',this)">📈 Growth</button>
                <button class="preset-btn" onclick="setPreset('value',this)">💎 Value</button>
                <button class="preset-btn" onclick="setPreset('momentum',this)">🚀 Momentum</button>
            </div>
        </div>

        <div class="setting-group">
            <div class="sg-label">Custom Weights</div>
            <div class="slider-block"><div class="sb-row"><div class="sb-name">Earnings Surprise</div><div class="sb-val" id="wSurpVal">30%</div></div><input type="range" id="wSurp" min="0" max="100" value="30" oninput="onWeight()"></div>
            <div class="slider-block"><div class="sb-row"><div class="sb-name">Revenue Growth</div><div class="sb-val" id="wRevVal">25%</div></div><input type="range" id="wRev" min="0" max="100" value="25" oninput="onWeight()"></div>
            <div class="slider-block"><div class="sb-row"><div class="sb-name">Analyst Sentiment</div><div class="sb-val" id="wAnaVal">25%</div></div><input type="range" id="wAna" min="0" max="100" value="25" oninput="onWeight()"></div>
            <div class="slider-block"><div class="sb-row"><div class="sb-name">Technical Score</div><div class="sb-val" id="wTechVal">20%</div></div><input type="range" id="wTech" min="0" max="100" value="20" oninput="onWeight()"></div>
            <input type="text" class="preset-name-input" id="presetNameInput" placeholder="Name this preset...">
            <button class="save-preset-btn" onclick="savePreset()">💾 Save as Preset</button>
        </div>

        <div class="setting-group">
            <div class="sg-label">Saved Presets</div>
            <div id="savedPresetsList"></div>
        </div>
        <div class="setting-group">
            <div class="sg-label">Live Data</div>
            <button style="width:100%;background:rgba(0,255,163,0.08);border:1px solid rgba(0,255,163,0.2);border-radius:var(--radius-sm);padding:12px;font-size:13px;font-weight:700;color:var(--neon-green);cursor:pointer" onclick="openModal('apiModal');closeModal('settingsModal')">🔌 Manage API Keys</button>
        </div>
    </div>
</div>

<!-- ALERTS MODAL -->
<div class="modal-bg" id="alertsModal" onclick="handleModalClick(event,'alertsModal')">
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">🔔 Alerts</div>
        <div id="alertsList"><div class="empty"><div class="empty-ico">🔕</div><div class="empty-t">No alerts</div></div></div>
    </div>
</div>

<!-- WATCHLIST MODAL -->
<div class="modal-bg" id="watchlistModal" onclick="handleModalClick(event,'watchlistModal')">
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">⭐ Watchlist</div>
        <div id="watchlistList"><div class="empty"><div class="empty-ico">⭐</div><div class="empty-t">Empty</div></div></div>
    </div>
</div>

<!-- POSITION SIZER MODAL -->
<div class="modal-bg" id="sizerModal" onclick="handleModalClick(event,'sizerModal')">
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title" id="sizerTitle">Position Sizer</div>
        <div id="sizerContent"></div>
    </div>
</div>

<script>
// Global error handler — shows errors as toast instead of silent fail
window.addEventListener('unhandledrejection', e => {
    console.error('Unhandled promise rejection:', e.reason);
    e.preventDefault();
});
window.onerror = function(msg, src, line) {
    console.error('Script error:', msg, 'line:', line);
    return true; // prevent default browser error handling
};

// ============================
// STATE
// ============================
let stocks = [];
let watchlist = new Set(JSON.parse(localStorage.getItem('be_wl6') || '[]'));
let trades = JSON.parse(localStorage.getItem('be_trades6') || '[]');
let journal = JSON.parse(localStorage.getItem('be_journal6') || '[]');
let alerts = [];
let savedPresets = JSON.parse(localStorage.getItem('be_presets6') || '[]');
let activeFilter = 'all';
let weights = {surp:30,rev:25,ana:25,tech:20};
let stockCharts = {};
let checklistState = JSON.parse(localStorage.getItem('be_checklist6') || '{}');
let portfolioBalance = 100000;
let pinnedStocks = new Set(JSON.parse(localStorage.getItem('be_pins7') || '[]'));
let screenFilters = { score:0, rr:0, risk:100, conf:0, sectors:[] };
let screenActive = false;
const DEFAULT_KEYS = {
    finnhub: 'd66ri2hr01qnh6sg33s0d',
    fred: '995a84838b62b3c1357eb5bed7d56c5f'
};
let apiKeys = (() => {
    const stored = JSON.parse(localStorage.getItem('be_apikeys7') || '{}');
    if (!stored.finnhub) stored.finnhub = DEFAULT_KEYS.finnhub;
    if (!stored.fred)    stored.fred    = DEFAULT_KEYS.fred;
    // legacy key cleanup done on prior versions
    localStorage.setItem('be_apikeys7', JSON.stringify(stored));
    return stored;
})();

// Price cache: {TICKER: {price, prevClose, change, pct, ts}}
const PRICE_CACHE_KEY = 'be_prices8';
const PRICE_CACHE_VER = 'v8.5';          // REST + WebSocket hybrid implementation
const PRICE_CACHE_TTL = 30 * 60 * 1000; // 30 minutes
let priceCache = (() => {
    const verKey = PRICE_CACHE_KEY + '_ver';
    if (localStorage.getItem(verKey) !== PRICE_CACHE_VER) {
        // Version mismatch — nuke stale cache so wrong prices don't persist
        localStorage.removeItem(PRICE_CACHE_KEY);
        localStorage.setItem(verKey, PRICE_CACHE_VER);
        return {};
    }
    return JSON.parse(localStorage.getItem(PRICE_CACHE_KEY) || '{}');
})();
let countdownTimers = [];
const ALL_SECTORS = ['Technology','Finance','Healthcare','Energy','Retail','Automotive'];
let deferredPrompt = null;

// ============================
// PWA
// ============================
window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installPrompt').classList.add('on');
});
document.getElementById('installBtn').addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') toast('📲','App installed! Check your home screen.');
    deferredPrompt = null;
    document.getElementById('installPrompt').classList.remove('on');
});

// ============================
// THEME
// ============================
const savedTheme = localStorage.getItem('be_theme6') || 'dark';
document.documentElement.setAttribute('data-theme', savedTheme);
updateThemeLabel();

function toggleTheme() {
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('be_theme6', next);
    updateThemeLabel();
    toast(next === 'light' ? '☀️' : '🌙', next === 'light' ? 'Light mode on' : 'Dark mode on');
}
function updateThemeLabel() {
    const el = document.getElementById('themeLabel');
    if (el) el.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? 'Dark Mode' : 'Light Mode';
    const btn = document.querySelector('.hbtn[onclick="toggleTheme()"]');
    if (btn) btn.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? '🌙' : '☀️';
}

// ============================
// MACRO DATA
// ============================
const macroData = [
    { label:'S&P 500', val:'5,842', chg:'+0.4%', up:true },
    { label:'VIX', val:'14.2', chg:'-1.2', up:false },
    { label:'Fed Rate', val:'5.25%', chg:'Hold', up:null },
    { label:'10Y Yield', val:'4.31%', chg:'+0.03', up:true },
];
function renderMacro() {
    const ids = ['sp500','vix','fed','t10'];
    document.getElementById('macroGrid').innerHTML = macroData.map((m,i) => `
        <div class="macro-item">
            <div class="macro-lbl">${m.label}</div>
            <div class="macro-val" style="color:var(--text-bright)" data-macro="${ids[i]}">${m.val}</div>
            <div class="macro-chg" style="color:${m.up === true ? 'var(--neon-green)' : m.up === false ? 'var(--neon-red)' : 'var(--neon-amber)'}">${m.chg}</div>
        </div>
    `).join('');
}
renderMacro();

// ============================
// CHECKLIST
// ============================
const CHECKLIST_ITEMS = [
    { id:'news', title:'Check Pre-Market News', sub:'Scan headlines for macro surprises', section:'Market Overview' },
    { id:'futures', title:'Review Futures', sub:'SPY, QQQ, IWM direction', section:'Market Overview' },
    { id:'vix', title:'Check VIX Level', sub:'High VIX = hedge positions', section:'Market Overview' },
    { id:'earnings_list', title:'Review Earnings Calendar', sub:'Note before/after market times', section:'Earnings Prep' },
    { id:'analyst', title:'Check Analyst Revisions', sub:'Any last-minute upgrades/downgrades', section:'Earnings Prep' },
    { id:'options', title:'Scan Options Flow', sub:'Look for unusual activity', section:'Earnings Prep' },
    { id:'entries', title:'Set Entry Alerts', sub:'Price alerts at optimal entry levels', section:'Trade Setup' },
    { id:'stops', title:'Set Stop Losses', sub:'Place stops before market open', section:'Trade Setup' },
    { id:'sizing', title:'Calculate Position Sizes', sub:'Risk max 2% of portfolio per trade', section:'Trade Setup' },
    { id:'journal_review', title:'Review Yesterday\'s Trades', sub:'What worked? What didn\'t?', section:'Review' },
];

function renderChecklist() {
    const sections = [...new Set(CHECKLIST_ITEMS.map(i => i.section))];
    const done = CHECKLIST_ITEMS.filter(i => checklistState[i.id]).length;
    document.getElementById('clProgressBar').style.width = (done / CHECKLIST_ITEMS.length * 100) + '%';
    document.getElementById('clProgressLabel').textContent = `${done} / ${CHECKLIST_ITEMS.length} done`;

    document.getElementById('checklistItems').innerHTML = sections.map(sec => `
        <div class="cl-section">
            <div class="cl-section-title">${sec}</div>
            ${CHECKLIST_ITEMS.filter(i => i.section === sec).map(item => `
                <div class="cl-item ${checklistState[item.id] ? 'done' : ''}" onclick="toggleCheck('${item.id}')">
                    <div class="cl-check">${checklistState[item.id] ? '✓' : ''}</div>
                    <div class="cl-text">
                        <div class="cl-item-title">${item.title}</div>
                        <div class="cl-item-sub">${item.sub}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `).join('');
}

function toggleCheck(id) {
    checklistState[id] = !checklistState[id];
    localStorage.setItem('be_checklist6', JSON.stringify(checklistState));
    if (navigator.vibrate) navigator.vibrate(10);
    renderChecklist();
}

function resetChecklist() {
    checklistState = {};
    localStorage.setItem('be_checklist6', JSON.stringify(checklistState));
    renderChecklist();
    toast('↺', 'Checklist reset');
}

function openChecklist() {
    renderChecklist();
    document.getElementById('checklistModal').classList.add('on');
}
document.getElementById('checklistModal').addEventListener('click', e => {
    if (e.target === document.getElementById('checklistModal')) document.getElementById('checklistModal').classList.remove('on');
});

// ============================
// DATA GENERATION
// ============================
// Base prices — Feb 12 2026. WMT=$132.90 and AMZN=$199.45 confirmed from user screenshots.
// Finnhub live fetch overrides ALL of these at runtime.
const COMPANIES = [
    {ticker:'NVDA', name:'NVIDIA Corporation',      sector:'Technology', basePrice:188.86, earningsDaysOut:7,  earningsTime:'After Close'},
    {ticker:'AAPL', name:'Apple Inc.',              sector:'Technology', basePrice:232.15, earningsDaysOut:82, earningsTime:'After Close'},
    {ticker:'MSFT', name:'Microsoft Corp.',         sector:'Technology', basePrice:415.50, earningsDaysOut:76, earningsTime:'After Close'},
    {ticker:'GOOGL',name:'Alphabet Inc.',           sector:'Technology', basePrice:196.20, earningsDaysOut:68, earningsTime:'After Close'},
    {ticker:'TSLA', name:'Tesla Inc.',              sector:'Automotive', basePrice:328.50, earningsDaysOut:69, earningsTime:'After Close'},
    {ticker:'AMD',  name:'Advanced Micro Devices',  sector:'Technology', basePrice:107.80, earningsDaysOut:76, earningsTime:'After Close'},
    {ticker:'META', name:'Meta Platforms Inc.',     sector:'Technology', basePrice:712.40, earningsDaysOut:68, earningsTime:'After Close'},
    {ticker:'AMZN', name:'Amazon.com Inc.',         sector:'Technology', basePrice:199.45, earningsDaysOut:69, earningsTime:'After Close'},
    {ticker:'WMT',  name:'Walmart Inc.',            sector:'Retail',     basePrice:132.90, earningsDaysOut:7,  earningsTime:'Before Open'},
    {ticker:'JPM',  name:'JPMorgan Chase',          sector:'Finance',    basePrice:263.80, earningsDaysOut:57, earningsTime:'Before Open'},
    {ticker:'BAC',  name:'Bank of America',         sector:'Finance',    basePrice:47.20,  earningsDaysOut:57, earningsTime:'Before Open'},
    {ticker:'JNJ',  name:'Johnson & Johnson',       sector:'Healthcare', basePrice:158.40, earningsDaysOut:66, earningsTime:'Before Open'},
    {ticker:'XOM',  name:'Exxon Mobil Corp.',       sector:'Energy',     basePrice:108.60, earningsDaysOut:84, earningsTime:'Before Open'},
    {ticker:'CVX',  name:'Chevron Corporation',     sector:'Energy',     basePrice:148.20, earningsDaysOut:77, earningsTime:'Before Open'},
    {ticker:'PFE',  name:'Pfizer Inc.',             sector:'Healthcare', basePrice:24.85,  earningsDaysOut:84, earningsTime:'Before Open'},
];

const NEWS_BANK = {
    Technology: [
        ['AI chip demand surpasses supply forecasts for Q3','Reuters','2h ago',true],
        ['Cloud spending growth accelerates as enterprises expand AI','Bloomberg','4h ago',true],
        ['Semiconductor stocks rally ahead of earnings season','CNBC','5h ago',true],
        ['Tech layoffs slow as sector stabilizes after 2023 cuts','WSJ','7h ago',null],
        ['New export restrictions could crimp chip revenues','FT','8h ago',false],
    ],
    Finance: [
        ['Fed minutes suggest rate cuts still months away','Bloomberg','1h ago',false],
        ['Bank earnings expected to show resilient NIM margins','Reuters','3h ago',true],
        ['Credit card delinquencies tick higher but remain manageable','WSJ','5h ago',null],
        ['Investment banking revenue rebounds on deal activity','CNBC','6h ago',true],
    ],
    Healthcare: [
        ['FDA fast-tracks new oncology drug approval','Reuters','2h ago',true],
        ['Drug pricing pressure eases with new Medicare negotiations','Bloomberg','4h ago',null],
        ['Biotech M&A activity expected to surge in H2','CNBC','6h ago',true],
    ],
    Energy: [
        ['Oil prices rise on OPEC+ supply cut extension','Reuters','1h ago',true],
        ['Natural gas demand surges on unseasonable cold','Bloomberg','3h ago',true],
        ['Refinery margins compress as crude spreads tighten','WSJ','5h ago',false],
    ],
    Retail: [
        ['Consumer spending holds steady despite inflation concerns','Bloomberg','2h ago',null],
        ['E-commerce growth re-accelerates post-holiday lull','CNBC','4h ago',true],
        ['Inventory levels normalizing, margin recovery expected','Reuters','6h ago',true],
    ],
    Automotive: [
        ['EV demand faces near-term headwinds from interest rates','Reuters','2h ago',false],
        ['Lithium prices fall, improving EV battery cost outlook','Bloomberg','4h ago',true],
        ['Autonomous driving regulatory framework moves forward','CNBC','7h ago',true],
    ],
    'E-commerce': [
        ['Online retail market share continues to grow vs brick-and-mortar','Bloomberg','2h ago',true],
        ['Logistics costs falling, boosting e-commerce margins','Reuters','5h ago',true],
    ],
};

const ANALYST_NAMES = [
    ['Mark Lipacis','Jefferies'],['Joseph Moore','Morgan Stanley'],['Timothy Arcuri','UBS'],
    ['Vivek Arya','BofA Securities'],['C.J. Muse','Evercore ISI'],['Stacy Rasgon','Bernstein'],
    ['Harlan Sur','JPMorgan'],['Ross Seymore','Deutsche Bank'],['Blayne Curtis','Barclays'],
    ['Toshiya Hari','Goldman Sachs'],['Pierre Ferragu','New Street Research'],['Karl Keirstead','UBS'],
    ['Brad Zelnick','Deutsche Bank'],['Keith Weiss','Morgan Stanley'],['Mark Moerdler','Bernstein'],
];
const ANALYST_COMMENTS = {
    buy: ['Expect strong beat driven by data center demand; raise PT.','Best-in-class execution; AI tailwinds underappreciated by consensus.','Channel checks suggest upside; reiterate as top pick.','Margin expansion story intact; multiple re-rating ahead.'],
    hold: ['Fair value near current price; await clearer guidance.','Balanced risk/reward; monitoring macro sensitivity.','Solid business but upside largely priced in at current levels.','Neutral stance on near-term uncertainty; long-term thesis intact.'],
    sell: ['Consensus too optimistic; see 15-20% downside to estimates.','Competitive pressure intensifying; multiple compression likely.','Supply constraints and ASP headwinds underestimated by Street.','Guidance reset risk into the print; step aside.'],
};
const BULL_CASES = [
    'AI and data center demand accelerating beyond consensus. Margin expansion to 60%+ gross margins as mix shifts to premium products.',
    'Market share gains in core segment. Cloud re-acceleration driving multiple expansion and sustainable double-digit revenue CAGR.',
    'New product cycle underway — pricing power and volume recovery driving EPS upside. FCF generation at record pace.',
    'Structural tailwinds from secular digitization. Customer retention above 95%; net revenue retention expanding.',
];
const BEAR_CASES = [
    'Valuation stretched at 35x forward earnings. Any guidance miss could trigger sharp de-rating across the sector.',
    'Customer concentration risk with top 3 accounts ~40% of revenue. Macro softness could cause rapid order deferrals.',
    'Competitive threat from low-cost entrants underappreciated. Margin headwinds building from rising input costs.',
    'Inventory digestion cycle not yet complete. Estimates still too high; see 10-15% downside to current consensus.',
];

function genAnalystData(overallScore, price) {
    const isBull = overallScore > 62;
    const isNeut = overallScore > 38 && overallScore <= 62;
    const p = parseFloat(price);
    // consensus distribution
    const sb = isBull ? rndI(8,18) : isNeut ? rndI(2,8) : rndI(0,4);
    const b  = isBull ? rndI(12,22) : isNeut ? rndI(8,15) : rndI(2,8);
    const h  = isNeut ? rndI(10,18) : rndI(4,14);
    const s  = isBull ? rndI(1,5) : isNeut ? rndI(3,8) : rndI(8,14);
    const ss = isBull ? rndI(0,3) : isNeut ? rndI(1,5) : rndI(4,10);
    const total = sb + b + h + s + ss;
    const verdictScore = (sb*2 + b*1 + h*0 + s*-1 + ss*-2) / total;
    const verdict = verdictScore > 0.8 ? 'STRONG BUY' : verdictScore > 0.3 ? 'BUY' : verdictScore > -0.3 ? 'HOLD' : 'SELL';
    const verdictColor = verdictScore > 0.3 ? 'var(--neon-green)' : verdictScore > -0.3 ? 'var(--neon-amber)' : 'var(--neon-red)';
    // price targets
    const ptLow = (p * rnd(0.82, 0.94)).toFixed(2);
    const ptMed = (p * rnd(1.05, 1.25)).toFixed(2);
    const ptHigh = (p * rnd(1.30, 1.65)).toFixed(2);
    const ptConsensus = (p * rnd(1.08, 1.20)).toFixed(2);
    const upside = (((ptConsensus - p) / p) * 100).toFixed(1);
    // individual analysts (3-4)
    const count = rndI(3,5);
    const picked = [...ANALYST_NAMES].sort(() => Math.random()-0.5).slice(0, count);
    const ratings = ['Strong Buy','Buy','Outperform','Hold','Underperform','Sell'];
    const ratingClasses = {'Strong Buy':'ac-buy','Buy':'ac-buy','Outperform':'ac-outperform','Hold':'ac-hold','Underperform':'ac-underperform','Sell':'ac-sell'};
    const analysts = picked.map(([name, firm]) => {
        const isABull = Math.random() < (isBull ? 0.75 : 0.45);
        const rating = isABull ? ratings[rndI(0,3)] : ratings[rndI(3,6)];
        const pt = (p * rnd(isABull ? 1.05 : 0.85, isABull ? 1.55 : 1.05)).toFixed(2);
        const ptChange = rnd(-8, 15).toFixed(0);
        const comment = isABull ? ANALYST_COMMENTS.buy[rndI(0,4)] : rating === 'Hold' ? ANALYST_COMMENTS.hold[rndI(0,4)] : ANALYST_COMMENTS.sell[rndI(0,4)];
        return { name, firm, rating, ratingClass: ratingClasses[rating], pt, ptChange, comment };
    });
    // bull/bear cases
    const bullCase = BULL_CASES[rndI(0,4)];
    const bearCase = BEAR_CASES[rndI(0,4)];
    const bullPT = (p * rnd(1.35, 1.80)).toFixed(2);
    const bearPT = (p * rnd(0.70, 0.90)).toFixed(2);
    return { sb, b, h, s, ss, total, verdict, verdictColor, ptLow, ptMed, ptHigh, ptConsensus, upside, analysts, bullCase, bearCase, bullPT, bearPT };
}

function genNews(sector) {
    const pool = NEWS_BANK[sector] || NEWS_BANK.Technology;
    return pool.slice(0, 3 + Math.floor(Math.random() * 2));
}

function rnd(a, b) { return Math.random() * (b - a) + a; }
function rndI(a, b) { return Math.floor(rnd(a, b)); }

function calcRSI(closes, period=14) {
    const rsi = new Array(closes.length).fill(null);
    if (closes.length < period+1) return rsi;
    let gains=0, losses=0;
    for (let i=1; i<=period; i++) { const d=closes[i]-closes[i-1]; d>0?gains+=d:losses-=d; }
    let ag=gains/period, al=losses/period;
    rsi[period] = al===0 ? 100 : 100 - 100/(1+ag/al);
    for (let i=period+1; i<closes.length; i++) {
        const d=closes[i]-closes[i-1];
        ag=(ag*(period-1)+(d>0?d:0))/period;
        al=(al*(period-1)+(d<0?-d:0))/period;
        rsi[i]=al===0?100:100-100/(1+ag/al);
    }
    return rsi;
}
function calcBB(closes, period=20, stdMult=2) {
    return closes.map((_,i) => {
        if (i < period-1) return {mid:null,upper:null,lower:null};
        const slice=closes.slice(i-period+1,i+1);
        const mid=slice.reduce((a,b)=>a+b)/period;
        const std=Math.sqrt(slice.reduce((a,b)=>a+(b-mid)**2,0)/period);
        return {mid,upper:mid+stdMult*std,lower:mid-stdMult*std};
    });
}
function genPriceHistory(base) {
    let p = base * rnd(0.85, 0.95);
    const opens=[], highs=[], lows=[], closes=[], vols=[];
    for (let i = 40; i >= 0; i--) {
        const d = rnd(-0.025, 0.025);
        const o = p, c = p * (1+d);
        opens.push(o); highs.push(Math.max(o,c)*rnd(1.001,1.015));
        lows.push(Math.min(o,c)*rnd(0.985,0.999)); closes.push(c);
        vols.push(rndI(8e6, 80e6)); p = c;
    }
    const ma20 = closes.map((_,i) => i < 19 ? null : closes.slice(i-19,i+1).reduce((a,b)=>a+b)/20);
    const ma50 = closes.map((_,i) => i < 49 ? null : closes.slice(i-49,i+1).reduce((a,b)=>a+b)/50);
    const vwap = closes.map((_,i) => {
        const sc=closes.slice(0,i+1),sv=vols.slice(0,i+1),tv=sv.reduce((a,b)=>a+b,0);
        return sc.reduce((a,c,j)=>a+c*sv[j],0)/tv;
    });
    const rsi = calcRSI(closes);
    const bb = calcBB(closes);
    return { opens, highs, lows, closes, vols, ma20, ma50, vwap, rsi, bb, sResist:Math.max(...closes.slice(-20)), sSupport:Math.min(...closes.slice(-20)) };
}

function computeEntry(stock) {
    const {sSupport, sResist} = stock.ph;
    const cur = parseFloat(stock.price);
    const range = sResist - sSupport;
    const optimalEntry = Math.max(sSupport * 1.005, cur * rnd(0.97,1.0)).toFixed(2);
    const t1 = (parseFloat(optimalEntry) + range * rnd(0.3,0.45)).toFixed(2);
    const t2 = (parseFloat(optimalEntry) + range * rnd(0.55,0.8)).toFixed(2);
    const stopLoss = (sSupport * rnd(0.97,0.99)).toFixed(2);
    const reward = parseFloat(t1) - parseFloat(optimalEntry);
    const risk = parseFloat(optimalEntry) - parseFloat(stopLoss);
    const rr = (reward / Math.max(risk, 0.01)).toFixed(1);
    const days = Math.max(0, Math.ceil((stock.earningsDate - Date.now()) / 86400000));
    let entryWindow, strategy;
    if (days <= 1) { entryWindow={start:0.1,width:0.15}; strategy=`Earnings imminent. Small position near $${optimalEntry}, tight stop at $${stopLoss}. Watch options flow for direction.`; }
    else if (days <= 3) { entryWindow={start:0.25,width:0.25}; strategy=`Enter near $${optimalEntry} over 1-3 sessions. Scale in 50% now, add on confirmation. Stop $${stopLoss}, T1 $${t1}.`; }
    else { entryWindow={start:0.4,width:0.35}; strategy=`3-tranche entry near $${optimalEntry}: 30% now, 40% on dip to support, 30% on breakout. Full stop at $${stopLoss}.`; }
    return {optimalEntry, t1, t2, stopLoss, rr, entryWindow, strategy};
}

function computePositionSize(stock) {
    const riskPct = 2;
    const entry = parseFloat(stock.entry.optimalEntry);
    const stop = parseFloat(stock.entry.stopLoss);
    const riskPerShare = entry - stop;
    const dollarRisk = portfolioBalance * (riskPct / 100);
    const shares = Math.floor(dollarRisk / Math.max(riskPerShare, 0.01));
    const positionValue = shares * entry;
    const pctOfPortfolio = (positionValue / portfolioBalance * 100).toFixed(1);
    return { shares, positionValue: positionValue.toFixed(0), pctOfPortfolio, dollarRisk: dollarRisk.toFixed(0), riskPerShare: riskPerShare.toFixed(2) };
}

function genAI(score) {
    return {
        prediction: score > 66 ? 'BULLISH' : score > 33 ? 'NEUTRAL' : 'BEARISH',
        predClass: score > 66 ? 'bull' : score > 33 ? 'neut' : 'bear',
        expectedMove: rnd(-8, 18).toFixed(1),
        confidence: Math.min(95, 55 + score * 0.35).toFixed(0),
        impliedMove: rnd(3, 18).toFixed(1),
        whisperGap: rnd(-8, 12).toFixed(1),
        earningsQuality: rnd(4, 9.5).toFixed(1),
        darkPool: rnd(0, 100).toFixed(0),
        revMomentum: rnd(-5, 15).toFixed(1),
        guidanceUp: rnd(20, 85).toFixed(0),
        smartMoney: rnd(-30, 100).toFixed(0),
        sentPos: rndI(25, 72),
        sentNeu: rndI(10, 30),
        sentNeg: rndI(5, 25),
        analystRevUp: rndI(0, 7),
        analystRevDown: rndI(0, 3),
        analystRevMaint: rndI(3, 15),
        insiderBuying: Math.random() > 0.6,
        insiderAmt: rnd(0.5, 8).toFixed(1),
        unusualOptions: Math.random() > 0.55,
        callPutRatio: rnd(0.6, 2.8).toFixed(2),
        beatStreak: rndI(0, 6),
    };
}

function genStock(company) {
    const surprise=rnd(-5,25), revenue=rnd(-8,35), analyst=rnd(3,5), techMomentum=rnd(-12,28), vol=rnd(-15,80);
    const sS=Math.max(0,Math.min(100,(surprise+5)*3.33));
    const sR=Math.max(0,Math.min(100,(revenue+8)*2.7));
    const sA=((analyst-3)/2)*100;
    const sTech=(Math.max(0,Math.min(100,(techMomentum+12)*2.8))+Math.max(0,Math.min(100,(vol+15)*1.2)))/2;
    const overall=sS*(weights.surp/100)+sR*(weights.rev/100)+sA*(weights.ana/100)+sTech*(weights.tech/100);
    // Use exact base price — live Finnhub fetch will update momentum at runtime
    const price = (company.basePrice || rnd(50,400)).toFixed(2);
    // Daily change = 0 until live data arrives
    const momentum = 0;
    const dollarChange = '0.00';
    // Real earnings date from company data
    const daysOut = company.earningsDaysOut != null ? company.earningsDaysOut : rndI(1,14);
    const earningsDate = new Date(Date.now() + daysOut * 86400000);
    const ph=genPriceHistory(parseFloat(price));
    const stock={
        ...company, price, earningsDate, dollarChange,
        earningsTime: company.earningsTime || ['Before Open','After Close'][rndI(0,2)],
        expectedEPS:rnd(0.5,8).toFixed(2),
        surprise:surprise.toFixed(1), revenue:revenue.toFixed(1),
        analystRating:analyst.toFixed(1), analystCount:rndI(12,45),
        peRatio:rnd(8,55).toFixed(1), institutional:rnd(45,92).toFixed(1),
        shortInt:rnd(1,18).toFixed(1), momentum:momentum.toFixed(1),
        risk:Math.max(0,Math.min(100,rnd(15,70))).toFixed(0),
        confidence:Math.min(100,55+rnd(0,40)).toFixed(0),
        scores:{surp:sS.toFixed(0),rev:sR.toFixed(0),ana:sA.toFixed(0),tech:sTech.toFixed(0),overall:overall.toFixed(0)},
        ph,
        news: genNews(company.sector),
        analystData: genAnalystData(overall, price),
    };
    stock.ai=genAI(overall);
    stock.entry=computeEntry(stock);
    stock.posSize=computePositionSize(stock);
    stock.earningsHistory=genEarningsHistory(overall);
    stock.optionsChain=genOptionsChain(price, stock.ai.impliedMove);
    return stock;
}

// ============================
// COUNTER ANIMATION
// ============================
function animateCounter(el, target, duration=800, isFloat=false) {
    const start = performance.now();
    const from = 0;
    function step(now) {
        const elapsed = now - start;
        const progress = Math.min(elapsed / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 3);
        const current = from + (target - from) * ease;
        el.textContent = isFloat ? current.toFixed(1) : Math.round(current);
        if (progress < 1) requestAnimationFrame(step);
        else el.textContent = isFloat ? target.toFixed(1) : target;
    }
    requestAnimationFrame(step);
}

function flashElement(el, isPositive = true) {
    el.classList.remove('flash', 'flash-red');
    void el.offsetWidth;
    el.classList.add(isPositive ? 'flash' : 'flash-red');
    if (navigator.vibrate) navigator.vibrate(6);
}

// ============================
// MAIN ANALYSIS
// ============================
function applyLiveData(s, chart, summary) {
    if (chart && chart.price > 0) {
        s.price       = chart.price.toFixed(2);
        s.momentum    = Math.max(-25, Math.min(25, chart.pct || 0)).toFixed(2);
        s.dollarChange = (chart.change || 0).toFixed(2);
        s.volume      = chart.volume;
        s.marketCap   = chart.marketCap;
        s.high52      = chart.high52;
        s.low52       = chart.low52;
        // Replace fake chart with real OHLCV if we have enough bars
        if (chart.timestamps?.length > 5) {
            s.ohlcv = chart.timestamps.map((t, i) => ({
                t: t * 1000,
                o: chart.open[i],
                h: chart.high[i],
                l: chart.low[i],
                c: chart.close[i],
                v: chart.volume_arr[i]
            })).filter(bar => bar.c != null && bar.c > 0);
            // Also update the mini chart price history from real closes
            s.ph = buildPhFromOhlcv(s.ohlcv, parseFloat(s.price));
        } else {
            s.ph = genPriceHistory(parseFloat(s.price));
        }
        s.analystData = genAnalystData(parseFloat(s.scores.overall), s.price);
        s.entry       = computeEntry(s);
        s.posSize     = computePositionSize(s);
        s.optionsChain = genOptionsChain(s.price, s.ai.impliedMove);
        s._live = true;
    }
    if (summary) {
        if (summary.earningsDate) {
            s.earningsDate = summary.earningsDate;
            s.earningsTime = summary.earningsTime;
        }
        if (summary.pe  && summary.pe  !== '--') s.peRatio   = summary.pe;
        if (summary.eps && summary.eps !== '--') s.expectedEPS = summary.eps;
        if (summary.revenueGrowth && summary.revenueGrowth !== '--') s.revenueGrowth = summary.revenueGrowth;
        if (summary.profitMargin  && summary.profitMargin  !== '--') s.profitMargin  = summary.profitMargin;
        if (summary.targetMean) s.analystData.targets.mean = summary.targetMean.toFixed(2);
        if (summary.targetHigh) s.analystData.targets.high = summary.targetHigh.toFixed(2);
        if (summary.targetLow)  s.analystData.targets.low  = summary.targetLow.toFixed(2);
        s._summaryLive = true;
    }
}

// Build price history array from real OHLCV data for mini chart
function buildPhFromOhlcv(ohlcv, currentPrice) {
    if (!ohlcv || ohlcv.length === 0) return genPriceHistory(currentPrice);
    const closes = ohlcv.map(b => b.c).filter(c => c > 0);
    const last = closes[closes.length - 1] || currentPrice;
    return closes.map((c, i) => {
        const prev = closes[i - 1] || c;
        return {
            open: prev, close: c,
            high: Math.max(prev, c) * (1 + Math.random() * 0.005),
            low:  Math.min(prev, c) * (1 - Math.random() * 0.005),
            vol:  Math.round(Math.random() * 1000000 + 500000)
        };
    });
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function runAnalysis() {
    const btn  = document.getElementById('analyzeBtn');
    const txt  = document.getElementById('btnText');
    const prog = document.getElementById('scanProgress');
    btn.classList.add('scanning');
    txt.textContent = '⚡ SCANNING MARKETS...';

    document.getElementById('stockList').innerHTML = [1,2,3].map(() => `
        <div class="skel-card">
            <div class="skel-row"><div class="skeleton skel-title"></div><div class="skeleton skel-score"></div></div>
            <div class="skeleton skel-chart"></div>
            <div class="skel-grid">${[1,2,3].map(()=>`<div class="skeleton skel-metric"></div>`).join('')}</div>
            <div class="skeleton skel-bar" style="width:100%"></div>
            <div class="skeleton skel-bar" style="width:80%"></div>
            <div class="skeleton skel-bar" style="width:90%"></div>
        </div>`).join('');

    prog.style.width = '15%';
    txt.textContent  = '📊 GENERATING ANALYSIS...';
    await sleep(300);

    // Step 1: Generate base stocks with accurate base prices
    stocks = COMPANIES.map(genStock);
    stocks.sort((a,b)=>parseFloat(b.scores.overall)-parseFloat(a.scores.overall));
    prog.style.width = '25%';

    // Step 2: Apply cached data instantly (zero network calls)
    let liveCount = 0;
    stocks.forEach(s => {
        const chart   = priceCache[s.ticker];
        const summary = priceCache[s.ticker + '_summary'];
        if (chart && (Date.now() - chart.ts) < PRICE_CACHE_TTL) {
            applyLiveData(s, chart, summary);
            if (s._live) liveCount++;
        }
    });

    // Step 3: Fetch current prices via REST API, then connect WebSocket for live updates
    const needFetch = stocks.filter(s => !s._live);
    prog.style.width = '35%';

    if (needFetch.length > 0) {
        const banner = document.getElementById('apiBannerText');
        const apiBanner = document.getElementById('apiBanner');
        
        // Phase 1: Fetch latest quotes via REST (works 24/7, including after-hours)
        txt.textContent = '📡 FETCHING LATEST PRICES...';
        if (banner) banner.textContent = '📡 Loading latest quotes via Finnhub REST API...';

        const quotesLoaded = await fetchInitialQuotes();
        
        if (quotesLoaded > 0) {
            liveCount = quotesLoaded;
            console.log(`✅ Loaded ${quotesLoaded} quotes via REST API`);
            
            // Mark all stocks as live
            needFetch.forEach(s => s._live = true);
            
            if (apiBanner) apiBanner.className = 'api-banner live';
            if (banner) banner.textContent = `🟢 ${quotesLoaded} live prices loaded`;
        } else {
            if (apiBanner) apiBanner.className = 'api-banner mock';
            if (banner) banner.textContent = '⚠️ Using base prices · Finnhub unavailable';
        }
        
        prog.style.width = '60%';
        
        // Phase 2: Connect WebSocket for real-time streaming (market hours only)
        if (quotesLoaded > 0) {
            txt.textContent = '📡 CONNECTING LIVE STREAM...';
            if (banner) banner.textContent = '📡 Connecting WebSocket for real-time updates...';
            
            try {
                await connectPriceStream();
                if (apiBanner) apiBanner.className = 'api-banner live';
                if (banner) banner.textContent = `🟢 Live · ${liveCount} stocks streaming`;
                console.log('✅ WebSocket streaming active');
            } catch(e) {
                console.warn('WebSocket failed, continuing with REST quotes only');
                if (banner) banner.textContent = `🟢 ${liveCount} live prices (REST API only)`;
            }
        }
        
        prog.style.width = '85%';
    }



    // Step 4: FRED macro
    if (apiKeys.fred) {
        try {
            const macro = await fetchFredMacro();
            if (macro) {
                ['vix','fed','t10'].forEach(key => {
                    const el = document.querySelector(`[data-macro="${key}"]`);
                    if (el) el.textContent = key === 'vix' ? macro.vix.toFixed(1) : macro[key].toFixed(2)+'%';
                });
            }
        } catch(e) {}
    }

    prog.style.width = '100%';
    const banner    = document.getElementById('apiBannerText');
    const apiBanner = document.getElementById('apiBanner');
    if (liveCount > 0 && priceSocket) {
        if (apiBanner) apiBanner.className = 'api-banner live';
        if (banner) banner.textContent = `🟢 Live · ${liveCount} stocks streaming`;
    } else if (liveCount > 0) {
        if (apiBanner) apiBanner.className = 'api-banner mock';
        if (banner) banner.textContent = `📊 ${liveCount} stocks analyzed`;
    } else {
        if (apiBanner) apiBanner.className = 'api-banner mock';
        if (banner) banner.textContent = `📊 Analysis complete`;
    }

    setTimeout(() => {
        prog.style.width = '0%';
        btn.classList.remove('scanning');
        txt.textContent = '🔄 RE-ANALYZE';
        renderStocks();
        updateStats();
        renderHeatmap();
        renderRotation();
        renderPortfolio();
        renderEarningsCalendar();
        const msg = priceSocket ? `🟢 Live streaming active` : `📊 ${liveCount} stocks analyzed`;
        toast('✓', msg);
    }, 300);
}

// ============================
// RENDER STOCKS
// ============================
function renderStocks() {
    Object.values(stockCharts).forEach(c=>{try{c.destroy();}catch(e){}});
    stockCharts={};
    const list=document.getElementById('stockList');
    let filtered=activeFilter==='all'?stocks:stocks.filter(s=>s.sector===activeFilter);
    const sortVal=document.getElementById('sortSel').value;
    filtered=[...filtered].sort((a,b)=>{
        switch(sortVal){
            case 'surprise': return parseFloat(b.scores.surp)-parseFloat(a.scores.surp);
            case 'revenue': return parseFloat(b.scores.rev)-parseFloat(a.scores.rev);
            case 'confidence': return parseFloat(b.confidence)-parseFloat(a.confidence);
            case 'risk': return parseFloat(a.risk)-parseFloat(b.risk);
            case 'rr': return parseFloat(b.entry.rr)-parseFloat(a.entry.rr);
            default: return parseFloat(b.scores.overall)-parseFloat(a.scores.overall);
        }
    });
    // Screen filter
    if (screenActive) {
        filtered = filtered.filter(s =>
            parseFloat(s.scores.overall) >= screenFilters.score &&
            parseFloat(s.entry.rr) >= screenFilters.rr &&
            parseFloat(s.risk) <= screenFilters.risk &&
            parseFloat(s.confidence) >= screenFilters.conf &&
            (screenFilters.sectors.length===0 || screenFilters.sectors.includes(s.sector))
        );
    }
    // Pinned first
    filtered.sort((a,b)=>{
        const pa=pinnedStocks.has(a.ticker)?0:1, pb=pinnedStocks.has(b.ticker)?0:1;
        return pa-pb;
    });
    if(!filtered.length){list.innerHTML=`<div class="empty"><div class="empty-ico">🔍</div><div class="empty-t">No stocks match</div></div>`;return;}
    list.innerHTML=filtered.map((s,i)=>buildSwipeCard(s,i+1)).join('');
    requestAnimationFrame(()=>{
        filtered.forEach(s=>{
            drawChart(s, chartTFs[s.ticker]||'1W');
            // animate score
            const scoreEl=document.querySelector(`#card-${s.ticker} .main-score`);
            if(scoreEl) animateCounter(scoreEl, parseFloat(s.scores.overall));
            // animate score bars
            document.querySelectorAll(`#card-${s.ticker} .sbar-fill`).forEach(bar=>{
                const w=bar.style.width;
                bar.style.width='0%';
                requestAnimationFrame(()=>{ setTimeout(()=>bar.style.width=w, 100); });
            });
            // flash key metrics
            setTimeout(()=>{
                const vals=document.querySelectorAll(`#card-${s.ticker} .mbox-value`);
                vals.forEach((el,i)=>setTimeout(()=>flashElement(el, !el.classList.contains('neg')), i*80));
            }, 600);
        });
        initSwipes();
        startCountdowns();
        addCardClickHandlers();
    });
}

function buildSwipeCard(s,rank) {
    const isTop=rank<=3;
    const rankClass=rank===1?'gold':rank===2?'silver':rank===3?'bronze':'';
    const riskLv=s.risk<33?'LOW':s.risk<66?'MED':'HIGH';
    const isWatched=watchlist.has(s.ticker);
    const rrClass=parseFloat(s.entry.rr)>=2?'rr-good':parseFloat(s.entry.rr)>=1.2?'rr-ok':'rr-bad';
    const ai=s.ai, en=s.entry, sz=s.posSize;
    const dDays=Math.max(0,Math.ceil((s.earningsDate-Date.now())/86400000));

    const newsHtml=s.news.map(n=>`
        <div class="news-item">
            <div class="news-sentiment" style="background:${n[3]===true?'var(--neon-green)':n[3]===false?'var(--neon-red)':'var(--neon-amber)'}"></div>
            <div class="news-body">
                <div class="news-headline">${n[0]}</div>
                <div class="news-meta"><span class="news-source">${n[1]}</span><span>${n[2]}</span></div>
            </div>
        </div>
    `).join('');

    const ad=s.analystData;

    return `<div class="swipe-wrap" id="swipe-${s.ticker}">
        <div class="swipe-hint-watch">⭐</div>
        <div class="swipe-hint-trade">💼</div>
        <div class="swipe-card-inner">
        <div class="stock-card ${isTop?'top-pick':''} ${pinnedStocks.has(s.ticker)?'pinned':''}" id="card-${s.ticker}" data-ticker="${s.ticker}">
        <div class="pin-strip"></div>
        <div class="card-top-bar"></div>
        <div class="card-inner">
            <div class="card-head">
                <div class="card-left">
                    <div class="rank-tag ${rankClass}">${rank===1?'🥇':rank===2?'🥈':rank===3?'🥉':''} #${rank}</div>
                    <div class="card-ticker">${s.ticker}</div>
                    <div class="card-name">${s.name}</div>
                    <div id="cd-${s.ticker}" class="countdown-badge weeks"><span class="cd-text">⏱ Loading...</span></div>
                    <div class="tag-row">
                        <span class="tag tag-sector sector-tag" onclick="sectorTagClick(event,'${s.sector}')">${s.sector}</span>
                        <span class="tag tag-time">${s.earningsTime}</span>
                    </div>
                </div>
                <div class="card-right">
                    <div class="main-score" id="score-${s.ticker}">0</div>
                    <div class="score-row">
                        <span class="score-dot">S:${s.scores.surp}</span>
                        <span class="score-dot">R:${s.scores.rev}</span>
                        <span class="score-dot">A:${s.scores.ana}</span>
                        <span class="score-dot">T:${s.scores.tech}</span>
                    </div>
                </div>
            </div>

            <!-- CHART -->
                <div class="chart-wrap" id="cw-${s.ticker}">
                    <div class="chart-price-header">
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="cph-price"><sup>$</sup>${s.price}</div>
                            ${s._live ? '<span style="font-family:\'IBM Plex Mono\',monospace;font-size:9px;font-weight:700;background:rgba(0,255,163,0.15);color:var(--neon-green);border:1px solid rgba(0,255,163,0.3);border-radius:4px;padding:2px 6px;letter-spacing:0.5px">LIVE</span>' : ''}
                        </div>
                        <div class="cph-change ${parseFloat(s.momentum)>=0?'pos':'neg'}">
                            <span class="arr">${parseFloat(s.momentum)>=0?'↗':'↘'}</span>
                            ${s.dollarChange!=null&&parseFloat(s.dollarChange)!==0 ? (parseFloat(s.dollarChange)>0?'+':'')+s.dollarChange+' ' : ''}(${parseFloat(s.momentum)>=0?'+':''}${s.momentum}%) today
                        </div>
                    </div>
                    <div class="chart-ind-row">
                        <div class="ind-chip ma20" id="ind-ma20-${s.ticker}" onclick="toggleInd('${s.ticker}','ma20')">MA20</div>
                        <div class="ind-chip ma50" id="ind-ma50-${s.ticker}" onclick="toggleInd('${s.ticker}','ma50')">MA50</div>
                        <div class="ind-chip vwap" id="ind-vwap-${s.ticker}" onclick="toggleInd('${s.ticker}','vwap')">VWAP</div>
                        <div class="ind-chip bb" id="ind-bb-${s.ticker}" onclick="toggleInd('${s.ticker}','bb')">BB</div>
                    </div>
                    <div class="chart-canvas-main"><canvas id="ch-${s.ticker}"></canvas></div>
                    <div class="rsi-label">
                        <div class="rsi-title">RSI (14)</div>
                        <div class="rsi-val" id="rsi-val-${s.ticker}" style="color:var(--neon-amber)">—</div>
                    </div>
                    <div class="chart-canvas-rsi"><canvas id="rsi-${s.ticker}"></canvas></div>
                    <div class="tf-bar">
                        <button class="tf-btn" onclick="setTF('${s.ticker}','1D',this)">1D</button>
                        <button class="tf-btn on" onclick="setTF('${s.ticker}','1W',this)">1W</button>
                        <button class="tf-btn" onclick="setTF('${s.ticker}','1M',this)">1M</button>
                        <button class="tf-btn" onclick="setTF('${s.ticker}','3M',this)">3M</button>
                        <button class="tf-btn" onclick="setTF('${s.ticker}','1Y',this)">1Y</button>
                        <button class="tf-btn" onclick="setTF('${s.ticker}','MAX',this)">MAX</button>
                    </div>
                    <div class="chart-stats-row">
                        <div class="csr-item"><div class="csr-label">Support</div><div class="csr-value">$${s.ph.sSupport.toFixed(2)}</div><div class="csr-sub pos">Floor</div></div>
                        <div class="csr-item"><div class="csr-label">Resist</div><div class="csr-value">$${s.ph.sResist.toFixed(2)}</div><div class="csr-sub neg">Ceiling</div></div>
                        <div class="csr-item"><div class="csr-label">Imp.Move</div><div class="csr-value">±${ai.impliedMove}%</div><div class="csr-sub" style="color:var(--neon-amber)">Options</div></div>
                        <div class="csr-item"><div class="csr-label">Volume</div><div class="csr-value">${(s.ph.vols[s.ph.vols.length-1]/1e6).toFixed(1)}M</div><div class="csr-sub" style="color:var(--text-ghost)">Today</div></div>
                    </div>
                </div>
            </div>

            <!-- METRICS -->
            <div class="metrics-grid">
                <div class="mbox ${parseFloat(s.surprise)>0?'green':'red'}"><div class="mbox-label">Surprise</div><div class="mbox-value ${parseFloat(s.surprise)>0?'pos':'neg'}">${s.surprise}%</div><div class="mbox-sub">Historical</div></div>
                <div class="mbox ${parseFloat(s.revenue)>0?'green':'red'}"><div class="mbox-label">Revenue</div><div class="mbox-value ${parseFloat(s.revenue)>0?'pos':'neg'}">${s.revenue}%</div><div class="mbox-sub">YoY</div></div>
                <div class="mbox blue"><div class="mbox-label">P/E</div><div class="mbox-value">${s.peRatio}</div><div class="mbox-sub">EPS $${s.expectedEPS}</div></div>
                <div class="mbox amber"><div class="mbox-label">Short</div><div class="mbox-value ${parseFloat(s.shortInt)>10?'neg':'pos'}">${s.shortInt}%</div><div class="mbox-sub">Of float</div></div>
                <div class="mbox cyan"><div class="mbox-label">Instit.</div><div class="mbox-value">${s.institutional}%</div><div class="mbox-sub">Owned</div></div>
                <div class="mbox purple"><div class="mbox-label">Risk</div><div class="mbox-value" style="color:${s.risk<33?'var(--neon-green)':s.risk<66?'var(--neon-amber)':'var(--neon-red)'}">${riskLv}</div><div class="mbox-sub">Conf:${s.confidence}%</div></div>
            </div>

            <!-- SCORE BARS -->
            <div class="score-bars">
                <div class="sbar-item"><div class="sbar-label">Earnings</div><div class="sbar-track"><div class="sbar-fill" style="width:${s.scores.surp}%"></div></div><div class="sbar-nums"><div class="sbar-val">${s.scores.surp}</div><div class="sbar-pct">/100</div></div></div>
                <div class="sbar-item"><div class="sbar-label">Revenue</div><div class="sbar-track"><div class="sbar-fill" style="width:${s.scores.rev}%"></div></div><div class="sbar-nums"><div class="sbar-val">${s.scores.rev}</div><div class="sbar-pct">/100</div></div></div>
                <div class="sbar-item"><div class="sbar-label">Analyst</div><div class="sbar-track"><div class="sbar-fill" style="width:${s.scores.ana}%"></div></div><div class="sbar-nums"><div class="sbar-val">${s.scores.ana}</div><div class="sbar-pct">/100</div></div></div>
                <div class="sbar-item"><div class="sbar-label">Technical</div><div class="sbar-track"><div class="sbar-fill" style="width:${s.scores.tech}%"></div></div><div class="sbar-nums"><div class="sbar-val">${s.scores.tech}</div><div class="sbar-pct">/100</div></div></div>
            </div>

            <!-- NEWS -->
            <div class="news-section">
                <div class="news-title">📰 Latest News</div>
                ${newsHtml}
            </div>

            <!-- ANALYST PREDICTIONS -->
            <div class="analyst-section">
                <div class="analyst-tag">🔬 ANALYST PREDICTIONS</div>

                <!-- Consensus bar -->
                <div class="consensus-block">
                    <div class="cb-top">
                        <div class="cb-verdict" style="color:${ad.verdictColor}">${ad.verdict}</div>
                        <div class="cb-count">${ad.total} analysts</div>
                    </div>
                    <div class="consensus-bar">
                        <div class="cb-sb" style="flex:${ad.sb}"></div>
                        <div class="cb-b" style="flex:${ad.b}"></div>
                        <div class="cb-h" style="flex:${ad.h}"></div>
                        <div class="cb-s" style="flex:${ad.s}"></div>
                        <div class="cb-ss" style="flex:${ad.ss}"></div>
                    </div>
                    <div class="cb-legend">
                        <div class="cb-leg-item"><div class="cb-dot" style="background:#00ffa3"></div>${ad.sb} Strong Buy</div>
                        <div class="cb-leg-item"><div class="cb-dot" style="background:#33cc88"></div>${ad.b} Buy</div>
                        <div class="cb-leg-item"><div class="cb-dot" style="background:var(--neon-amber)"></div>${ad.h} Hold</div>
                        <div class="cb-leg-item"><div class="cb-dot" style="background:#ff7799"></div>${ad.s} Sell</div>
                        <div class="cb-leg-item"><div class="cb-dot" style="background:var(--neon-red)"></div>${ad.ss} Strong Sell</div>
                    </div>
                </div>

                <!-- Price target range -->
                <div class="pt-block">
                    <div class="pt-top">
                        <div class="pt-lbl">Price Targets</div>
                        <div class="pt-nums">
                            <div class="pt-num"><div class="pt-num-val neg">$${ad.ptLow}</div><div class="pt-num-sub">Bear</div></div>
                            <div class="pt-num"><div class="pt-num-val" style="color:var(--neon-blue)">$${ad.ptConsensus}</div><div class="pt-num-sub">Median</div></div>
                            <div class="pt-num"><div class="pt-num-val pos">$${ad.ptHigh}</div><div class="pt-num-sub">Bull</div></div>
                        </div>
                    </div>
                    <div class="pt-track">
                        <div class="pt-range-fill" style="left:${Math.max(0,((ad.ptLow - s.ph.sSupport*0.95)/(ad.ptHigh - s.ph.sSupport*0.95))*100)}%;width:${Math.min(100,((ad.ptHigh - ad.ptLow)/(ad.ptHigh - s.ph.sSupport*0.95))*100)}%"></div>
                        <div class="pt-cur-marker" style="left:${Math.min(95,Math.max(2,((s.price - s.ph.sSupport*0.95)/(ad.ptHigh - s.ph.sSupport*0.95))*100))}%"></div>
                    </div>
                    <div class="pt-upside ${parseFloat(ad.upside)>=0?'pos':'neg'}">${parseFloat(ad.upside)>=0?'▲':'▼'} ${Math.abs(ad.upside)}% median upside to consensus target</div>
                </div>

                <!-- Individual analyst cards -->
                <div class="analyst-cards-title">Top Analyst Views</div>
                <div class="analyst-cards">
                    ${ad.analysts.map(a=>`
                    <div class="analyst-card">
                        <div class="ac-row1">
                            <div><div class="ac-analyst">${a.name}</div><div class="ac-firm">${a.firm}</div></div>
                            <div class="ac-right"><div class="ac-pt">$${a.pt}</div><div class="ac-rating ${a.ratingClass}">${a.rating}</div></div>
                        </div>
                        <div class="ac-row2">
                            <div class="ac-change ${parseFloat(a.ptChange)>=0?'pos':'neg'}">${parseFloat(a.ptChange)>=0?'▲':'▼'} PT ${parseFloat(a.ptChange)>=0?'+':''}${a.ptChange}%</div>
                            <div class="ac-comment">${a.comment}</div>
                        </div>
                    </div>`).join('')}
                </div>

                <!-- Bull vs Bear case -->
                <div class="bull-bear-row">
                    <div class="bb-case bb-bull">
                        <div class="bb-title">🐂 Bull Case</div>
                        <div class="bb-pt">$${ad.bullPT}</div>
                        <div class="bb-text">${ad.bullCase}</div>
                    </div>
                    <div class="bb-case bb-bear">
                        <div class="bb-title">🐻 Bear Case</div>
                        <div class="bb-pt">$${ad.bearPT}</div>
                        <div class="bb-text">${ad.bearCase}</div>
                    </div>
                </div>
            </div>

            <!-- AI ANALYSIS -->
            <div class="ai-section">
                <div class="ai-header"><div class="ai-tag">🤖 AI ANALYSIS</div></div>
                <div class="ai-verdict-row">
                    <div class="verdict-pill ${ai.predClass}"><div class="vp-label">Prediction</div><div class="vp-main">${ai.prediction}</div><div class="vp-conf">Conf: ${ai.confidence}%</div></div>
                    <div class="verdict-pill ${parseFloat(ai.expectedMove)>0?'bull':'bear'}"><div class="vp-label">Exp. Move</div><div class="vp-main">${parseFloat(ai.expectedMove)>0?'+':''}${ai.expectedMove}%</div><div class="vp-conf">Post-earnings</div></div>
                    <div class="verdict-pill neut"><div class="vp-label">Imp. Move</div><div class="vp-main">±${ai.impliedMove}%</div><div class="vp-conf">Options priced</div></div>
                </div>
                <div class="ai-signals">
                    <div class="signal-row">
                        <div class="signal-head"><div class="signal-name">🔢 Whisper Number</div><div class="signal-badge ${parseFloat(ai.whisperGap)>0?'sb-bull':'sb-bear'}">${parseFloat(ai.whisperGap)>0?'+':''}${ai.whisperGap}% vs consensus</div></div>
                        <div class="signal-detail">${parseFloat(ai.whisperGap)>3?'Strong beat likely — whisper significantly above consensus':'Wall St. expectation inline with consensus. No edge from whisper.'}</div>
                        <div class="signal-bar-row"><div class="signal-track"><div class="signal-fill ${parseFloat(ai.whisperGap)>0?'sf-green':'sf-red'}" style="width:${Math.min(100,Math.abs(ai.whisperGap)*6)}%"></div></div><div class="signal-pct">${Math.min(100,Math.abs(ai.whisperGap)*6).toFixed(0)}%</div></div>
                    </div>
                    <div class="signal-row">
                        <div class="signal-head"><div class="signal-name">💎 Earnings Quality</div><div class="signal-badge ${parseFloat(ai.earningsQuality)>=7?'sb-bull':parseFloat(ai.earningsQuality)>=5?'sb-neut':'sb-bear'}">${ai.earningsQuality}/10</div></div>
                        <div class="signal-detail">${parseFloat(ai.earningsQuality)>=7?'High quality: strong FCF, clean balance sheet, low accruals.':parseFloat(ai.earningsQuality)>=5?'Moderate quality — watch guidance carefully.':'Low quality — elevated accruals, weak cash conversion.'}</div>
                        <div class="signal-bar-row"><div class="signal-track"><div class="signal-fill ${parseFloat(ai.earningsQuality)>=7?'sf-green':'sf-amber'}" style="width:${ai.earningsQuality*10}%"></div></div><div class="signal-pct">${ai.earningsQuality*10}%</div></div>
                    </div>
                    <div class="signal-row">
                        <div class="signal-head"><div class="signal-name">🏦 Smart Money Flow</div><div class="signal-badge ${parseFloat(ai.smartMoney)>30?'sb-bull':parseFloat(ai.smartMoney)>0?'sb-neut':'sb-bear'}">${parseFloat(ai.smartMoney)>0?'Accumulation':'Distribution'}</div></div>
                        <div class="signal-detail">${parseFloat(ai.smartMoney)>50?'Heavy institutional accumulation — smart money building positions.':parseFloat(ai.smartMoney)>0?'Mild buying interest from institutions.':'Net selling from large players. Proceed with caution.'}</div>
                        <div class="signal-bar-row"><div class="signal-track"><div class="signal-fill ${parseFloat(ai.smartMoney)>0?'sf-green':'sf-red'}" style="width:${Math.abs(ai.smartMoney)}%"></div></div><div class="signal-pct">${Math.abs(ai.smartMoney)}%</div></div>
                    </div>
                    ${ai.insiderBuying?`<div class="signal-row"><div class="signal-head"><div class="signal-name">👔 Insider Buying</div><div class="signal-badge sb-bull">$${ai.insiderAmt}M</div></div><div class="signal-detail">Recent executive purchases of $${ai.insiderAmt}M — a historically strong pre-earnings signal.</div></div>`:''}
                    ${ai.unusualOptions?`<div class="signal-row"><div class="signal-head"><div class="signal-name">⚡ Options Flow</div><div class="signal-badge sb-bull">UNUSUAL</div></div><div class="signal-detail">Call/Put ratio: ${ai.callPutRatio} — large unusual call volume detected. Smart money is positioning for upside.</div></div>`:''}
                    <div class="signal-row">
                        <div class="signal-head"><div class="signal-name">📡 Social Sentiment</div><div class="signal-badge ${ai.sentPos>55?'sb-bull':ai.sentPos>35?'sb-neut':'sb-bear'}">${ai.sentPos}% Positive</div></div>
                        <div class="sent-bar"><div class="sent-pos" style="width:${ai.sentPos}%"></div><div class="sent-neu" style="width:${ai.sentNeu}%"></div><div class="sent-neg" style="width:${ai.sentNeg}%"></div></div>
                        <div class="sent-labels"><div class="sent-lbl"><span>${ai.sentPos}%</span> Pos</div><div class="sent-lbl"><span>${ai.sentNeu}%</span> Neu</div><div class="sent-lbl"><span>${ai.sentNeg}%</span> Neg</div></div>
                    </div>
                    <div class="signal-row">
                        <div class="signal-head"><div class="signal-name">📋 Guidance Probability</div><div class="signal-badge ${parseInt(ai.guidanceUp)>55?'sb-bull':parseInt(ai.guidanceUp)>40?'sb-neut':'sb-bear'}">${ai.guidanceUp}% raise</div></div>
                        <div class="signal-detail">Beat streak: ${ai.beatStreak} quarters. Analyst revisions: ↑${ai.analystRevUp} =${ai.analystRevMaint} ↓${ai.analystRevDown}</div>
                        <div class="signal-bar-row"><div class="signal-track"><div class="signal-fill ${parseInt(ai.guidanceUp)>55?'sf-green':'sf-amber'}" style="width:${ai.guidanceUp}%"></div></div><div class="signal-pct">${ai.guidanceUp}%</div></div>
                    </div>
                </div>
            </div>

            <!-- ENTRY -->
            <div class="entry-section">
                <div class="entry-header"><div class="entry-tag">🎯 ENTRY SIGNAL</div><div class="rr-pill ${rrClass}">R/R: ${en.rr}:1</div></div>
                <div class="price-ladder">
                    <div class="price-rung rung-entry"><div class="rung-label">Optimal Entry</div><div class="rung-price">$${en.optimalEntry}</div><div class="rung-note">Best buy zone</div></div>
                    <div class="price-rung rung-stop"><div class="rung-label">Stop Loss</div><div class="rung-price">$${en.stopLoss}</div><div class="rung-note">Max risk</div></div>
                    <div class="price-rung rung-target1"><div class="rung-label">Target 1</div><div class="rung-price">$${en.t1}</div><div class="rung-note">+${(((en.t1-en.optimalEntry)/en.optimalEntry)*100).toFixed(1)}% · Take 50%</div></div>
                    <div class="price-rung rung-target2"><div class="rung-label">Target 2</div><div class="rung-price">$${en.t2}</div><div class="rung-note">+${(((en.t2-en.optimalEntry)/en.optimalEntry)*100).toFixed(1)}% · Runner</div></div>
                </div>
                <div class="entry-timeline">
                    <div class="etl-label">Entry Window</div>
                    <div class="etl-track"><div class="etl-zone" style="left:${en.entryWindow.start*100}%;width:${en.entryWindow.width*100}%"></div><div class="etl-now" style="left:${en.entryWindow.start*100}%"></div></div>
                    <div class="etl-labels"><span>Now</span><span>Earnings Day</span></div>
                </div>
                <div class="entry-strategy">${en.strategy}</div>
            </div>

            <!-- POSITION SIZER -->
            <div class="sizer-section">
                <div class="sizer-title">📐 Position Sizing <span style="font-size:10px;color:var(--text-ghost);font-family:'DM Sans',sans-serif;font-weight:400;">2% risk rule</span></div>
                <div class="sizer-grid">
                    <div class="sizer-field"><div class="sizer-lbl">Shares</div><div class="sizer-val">${sz.shares}</div><div class="sizer-sub">Recommended</div></div>
                    <div class="sizer-field"><div class="sizer-lbl">Position Value</div><div class="sizer-val">$${parseInt(sz.positionValue).toLocaleString()}</div><div class="sizer-sub">${sz.pctOfPortfolio}% of portfolio</div></div>
                    <div class="sizer-field"><div class="sizer-lbl">Max Risk</div><div class="sizer-val neg">$${sz.dollarRisk}</div><div class="sizer-sub">2% rule</div></div>
                    <div class="sizer-field"><div class="sizer-lbl">Risk/Share</div><div class="sizer-val neg">$${sz.riskPerShare}</div><div class="sizer-sub">Entry - Stop</div></div>
                </div>
                <div class="sizer-note">Based on $${portfolioBalance.toLocaleString()} portfolio. Tap Trade to customize.</div>
            </div>

            <!-- EARNINGS HISTORY -->
            ${makeCollapsible('hist-'+s.ticker, '📊 Earnings History (6Q)', buildHistoryHtml(s.earningsHistory), false)}

            <!-- OPTIONS SNAPSHOT -->
            <div class="options-section">
                ${makeCollapsible('opts-'+s.ticker, '⚡ Options Snapshot', '<div class="opt-tag">CHAIN · EXPIRY ~2 WEEKS</div>' + buildOptionsHtml(s.optionsChain), false)}
            </div>

            <!-- ACTIONS -->
            <div class="card-actions">
                <div class="cta ${watchlist.has(s.ticker)?'on':''}" onclick="toggleWatch('${s.ticker}')"><div class="cta-icon">${watchlist.has(s.ticker)?'⭐':'☆'}</div><div>Watch</div></div>
                <div class="cta" onclick="openSizer('${s.ticker}')"><div class="cta-icon">📐</div><div>Size</div></div>
                <div class="cta trade-cta" onclick="openTrade('${s.ticker}')"><div class="cta-icon">💼</div><div>Trade</div></div>
                <div class="cta pin-cta ${pinnedStocks.has(s.ticker)?'on':''}" onclick="togglePin('${s.ticker}')"><div class="cta-icon">📌</div><div>${pinnedStocks.has(s.ticker)?'Pinned':'Pin'}</div></div>
            </div>
        </div>
        </div>
        </div>
    </div>`;
}

// ============================
// SWIPE GESTURES
// ============================
function initSwipes() {
    document.querySelectorAll('.swipe-wrap').forEach(wrap => {
        const inner = wrap.querySelector('.swipe-card-inner');
        const hintL = wrap.querySelector('.swipe-hint-watch');
        const hintR = wrap.querySelector('.swipe-hint-trade');
        const ticker = wrap.id.replace('swipe-','');
        let startX=0, curX=0, dragging=false;

        wrap.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; dragging=true; },{ passive:true });
        wrap.addEventListener('touchmove', e=>{
            if (!dragging) return;
            curX=e.touches[0].clientX;
            const dx=curX-startX;
            if (Math.abs(dx) > 10) {
                inner.style.transform=`translateX(${dx*0.5}px)`;
                hintL.style.opacity=dx>20?Math.min(1,(dx-20)/60):0;
                hintR.style.opacity=dx<-20?Math.min(1,(-dx-20)/60):0;
            }
        },{ passive:true });
        wrap.addEventListener('touchend', ()=>{
            const dx=curX-startX;
            inner.style.transform='';
            hintL.style.opacity=0;
            hintR.style.opacity=0;
            dragging=false;
            if (dx > 80) { toggleWatch(ticker); }
            else if (dx < -80) { openTrade(ticker); }
        });
    });
}

// ============================
// CHARTS
// ============================
// chart indicator state per ticker
const chartInds = {}; // { ticker: {ma20:true, ma50:true, vwap:true, bb:false} }
const chartTFs = {};  // { ticker: '1W' }

function getIndState(ticker) {
    if (!chartInds[ticker]) chartInds[ticker] = {ma20:true,ma50:true,vwap:false,bb:false};
    return chartInds[ticker];
}

function toggleInd(ticker, ind) {
    const state = getIndState(ticker);
    state[ind] = !state[ind];
    const chip = document.getElementById(`ind-${ind}-${ticker}`);
    if (chip) chip.classList.toggle('off', !state[ind]);
    const s = stocks.find(x=>x.ticker===ticker);
    if (s) drawChart(s, chartTFs[ticker]||'1W');
}

function setTF(ticker, tf, btn) {
    chartTFs[ticker] = tf;
    const wrap = document.getElementById(`cw-${ticker}`);
    if (wrap) wrap.querySelectorAll('.tf-btn').forEach(b=>b.classList.toggle('on', b===btn));
    const s = stocks.find(x=>x.ticker===ticker);
    if (s) drawChart(s, tf);
}

function slicePH(ph, tf) {
    const n = tf==='1D'?1:tf==='1W'?7:tf==='1M'?21:tf==='3M'?41:tf==='1Y'?41:41;
    const slice = n => arr => arr.slice(-n);
    const s = slice(Math.min(n, ph.closes.length));
    return {
        opens:s(ph.opens),highs:s(ph.highs),lows:s(ph.lows),
        closes:s(ph.closes),vols:s(ph.vols),
        ma20:s(ph.ma20),ma50:s(ph.ma50),vwap:s(ph.vwap),
        rsi:s(ph.rsi),bb:s(ph.bb),
        sResist:ph.sResist,sSupport:ph.sSupport
    };
}

// ============================
// PURE CANVAS CHARTS — Zero external dependencies
// ============================
function setupCanvas(canvas) {
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.clientWidth  || 300;
    const H = canvas.clientHeight || 150;
    canvas.width  = Math.round(W * dpr);
    canvas.height = Math.round(H * dpr);
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    return { ctx, W, H };
}

function canvasCandlestick(canvas, opens, closes, highs, lows, isDark, opts={}) {
    if (!canvas || !closes || !closes.length) return;
    const { ctx, W, H } = setupCanvas(canvas);
    ctx.clearRect(0, 0, W, H);
    const n = closes.length;
    const padR = 36, padT = 6, padB = 4, padL = 4;
    const cW = W - padL - padR, cH = H - padT - padB;

    const valids = closes.map((c,i)=>({h:highs[i],l:lows[i]})).filter(v=>v.h!=null&&v.l!=null);
    if (!valids.length) return;
    let loP = Math.min(...valids.map(v=>v.l));
    let hiP = Math.max(...valids.map(v=>v.h));
    // Include MAs in range
    ['ma20','ma50','vwap'].forEach(k=>{ if(opts[k]) { const d=opts[k].filter(v=>v!=null); if(d.length){loP=Math.min(loP,...d);hiP=Math.max(hiP,...d);} } });
    const rng = hiP - loP || 1;
    const lo = loP - rng*0.04, hi = hiP + rng*0.04;
    const toX = i => padL + (i+0.5)*(cW/n);
    const toY = v => padT + cH*(1-(v-lo)/(hi-lo));

    const gridCol = isDark?'rgba(255,255,255,0.04)':'rgba(0,0,0,0.05)';
    const tickCol = isDark?'rgba(140,140,170,0.7)':'rgba(80,80,120,0.7)';
    ctx.font = '9px monospace';
    // Grid + price labels
    for (let i=0;i<=4;i++) {
        const v = lo + (hi-lo)*(i/4);
        const y = toY(v);
        ctx.strokeStyle=gridCol; ctx.lineWidth=0.5;
        ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR+2,y); ctx.stroke();
        ctx.fillStyle=tickCol; ctx.textAlign='left';
        ctx.fillText('$'+v.toFixed(0), W-padR+5, y+3);
    }

    const upC = opts.upClr||'#26a69a', dnC = opts.downClr||'#ef5350';
    const bW = cW/n;
    for (let i=0;i<n;i++) {
        const o=opens[i],c=closes[i],h=highs[i],l=lows[i];
        if(o==null||c==null||h==null||l==null) continue;
        const up = c>=o, clr = up?upC:dnC;
        const x = toX(i);
        // Wick
        ctx.strokeStyle=clr; ctx.lineWidth=Math.max(0.5,bW*0.08);
        ctx.beginPath(); ctx.moveTo(x,toY(h)); ctx.lineTo(x,toY(l)); ctx.stroke();
        // Body
        const bw=Math.max(1,bW*0.55);
        const yTop=toY(Math.max(o,c)), yBot=toY(Math.min(o,c));
        ctx.fillStyle=clr;
        ctx.fillRect(x-bw/2, yTop, bw, Math.max(1,yBot-yTop));
    }

    // Overlay lines
    const drawLine=(data,color,dash)=>{
        if(!data) return;
        ctx.strokeStyle=color; ctx.lineWidth=1.5; ctx.setLineDash(dash||[]);
        ctx.beginPath(); let started=false;
        data.forEach((v,i)=>{ if(v==null)return; const x=toX(i),y=toY(v);
            if(!started){ctx.moveTo(x,y);started=true;}else ctx.lineTo(x,y); });
        ctx.stroke(); ctx.setLineDash([]);
    };
    if(opts.ma20) drawLine(opts.ma20,'#ffb800',[4,3]);
    if(opts.ma50) drawLine(opts.ma50,'#4d9fff',[2,3]);
    if(opts.vwap) drawLine(opts.vwap,'#bf7fff',[]);
}

function canvasRSI(canvas, rsi, isDark) {
    if (!canvas||!rsi) return;
    const { ctx, W, H } = setupCanvas(canvas);
    ctx.clearRect(0,0,W,H);
    const n=rsi.length;
    const toX=i=>(n<=1?W/2:i/(n-1))*(W-4)+2;
    const toY=v=>H-(v/100)*H;
    const gridCol=isDark?'rgba(255,255,255,0.04)':'rgba(0,0,0,0.05)';
    [[70,'rgba(255,51,102,0.3)'],[30,'rgba(0,255,163,0.3)']].forEach(([v,c])=>{
        ctx.strokeStyle=c; ctx.lineWidth=1; ctx.setLineDash([3,3]);
        ctx.beginPath(); ctx.moveTo(0,toY(v)); ctx.lineTo(W,toY(v)); ctx.stroke();
    });
    ctx.setLineDash([]);
    ctx.strokeStyle='rgba(255,184,0,0.8)'; ctx.lineWidth=1.5;
    ctx.beginPath(); let s=false;
    rsi.forEach((v,i)=>{ if(v==null)return; const x=toX(i),y=toY(v);
        if(!s){ctx.moveTo(x,y);s=true;}else ctx.lineTo(x,y); });
    ctx.stroke();
    ctx.fillStyle=isDark?'rgba(140,140,170,0.6)':'rgba(80,80,120,0.6)';
    ctx.font='8px monospace'; ctx.textAlign='right';
    ctx.fillText('RSI', W-2, 9);
}

function canvasBarChart(canvas, labels, values, colors, isDark) {
    if (!canvas) return;
    const { ctx, W, H } = setupCanvas(canvas);
    ctx.clearRect(0,0,W,H);
    const n=labels.length; if(!n) return;
    const pT=8,pB=24,pL=4,pR=8;
    const cW=W-pL-pR, cH=H-pT-pB;
    const bW=cW/n*0.65, gap=cW/n;
    const tickCol=isDark?'rgba(140,140,170,0.7)':'rgba(80,80,120,0.7)';
    const gridCol=isDark?'rgba(255,255,255,0.04)':'rgba(0,0,0,0.05)';
    [0,25,50,75,100].forEach(v=>{
        const y=pT+cH*(1-v/100);
        ctx.strokeStyle=gridCol; ctx.lineWidth=0.5;
        ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(W-pR,y); ctx.stroke();
    });
    values.forEach((v,i)=>{
        const x=pL+i*gap+gap*0.175;
        const bH=Math.max(2, cH*(Math.min(100,v)/100));
        const y=pT+cH-bH;
        ctx.fillStyle=colors[i]||'#7070a0';
        const r=Math.min(4,bW/2);
        ctx.beginPath();
        ctx.moveTo(x+r,y); ctx.lineTo(x+bW-r,y);
        ctx.arcTo(x+bW,y,x+bW,y+r,r); ctx.lineTo(x+bW,y+bH);
        ctx.lineTo(x,y+bH); ctx.arcTo(x,y,x+r,y,r); ctx.closePath(); ctx.fill();
        ctx.fillStyle=tickCol; ctx.font='9px monospace'; ctx.textAlign='center';
        ctx.fillText(labels[i], x+bW/2, H-6);
    });
}

// ============================
// DRAW CHART (card mini chart)
// ============================
function drawChart(s, tf='1W') {
    const canvas    = document.getElementById(`ch-${s.ticker}`);
    const rsiCanvas = document.getElementById(`rsi-${s.ticker}`);
    if (!canvas) return;
    const ph   = slicePH(s.ph, tf);
    const inds = getIndState(s.ticker);
    const isDark = document.documentElement.getAttribute('data-theme') !== 'light';

    // RSI value display
    const lastRSI = ph.rsi.filter(v=>v!==null).pop();
    const rsiEl = document.getElementById(`rsi-val-${s.ticker}`);
    if (rsiEl && lastRSI != null) {
        rsiEl.textContent = lastRSI.toFixed(1);
        rsiEl.style.color = lastRSI>70?'var(--neon-red)':lastRSI<30?'var(--neon-green)':'var(--neon-amber)';
    }

    canvasCandlestick(canvas, ph.opens, ph.closes, ph.highs, ph.lows, isDark, {
        ma20: inds.ma20 ? ph.ma20 : null,
        ma50: inds.ma50 ? ph.ma50 : null,
        vwap: inds.vwap ? ph.vwap : null,
    });
    if (rsiCanvas) canvasRSI(rsiCanvas, ph.rsi, isDark);
}

function toggleChartView(ticker, mode, btn) {
    // kept for backward compat — unused now
}
function setTFAlias(ticker) { drawChart(stocks.find(s=>s.ticker===ticker), chartTFs[ticker]||'1W'); }

// ============================
// HEATMAP + ROTATION
// ============================
function renderHeatmap() {
    const sectorMap={};
    stocks.forEach(s=>{if(!sectorMap[s.sector])sectorMap[s.sector]=[];sectorMap[s.sector].push(parseFloat(s.scores.overall));});
    document.getElementById('heatGrid').innerHTML=Object.entries(sectorMap).map(([sec,scores])=>{
        const avg=(scores.reduce((a,b)=>a+b,0)/scores.length);
        const cls=avg>65?'heat-hot':avg>40?'heat-warm':'heat-cold';
        return `<div class="heat-cell ${cls}"><div class="heat-sector">${sec}</div><div class="heat-score">${avg.toFixed(0)}</div><div class="heat-count">${scores.length} stock${scores.length!==1?'s':''}</div><div class="heat-bar"><div class="heat-bar-fill" style="width:${avg}%;background:currentColor"></div></div></div>`;
    }).join('');
}

function renderRotation() {
    const sectorFlow=[
        {sector:'Technology',flow:18.4,in:true},{sector:'Finance',flow:7.2,in:true},
        {sector:'Energy',flow:12.1,in:true},{sector:'Healthcare',flow:-3.8,in:false},
        {sector:'Retail',flow:-8.2,in:false},{sector:'Automotive',flow:-5.1,in:false},
    ];
    document.getElementById('rotationList').innerHTML=sectorFlow.map(sf=>`
        <div class="rotation-item">
            <div class="ri-sector">${sf.sector}</div>
            <div class="ri-bar-wrap"><div class="ri-bar ${sf.in?'ri-in':'ri-out'}" style="width:${Math.abs(sf.flow)*4}%"></div></div>
            <div class="ri-arrow">${sf.in?'📈':'📉'}</div>
            <div class="ri-pct" style="color:${sf.in?'var(--neon-green)':'var(--neon-red)'}">${sf.in?'+':''}${sf.flow}%</div>
        </div>
    `).join('');
}

// ============================
// STATS
// ============================
function updateStats() {
    const totalEl=document.getElementById('statTotal');
    const avgEl=document.getElementById('statAvg');
    const hiEl=document.getElementById('statHi');
    const lowEl=document.getElementById('statLow');
    animateCounter(totalEl,stocks.length,600);
    animateCounter(avgEl,Math.round(stocks.reduce((a,s)=>a+parseFloat(s.scores.overall),0)/stocks.length),800);
    animateCounter(hiEl,stocks.filter(s=>parseFloat(s.confidence)>=80).length,600);
    animateCounter(lowEl,stocks.filter(s=>parseFloat(s.risk)<33).length,600);
}

// ============================
// PORTFOLIO + JOURNAL
// ============================
function openTrade(ticker) {
    const s=stocks.find(x=>x.ticker===ticker);
    if (!s) return;
    const n=prompt(`Shares to paper trade:\n${ticker} @ $${s.price}\nSuggested: ${s.posSize.shares} shares (2% risk rule)`);
    if (!n||isNaN(n)||parseInt(n)<=0) return;
    trades.push({ticker,shares:parseInt(n),entryPrice:parseFloat(s.price),date:new Date().toISOString(),note:''});
    localStorage.setItem('be_trades6',JSON.stringify(trades));
    renderPortfolio();
    toast('💼',`Paper trade: ${n} × ${ticker} @ $${s.price}`);
}

function closeTrade(idx) {
    const t=trades[idx];
    const curPrice=t.entryPrice*(1+rnd(-0.08,0.12));
    const pl=(curPrice-t.entryPrice)*t.shares;
    const note=document.querySelector(`#journal-note-${idx}`)?.value||'';
    journal.unshift({ticker:t.ticker,shares:t.shares,entry:t.entryPrice,exit:curPrice.toFixed(2),pl:pl.toFixed(2),plPct:((curPrice-t.entryPrice)/t.entryPrice*100).toFixed(2),date:new Date().toISOString(),note});
    localStorage.setItem('be_journal6',JSON.stringify(journal));
    trades.splice(idx,1);
    localStorage.setItem('be_trades6',JSON.stringify(trades));
    renderPortfolio();
    toast(pl>=0?'✅':'📉',`Closed ${t.ticker}: ${pl>=0?'+':''} $${pl.toFixed(2)}`);
}

function saveNote(idx) {
    const note=document.querySelector(`#journal-note-${idx}`)?.value||'';
    trades[idx].note=note;
    localStorage.setItem('be_trades6',JSON.stringify(trades));
    toast('📝','Note saved');
}

function renderPortfolio() {
    let totalPL=0;
    const container=document.getElementById('tradesList');
    if (!trades.length) {
        container.innerHTML=`<div class="empty"><div class="empty-ico">💼</div><div class="empty-t">No trades</div><div class="empty-s">Paper trade from stock cards</div></div>`;
    } else {
        container.innerHTML=trades.map((t,i)=>{
            const cur=t.entryPrice*(1+rnd(-0.08,0.12));
            const pl=(cur-t.entryPrice)*t.shares, plPct=((cur-t.entryPrice)/t.entryPrice*100);
            totalPL+=pl;
            return `<div class="trade-card">
                <div class="tc-head"><div class="tc-ticker">${t.ticker}</div><div class="tc-pl ${pl>=0?'pos':'neg'}">${pl>=0?'+':''}$${pl.toFixed(2)}</div></div>
                <div class="tc-grid"><div>Shares: ${t.shares}</div><div>Entry: $${t.entryPrice.toFixed(2)}</div><div>Now: $${cur.toFixed(2)}</div><div class="${pl>=0?'pos':'neg'}">${plPct>=0?'+':''}${plPct.toFixed(2)}%</div></div>
                <div class="journal-field"><div class="journal-label">📝 Trade Notes</div><textarea class="journal-input" id="journal-note-${i}" placeholder="Why did you take this trade? What's your thesis?">${t.note||''}</textarea></div>
                <div class="trade-btn-row">
                    <button class="close-trade-btn" onclick="closeTrade(${i})">✕ Close</button>
                    <button class="outcome-btn" onclick="saveNote(${i})">💾 Save Note</button>
                </div>
            </div>`;
        }).join('');
    }
    const plPct=(totalPL/100000*100).toFixed(2);
    document.getElementById('portPL').textContent=`${totalPL>=0?'+':''}$${totalPL.toFixed(2)} (${plPct}%)`;
    document.getElementById('portPL').className=`port-pl ${totalPL>=0?'pos':'neg'}`;
    document.getElementById('portMeta').textContent=`${trades.length} active trade${trades.length!==1?'s':''}`;
    document.getElementById('statPL').textContent=`${totalPL>=0?'+':''}$${(totalPL/1000).toFixed(1)}k`;

    // journal
    const js=document.getElementById('journalSection');
    const je=document.getElementById('journalEntries');
    if (journal.length) {
        js.style.display='block';
        je.innerHTML=journal.slice(0,10).map(j=>`
            <div class="js-entry">
                <div class="jse-head"><div class="jse-ticker">${j.ticker}</div><div class="jse-date">${new Date(j.date).toLocaleDateString()}</div></div>
                <div class="jse-outcome ${parseFloat(j.pl)>=0?'outcome-win':'outcome-loss'}">${parseFloat(j.pl)>=0?'✅ WIN':'📉 LOSS'} &nbsp;${parseFloat(j.pl)>=0?'+':''}$${j.pl} (${j.plPct}%)</div>
                ${j.note?`<div class="jse-note">${j.note}</div>`:''}
            </div>
        `).join('');
    } else {
        js.style.display='none';
    }
}

// ============================
// POSITION SIZER MODAL
// ============================
function openSizer(ticker) {
    const s=stocks.find(x=>x.ticker===ticker);
    if (!s) return;
    let riskPct=2, bal=portfolioBalance;
    const update=()=>{
        const entry=parseFloat(s.entry.optimalEntry), stop=parseFloat(s.entry.stopLoss);
        const riskPerShare=entry-stop;
        const dollarRisk=bal*(riskPct/100);
        const shares=Math.floor(dollarRisk/Math.max(riskPerShare,0.01));
        const posValue=shares*entry;
        document.getElementById('sz-shares').textContent=shares;
        document.getElementById('sz-val').textContent='$'+posValue.toLocaleString();
        document.getElementById('sz-pct').textContent=(posValue/bal*100).toFixed(1)+'%';
        document.getElementById('sz-risk').textContent='$'+dollarRisk.toFixed(0);
    };
    document.getElementById('sizerTitle').textContent=`📐 ${ticker} Position`;
    document.getElementById('sizerContent').innerHTML=`
        <div style="margin-bottom:16px">
            <div class="sizer-grid">
                <div class="sizer-field"><div class="sizer-lbl">Shares</div><div class="sizer-val" id="sz-shares">—</div></div>
                <div class="sizer-field"><div class="sizer-lbl">Position Value</div><div class="sizer-val" id="sz-val">—</div></div>
                <div class="sizer-field"><div class="sizer-lbl">% of Portfolio</div><div class="sizer-val" id="sz-pct">—</div></div>
                <div class="sizer-field"><div class="sizer-lbl">Dollar Risk</div><div class="sizer-val neg" id="sz-risk">—</div></div>
            </div>
        </div>
        <div class="slider-block">
            <div class="sb-row"><div class="sb-name">Risk per Trade</div><div class="sb-val" id="sz-riskpct-lbl">2%</div></div>
            <input type="range" min="0.5" max="5" step="0.5" value="2" oninput="
                riskPct=parseFloat(this.value);
                document.getElementById('sz-riskpct-lbl').textContent=this.value+'%';
                ${ticker}_update();
            " id="sz-risk-slider">
        </div>
        <div class="slider-block">
            <div class="sb-row"><div class="sb-name">Portfolio Balance</div><div class="sb-val">$<span id="sz-bal-lbl">${(portfolioBalance/1000).toFixed(0)}k</span></div></div>
            <input type="range" min="5000" max="500000" step="5000" value="${portfolioBalance}" oninput="
                portfolioBalance=parseInt(this.value);
                document.getElementById('sz-bal-lbl').textContent=(this.value/1000).toFixed(0)+'k';
                ${ticker}_update();
            ">
        </div>
        <div class="entry-strategy">Entry: $${s.entry.optimalEntry} · Stop: $${s.entry.stopLoss} · R/R: ${s.entry.rr}:1</div>
    `;
    window[`${ticker}_update`]=update;
    update();
    openModal('sizerModal');
}

// ============================
// BRIEFING
// ============================
function openBriefing() {
    const now=new Date();
    document.getElementById('briefingDate').textContent=now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
    if (!stocks.length) { document.getElementById('briefingContent').innerHTML=`<div class="empty"><div class="empty-ico">📡</div><div class="empty-t">Run an analysis first</div></div>`; document.getElementById('briefingOverlay').classList.add('on'); return; }
    const top3=stocks.slice(0,3);
    document.getElementById('briefingContent').innerHTML=top3.map((s,i)=>`
        <div class="briefing-pick">
            <div class="bp-rank">#${i+1} Pick</div>
            <div class="bp-ticker">${s.ticker}</div>
            <div class="bp-name">${s.name}</div>
            <div class="bp-row">
                <div class="bp-stat"><div class="bp-stat-lbl">Score</div><div class="bp-stat-val">${s.scores.overall}</div></div>
                <div class="bp-stat"><div class="bp-stat-lbl">R/R</div><div class="bp-stat-val">${s.entry.rr}:1</div></div>
                <div class="bp-stat"><div class="bp-stat-lbl">Entry</div><div class="bp-stat-val">$${s.entry.optimalEntry}</div></div>
            </div>
            <div class="bp-summary">${s.ai.prediction} signal with ${s.ai.confidence}% confidence. Expected post-earnings move of ${parseFloat(s.ai.expectedMove)>0?'+':''}${s.ai.expectedMove}%. Earnings ${Math.ceil((s.earningsDate-Date.now())/86400000)} day(s) away ${s.earningsTime === 'Before Open'?'before market open':'after market close'}.</div>
        </div>
    `).join('');
    document.getElementById('briefingOverlay').classList.add('on');
}
function closeBriefing() { document.getElementById('briefingOverlay').classList.remove('on'); }

// ============================
// WATCHLIST
// ============================
function toggleWatch(ticker) {
    if (watchlist.has(ticker)) { watchlist.delete(ticker); toast('☆',`Removed ${ticker} from watchlist`); }
    else { watchlist.add(ticker); toast('⭐',`Added ${ticker} to watchlist`); }
    localStorage.setItem('be_wl6',JSON.stringify([...watchlist]));
    renderStocks();
}
function renderWatchlist() {
    const c=document.getElementById('watchlistList');
    if (!watchlist.size) { c.innerHTML=`<div class="empty"><div class="empty-ico">⭐</div><div class="empty-t">Empty</div></div>`; return; }
    c.innerHTML=[...watchlist].map(tk=>{
        const s=stocks.find(x=>x.ticker===tk);
        if (!s) return `<div class="trade-card"><div class="tc-ticker">${tk}</div><div style="color:var(--text-ghost);font-size:12px">Run analysis to see data</div></div>`;
        return `<div class="trade-card"><div class="tc-head"><div class="tc-ticker">${s.ticker}</div><div style="font-family:'IBM Plex Mono',monospace;font-size:24px;font-weight:700;color:var(--neon-green)">${s.scores.overall}</div></div><div style="font-size:12px;color:var(--text-dim);margin-bottom:8px">${s.name}</div><div class="tc-grid"><div>$${s.price}</div><div>${s.ai.prediction}</div><div>Entry: $${s.entry.optimalEntry}</div><div>R/R: ${s.entry.rr}:1</div></div></div>`;
    }).join('');
}

// ============================
// PRESETS
// ============================
function savePreset() {
    const name=document.getElementById('presetNameInput').value.trim();
    if (!name) { toast('⚠️','Enter a preset name'); return; }
    savedPresets.push({name,weights:{...weights}});
    localStorage.setItem('be_presets6',JSON.stringify(savedPresets));
    document.getElementById('presetNameInput').value='';
    renderSavedPresets();
    toast('💾',`Preset "${name}" saved`);
}
function loadPreset(idx) {
    weights={...savedPresets[idx].weights};
    document.getElementById('wSurp').value=weights.surp;
    document.getElementById('wRev').value=weights.rev;
    document.getElementById('wAna').value=weights.ana;
    document.getElementById('wTech').value=weights.tech;
    onWeight();
    toast('✓',`Loaded preset "${savedPresets[idx].name}"`);
}
function deletePreset(idx) {
    const name=savedPresets[idx].name;
    savedPresets.splice(idx,1);
    localStorage.setItem('be_presets6',JSON.stringify(savedPresets));
    renderSavedPresets();
    toast('🗑️',`Deleted "${name}"`);
}
function renderSavedPresets() {
    const c=document.getElementById('savedPresetsList');
    if (!savedPresets.length) { c.innerHTML=`<div style="font-size:12px;color:var(--text-ghost);padding:10px 0">No saved presets yet</div>`; return; }
    c.innerHTML=savedPresets.map((p,i)=>`
        <div class="preset-saved-item">
            <div><div class="psi-name">${p.name}</div><div class="psi-weights">S:${p.weights.surp} R:${p.weights.rev} A:${p.weights.ana} T:${p.weights.tech}</div></div>
            <div class="psi-actions"><button class="psi-load" onclick="loadPreset(${i})">Load</button><button class="psi-del" onclick="deletePreset(${i})">✕</button></div>
        </div>
    `).join('');
}

// ============================
// SETTINGS
// ============================
function onWeight() {
    weights.surp=+document.getElementById('wSurp').value;
    weights.rev=+document.getElementById('wRev').value;
    weights.ana=+document.getElementById('wAna').value;
    weights.tech=+document.getElementById('wTech').value;
    document.getElementById('wSurpVal').textContent=weights.surp+'%';
    document.getElementById('wRevVal').textContent=weights.rev+'%';
    document.getElementById('wAnaVal').textContent=weights.ana+'%';
    document.getElementById('wTechVal').textContent=weights.tech+'%';
    document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('on'));
    if (stocks.length) {
        stocks.forEach(s=>{
            const os=parseFloat(s.scores.surp)*(weights.surp/100)+parseFloat(s.scores.rev)*(weights.rev/100)+parseFloat(s.scores.ana)*(weights.ana/100)+parseFloat(s.scores.tech)*(weights.tech/100);
            s.scores.overall=os.toFixed(0);
        });
        stocks.sort((a,b)=>parseFloat(b.scores.overall)-parseFloat(a.scores.overall));
        renderStocks(); updateStats();
    }
}
function setPreset(type,btn) {
    const P={balanced:{surp:30,rev:25,ana:25,tech:20},growth:{surp:20,rev:40,ana:20,tech:20},value:{surp:25,rev:25,ana:35,tech:15},momentum:{surp:20,rev:20,ana:15,tech:45}};
    weights={...P[type]};
    document.getElementById('wSurp').value=weights.surp;
    document.getElementById('wRev').value=weights.rev;
    document.getElementById('wAna').value=weights.ana;
    document.getElementById('wTech').value=weights.tech;
    document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');
    onWeight();
}

// ============================
// FILTERS / TABS / NAV
// ============================
function setFilter(f) {
    activeFilter=f;
    document.querySelectorAll('#chipRow .chip').forEach(c=>c.classList.toggle('on',c.dataset.f===f));
    if (stocks.length) renderStocks();
}
function switchTab(id,btn) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
    document.querySelectorAll('.pane').forEach(p=>p.classList.remove('on'));
    if (btn) btn.classList.add('on');
    const pane = document.getElementById('pane-'+id);
    if (pane) pane.classList.add('on');
    if (id === 'calendar' && stocks.length) setTimeout(renderEarningsCalendar, 50);
}
function bnavClick(id,el) {
    document.querySelectorAll('.bnav-item').forEach(b=>b.classList.remove('on'));
    el.classList.add('on');
    const tabMap = {stocks:0, heatmap:1, calendar:2, portfolio:3};
    const idx = tabMap[id] ?? 0;
    const tabs = [...document.querySelectorAll('.tab-bar .tab')];
    const tabBtn = tabs[idx] || tabs.find(t=>t.textContent.toLowerCase().startsWith(id.slice(0,4)));
    if (tabBtn) switchTab(id, tabBtn);
}

// ============================
// MODALS
// ============================
function openModal(id) {
    if (id==='watchlistModal') renderWatchlist();
    if (id==='settingsModal') renderSavedPresets();
    document.getElementById(id).classList.add('on');
}
function closeModal(id) { document.getElementById(id).classList.remove('on'); }
function handleModalClick(e,id) { if (e.target.classList.contains('modal-bg')) closeModal(id); }

// ============================
// TOAST
// ============================
function toast(ico,msg) {
    const el=document.getElementById('toast');
    document.getElementById('toastIco').textContent=ico;
    document.getElementById('toastMsg').textContent=msg;
    el.classList.add('on');
    clearTimeout(el._t);
    el._t=setTimeout(()=>el.classList.remove('on'),3000);
}
// Alias for single-arg calls
function showToast(msg) { toast('💬', msg); }

// ============================
// INIT
// ============================
renderPortfolio();
renderRotation();
renderSavedPresets();

// ============================
// V7 — API KEY MANAGEMENT
// ============================
function saveApiKey(provider) {
    const inputId = provider==='finnhub'?'fhKeyInput':'fredKeyInput';
    const input = document.getElementById(inputId);
    const key = input.value.trim();
    if (!key) { showToast('Enter a key first'); return; }
    apiKeys[provider] = key;
    localStorage.setItem('be_apikeys7', JSON.stringify(apiKeys));
    updateApiStatus(provider, 'checking');
    testApiKey(provider, key);
}
function clearApiKey(provider) {
    delete apiKeys[provider];
    localStorage.setItem('be_apikeys7', JSON.stringify(apiKeys));
    const inputId = provider==='finnhub'?'fhKeyInput':'fredKeyInput';
    const input = document.getElementById(inputId);
    if (input) input.value = '';
    updateApiStatus(provider, 'none');
    updateApiBanner();
}
function updateApiStatus(provider, status) {
    const idMap = {finnhub:'fhStatus', fred:'fredStatus'};
    const el = document.getElementById(idMap[provider]);
    if (!el) return;
    const colors = {checking:'var(--neon-amber)',ok:'var(--neon-green)',error:'var(--neon-red)',none:'var(--text-ghost)'};
    el.style.background = colors[status] || colors.none;
}
async function testApiKey(provider, key) {
    try {
        let ok = false;
        if (provider === 'finnhub') {
            const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=AAPL&token=${key}`);
            ok = r.ok && (await r.json()).c > 0;
        } else {
            const r = await fetch(`https://api.stlouisfed.org/fred/series?series_id=FEDFUNDS&api_key=${key}&file_type=json`);
            ok = r.ok;
        }
        updateApiStatus(provider, ok ? 'ok' : 'error');
        if (ok) { showToast(`✓ ${provider==='finnhub'?'Finnhub':'FRED'} connected!`); updateApiBanner(); }
        else showToast(`Key invalid — check and retry`);
    } catch(e) {
        updateApiStatus(provider, 'error');
        showToast('Network error — check connection');
    }
}
function updateApiBanner() {
    const banner = document.getElementById('apiBanner');
    const text   = document.getElementById('apiBannerText');
    if (!banner) return;
    
    if (priceSocket && priceSocket.readyState === WebSocket.OPEN) {
        banner.className = 'api-banner live';
        text.textContent = '🟢 Live prices streaming · Finnhub WebSocket';
    } else {
        banner.className = 'api-banner mock';
        text.textContent = '📡 Tap Analyze to connect live stream';
    }
}


// ============================
// v8.5 — FINNHUB REST + WEBSOCKET HYBRID
// REST API: Fetch latest quotes on page load (works 24/7, includes after-hours)
// WebSocket: Stream real-time updates during market hours
// Free tier: 60 REST calls/min + unlimited WebSocket streaming
// ============================

let priceSocket = null;
let socketReconnectTimer = null;

// Fetch current quote via REST API (works when market is closed)
async function fetchFinnhubQuote(symbol) {
    const key = apiKeys.finnhub;
    if (!key) return null;
    
    try {
        const controller = new AbortController();
        const tid = setTimeout(() => controller.abort(), 8000);
        const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${key}`, { 
            signal: controller.signal 
        });
        clearTimeout(tid);
        
        if (!r.ok) return null;
        const data = await r.json();
        
        // data.c = current price, data.pc = previous close, data.d = change, data.dp = change percent
        if (!data.c || data.c === 0) return null;
        
        return {
            price: data.c,
            prevClose: data.pc,
            change: data.d,
            pct: data.dp,
            high: data.h,
            low: data.l,
            open: data.o,
            timestamp: Date.now()
        };
    } catch(e) {
        console.warn(`REST quote failed for ${symbol}:`, e.message);
        return null;
    }
}

// Fetch initial quotes for all stocks via REST API
async function fetchInitialQuotes() {
    const key = apiKeys.finnhub;
    if (!key) {
        console.warn('⚠️ No Finnhub key - cannot fetch quotes');
        return 0;
    }
    
    let successCount = 0;
    
    for (let i = 0; i < COMPANIES.length; i++) {
        const company = COMPANIES[i];
        
        try {
            const quote = await fetchFinnhubQuote(company.ticker);
            if (quote) {
                updateStockPrice(company.ticker, quote.price, quote.timestamp, quote);
                successCount++;
                console.log(`✅ ${company.ticker}: $${quote.price.toFixed(2)} (${quote.pct >= 0 ? '+' : ''}${quote.pct.toFixed(2)}%)`);
            }
        } catch(e) {
            console.warn(`Failed to fetch ${company.ticker}`);
        }
        
        // Rate limit: 60/min = 1 per second, so 200ms between calls is safe
        if (i < COMPANIES.length - 1) await sleep(200);
    }
    
    return successCount;
}

// Connect to Finnhub WebSocket for real-time streaming during market hours
async function connectPriceStream() {
    const key = apiKeys.finnhub;
    if (!key) {
        console.warn('⚠️ No Finnhub key - cannot stream prices');
        return null;
    }

    // Close existing connection if any
    if (priceSocket) {
        priceSocket.close();
        priceSocket = null;
    }

    return new Promise((resolve, reject) => {
        const socket = new WebSocket(`wss://ws.finnhub.io?token=${key}`);
        
        socket.addEventListener('open', () => {
            console.log('✅ Finnhub WebSocket connected');
            
            // Subscribe to all stocks
            COMPANIES.forEach(company => {
                socket.send(JSON.stringify({ type: 'subscribe', symbol: company.ticker }));
                console.log(`📡 Subscribed to ${company.ticker}`);
            });
            
            priceSocket = socket;
            resolve(socket);
        });
        
        socket.addEventListener('message', (event) => {
            try {
                const msg = JSON.parse(event.data);
                if (msg.type === 'trade' && msg.data) {
                    // Process trade updates (real-time during market hours)
                    msg.data.forEach(trade => {
                        updateStockPrice(trade.s, trade.p, trade.t);
                    });
                }
            } catch(e) {
                console.warn('WebSocket message parse error:', e);
            }
        });
        
        socket.addEventListener('error', (error) => {
            console.warn('⚠️ WebSocket error:', error);
            reject(error);
        });
        
        socket.addEventListener('close', () => {
            console.log('WebSocket closed');
            priceSocket = null;
            
            // Auto-reconnect after 5 seconds if needed
            if (socketReconnectTimer) clearTimeout(socketReconnectTimer);
            socketReconnectTimer = setTimeout(() => {
                if (!priceSocket) {
                    console.log('🔄 Reconnecting WebSocket...');
                    connectPriceStream();
                }
            }, 5000);
        });
    });
}

// Update a stock's price from either REST quote or WebSocket trade
function updateStockPrice(symbol, price, timestamp, quoteData) {
    const stock = COMPANIES.find(s => s.ticker === symbol);
    if (!stock) return;
    
    // Use quote data if available (REST API), otherwise calculate from WebSocket trade
    let prevClose, change, pct;
    
    if (quoteData) {
        // REST API provides full quote
        prevClose = quoteData.prevClose;
        change = quoteData.change;
        pct = quoteData.pct;
    } else {
        // WebSocket trade - calculate change from previous price
        prevClose = parseFloat(stock.price) || stock.basePrice;
        change = price - prevClose;
        pct = prevClose ? (change / prevClose * 100) : 0;
    }
    
    // Update stock object
    stock.price = price.toFixed(2);
    stock.dollarChange = change.toFixed(2);
    stock.momentum = pct.toFixed(2);
    stock._live = true;
    stock._lastUpdate = Date.now();
    
    // Cache the price
    priceCache[symbol] = {
        price, 
        prevClose,
        change,
        pct,
        ts: Date.now(),
        source: quoteData ? 'rest' : 'websocket'
    };
    
    // Update UI if stock list is visible
    const card = document.querySelector(`[data-ticker="${symbol}"]`);
    if (card) {
        const priceEl = card.querySelector('.stock-price');
        const changeEl = card.querySelector('.stock-change');
        if (priceEl) priceEl.textContent = '$' + price.toFixed(2);
        if (changeEl) {
            const isPositive = change >= 0;
            changeEl.textContent = (isPositive ? '+' : '') + change.toFixed(2) + ' (' + (isPositive ? '+' : '') + pct.toFixed(2) + '%)';
            changeEl.className = 'stock-change ' + (isPositive ? 'positive' : 'negative');
        }
    }
    
    // Update stats if visible
    updateStats();
}


// ============================
// FINNHUB REST - Historical OHLCV charts (optional supplement)
// ============================
const FH_BASE = 'https://finnhub.io/api/v1';

async function fhFetch(endpoint) {
    const key = apiKeys.finnhub;
    if (!key) return null;
    try {
        const controller = new AbortController();
        const tid = setTimeout(() => controller.abort(), 8000);
        const r = await fetch(FH_BASE + endpoint + '&token=' + key, { signal: controller.signal });
        clearTimeout(tid);
        if (!r.ok) return null;
        return await r.json();
    } catch(e) { return null; }
}

async function fetchFinnhubCandles(symbol) {
    const to   = Math.floor(Date.now() / 1000);
    const from = to - 90 * 86400;
    const d = await fhFetch('/stock/candle?symbol=' + symbol + '&resolution=D&from=' + from + '&to=' + to);
    if (!d || d.s !== 'ok' || !d.c?.length) return null;
    return d;
}

function todayStr()      { return new Date().toISOString().slice(0, 10); }
function futureStr(days) { const d = new Date(); d.setDate(d.getDate() + days); return d.toISOString().slice(0, 10); }

// Fetch historical candles for chart display
async function fetchYahooFull(symbol) {
    if (apiKeys.finnhub) {
        const candles = await fetchFinnhubCandles(symbol);
        if (candles) {
            return {
                chart: {
                    price: 0, prevClose: 0, change: 0, pct: 0,
                    volume: candles.v?.[candles.v.length-1] || null,
                    marketCap: null, high52: null, low52: null,
                    timestamps: candles.t, open: candles.o, high: candles.h,
                    low: candles.l, close: candles.c, volume_arr: candles.v,
                    currency: 'USD', ts: Date.now(), source: 'finnhub-candles'
                },
                summary: null
            };
        }
    }
    return { chart: null, summary: null };
}

async function fetchFredMacro() {
    if (!apiKeys.fred) return null;
    try {
        const key = apiKeys.fred;
        const [vix,fed,t10] = await Promise.all([
            fetch(`https://api.stlouisfed.org/fred/series/observations?series_id=VIXCLS&limit=1&sort_order=desc&api_key=${key}&file_type=json`).then(r=>r.json()),
            fetch(`https://api.stlouisfed.org/fred/series/observations?series_id=FEDFUNDS&limit=1&sort_order=desc&api_key=${key}&file_type=json`).then(r=>r.json()),
            fetch(`https://api.stlouisfed.org/fred/series/observations?series_id=DGS10&limit=1&sort_order=desc&api_key=${key}&file_type=json`).then(r=>r.json()),
        ]);
        return {
            vix: parseFloat(vix.observations[0].value),
            fed: parseFloat(fed.observations[0].value),
            t10: parseFloat(t10.observations[0].value)
        };
    } catch(e) { return null; }
}

function timeAgo(ts) {
    const diff = Date.now() - ts;
    if (diff < 3600000) return Math.floor(diff/60000)+'m ago';
    if (diff < 86400000) return Math.floor(diff/3600000)+'h ago';
    return Math.floor(diff/86400000)+'d ago';
}

// After analysis, try to refresh macro with live FRED data
async function tryLiveMacro() {
    const data = await fetchFredMacro();
    if (!data) return;
    const macroEl = document.getElementById('macroBar');
    if (macroEl) {
        macroEl.querySelector('[data-macro="vix"]') && (macroEl.querySelector('[data-macro="vix"]').textContent = data.vix.toFixed(1));
        macroEl.querySelector('[data-macro="fed"]') && (macroEl.querySelector('[data-macro="fed"]').textContent = data.fed.toFixed(2)+'%');
        macroEl.querySelector('[data-macro="t10"]') && (macroEl.querySelector('[data-macro="t10"]').textContent = data.t10.toFixed(2)+'%');
    }
}

// ============================
// V7 — EARNINGS HISTORY
// ============================
function genEarningsHistory(overallScore) {
    const rows = [];
    const quarters = ['Q3 2023','Q2 2023','Q1 2023','Q4 2022','Q3 2022','Q2 2022'];
    for (let i=0; i<6; i++) {
        const isBull = overallScore > 55;
        const beat = Math.random() < (isBull ? 0.72 : 0.45);
        const miss = !beat && Math.random() < 0.5;
        const surprise = beat ? rnd(1.5, 18.5) : miss ? rnd(-15, -0.5) : rnd(-1, 1.5);
        const revSurp = beat ? rnd(0.5, 8) : miss ? rnd(-8, -0.2) : rnd(-1, 1.2);
        const reaction = beat ? rnd(1, 14) : miss ? rnd(-18, -1) : rnd(-3, 3);
        rows.push({ q:quarters[i], beat, miss, surprise:surprise.toFixed(1), revSurp:revSurp.toFixed(1), reaction:reaction.toFixed(1) });
    }
    const beatCount = rows.filter(r=>r.beat).length;
    const streak = (() => { let s=0; for(let r of rows){ if(r.beat)s++; else break; } return s; })();
    return { rows, beatCount, streak };
}

function buildHistoryHtml(hist) {
    const streakClass = hist.streak >= 3 ? '' : 'miss';
    const streakIcon = hist.streak >= 3 ? '🔥' : hist.streak >= 2 ? '📈' : '⚠️';
    return `
    <div class="hs-inner">
        <div class="hs-streak ${streakClass}">${streakIcon} ${hist.beatCount}/6 beats · ${hist.streak > 0 ? hist.streak+'-quarter beat streak' : 'streak broken'}</div>
        <table class="hs-table">
            <tr>
                <th>Quarter</th><th>EPS Surp.</th><th>Rev Surp.</th><th>Result</th><th>Rxn</th>
            </tr>
            ${hist.rows.map(r=>`
            <tr>
                <td>${r.q}</td>
                <td class="${parseFloat(r.surprise)>0?'rxn-pos':'rxn-neg'}">${parseFloat(r.surprise)>0?'+':''}${r.surprise}%</td>
                <td class="${parseFloat(r.revSurp)>0?'rxn-pos':'rxn-neg'}">${parseFloat(r.revSurp)>0?'+':''}${r.revSurp}%</td>
                <td><span class="hb ${r.beat?'hb-beat':r.miss?'hb-miss':'hb-line'}">${r.beat?'BEAT':r.miss?'MISS':'LINE'}</span></td>
                <td class="${parseFloat(r.reaction)>0?'rxn-pos':'rxn-neg'}">${parseFloat(r.reaction)>0?'+':''}${r.reaction}%</td>
            </tr>`).join('')}
        </table>
    </div>`;
}

// ============================
// V7 — OPTIONS SNAPSHOT
// ============================
function genOptionsChain(price, impliedMove) {
    const p = parseFloat(price);
    const iv = parseFloat(impliedMove)/100;
    const cpRatio = rnd(0.6, 2.8).toFixed(2);
    const totalOI = rndI(50000, 800000);
    const strikes = [-2,-1,0,1,2].map(n => Math.round((p * (1 + n * 0.025))/5)*5);
    const rows = strikes.map((k, i) => {
        const isATM = i === 2;
        const moneyness = (k - p) / p;
        const callDelta = Math.max(0.05, Math.min(0.95, 0.5 - moneyness*3));
        const putDelta  = callDelta - 1;
        const callIV = (iv + Math.abs(moneyness)*0.15 + rnd(0, 0.05));
        const putIV  = (iv + Math.abs(moneyness)*0.18 + rnd(0, 0.05));
        const callPrem = Math.max(0.05, (p * callIV * Math.sqrt(14/365) * callDelta * (1+rnd(-0.1,0.1)))).toFixed(2);
        const putPrem  = Math.max(0.05, (p * putIV  * Math.sqrt(14/365) * Math.abs(putDelta) * (1+rnd(-0.1,0.1)))).toFixed(2);
        const callOI = rndI(500, 15000);
        const putOI  = rndI(500, 15000);
        return { strike:k, isATM, callPrem, putPrem, callIV:(callIV*100).toFixed(1), putIV:(putIV*100).toFixed(1), callDelta:callDelta.toFixed(2), putDelta:putDelta.toFixed(2), callOI, putOI };
    });
    const maxOI = Math.max(...rows.map(r=>Math.max(r.callOI,r.putOI)));
    return { cpRatio, totalOI, iv:(iv*100).toFixed(1), rows, maxOI, expiry: '2 weeks' };
}

function buildOptionsHtml(opts) {
    return `
    <div class="opt-summary">
        <div class="opt-box"><div class="opt-box-lbl">IV</div><div class="opt-box-val">${opts.iv}%</div><div class="opt-box-sub">Implied Vol</div></div>
        <div class="opt-box"><div class="opt-box-lbl">C/P Ratio</div><div class="opt-box-val" style="color:${parseFloat(opts.cpRatio)>1?'var(--neon-green)':'var(--neon-red)'}">${opts.cpRatio}</div><div class="opt-box-sub">${parseFloat(opts.cpRatio)>1.5?'Bullish flow':'Bearish flow'}</div></div>
        <div class="opt-box"><div class="opt-box-lbl">Open Int.</div><div class="opt-box-val">${(opts.totalOI/1000).toFixed(0)}K</div><div class="opt-box-sub">${opts.expiry}</div></div>
    </div>
    <div class="chain-title">Chain (ATM ±2 strikes · ${opts.expiry})</div>
    <div class="chain-hdr">
        <span>CALL $</span><span>IV%</span><span>Δ</span><span style="text-align:center">STRIKE</span><span>Δ</span><span>IV%</span><span style="text-align:right">PUT $</span>
    </div>
    ${opts.rows.map(r=>`
    <div class="chain-row ${r.isATM?'atm':''}">
        <div class="chain-cell call">${r.callPrem}</div>
        <div class="chain-cell call">${r.callIV}</div>
        <div class="chain-cell call">${r.callDelta}</div>
        <div class="chain-cell strike">${r.strike}</div>
        <div class="chain-cell put">${r.putDelta}</div>
        <div class="chain-cell put">${r.putIV}</div>
        <div class="chain-cell put">${r.putPrem}</div>
    </div>`).join('')}`;
}

// ============================
// V7 — COLLAPSIBLE SECTIONS
// ============================
function toggleCollapse(id) {
    const body = document.getElementById('cb-'+id);
    const arrow = document.getElementById('ca-'+id);
    if (!body) return;
    const isClosed = body.classList.contains('closed');
    if (isClosed) {
        body.classList.remove('closed');
        body.style.maxHeight = body.scrollHeight + 'px';
        setTimeout(()=>body.style.maxHeight='none', 380);
        if (arrow) arrow.classList.add('open');
    } else {
        body.style.maxHeight = body.scrollHeight + 'px';
        requestAnimationFrame(()=>{ body.style.maxHeight='0'; body.classList.add('closed'); });
        if (arrow) arrow.classList.remove('open');
    }
}
function makeCollapsible(id, title, content, startOpen=true) {
    return `
    <div>
        <div class="section-toggle" onclick="toggleCollapse('${id}')">
            <div class="st-title">${title}</div>
            <div class="st-arrow ${startOpen?'open':''}" id="ca-${id}">▼</div>
        </div>
        <div class="collapsible-body ${startOpen?'':'closed'}" id="cb-${id}" style="max-height:${startOpen?'none':'0'}">
            ${content}
        </div>
    </div>`;
}

// ============================
// V7 — PIN
// ============================
function togglePin(ticker) {
    if (pinnedStocks.has(ticker)) {
        pinnedStocks.delete(ticker);
        showToast('📌 Unpinned');
    } else {
        pinnedStocks.add(ticker);
        showToast('📌 Pinned to top');
    }
    localStorage.setItem('be_pins7', JSON.stringify([...pinnedStocks]));
    renderStocks();
}

// ============================
// V7 — COUNTDOWN HELPERS
// ============================
function formatCountdown(ms) {
    if (ms <= 0) return { cls:'hours', text:'TODAY' };
    const h = Math.floor(ms/3600000);
    const d = Math.floor(ms/86400000);
    if (d === 0) return { cls:'hours', text: h+'h '+Math.floor((ms%3600000)/60000)+'m' };
    if (d <= 3) return { cls:'days', text: d+'d '+Math.floor((ms%86400000)/3600000)+'h' };
    return { cls:'weeks', text: d+' days' };
}
function startCountdowns() {
    countdownTimers.forEach(clearInterval);
    countdownTimers = [];
    stocks.forEach(s => {
        const el = document.getElementById('cd-'+s.ticker);
        if (!el) return;
        function tick() {
            const ms = s.earningsDate - Date.now();
            const { cls, text } = formatCountdown(ms);
            el.className = 'countdown-badge '+cls;
            el.querySelector('.cd-text').textContent = '⏱ '+text+' to earnings';
        }
        tick();
        const t = setInterval(tick, 60000);
        countdownTimers.push(t);
    });
}

// ============================
// V7 — SCREENER
// ============================
function initScreenSectors() {
    const grid = document.getElementById('screenSectors');
    if (!grid) return;
    grid.innerHTML = ALL_SECTORS.map(s=>`
        <button class="ssg-btn ${screenFilters.sectors.length===0||screenFilters.sectors.includes(s)?'on':''}"
            data-sector="${s}" onclick="toggleScreenSector('${s}',this)">${s}</button>
    `).join('');
    updateScreenCount();
}
function toggleScreenSector(s, btn) {
    btn.classList.toggle('on');
    updateScreenCount();
}
function getSelectedSectors() {
    const grid = document.getElementById('screenSectors');
    if (!grid) return [];
    return [...grid.querySelectorAll('.ssg-btn.on')].map(b=>b.dataset.sector);
}
function updateScreenCount() {
    if (!stocks.length) return;
    const score = parseFloat(document.getElementById('sf-score')?.value||0);
    const rr    = parseFloat(document.getElementById('sf-rr')?.value||0);
    const risk  = parseFloat(document.getElementById('sf-risk')?.value||100);
    const conf  = parseFloat(document.getElementById('sf-conf')?.value||0);
    const secs  = getSelectedSectors();
    const count = stocks.filter(s =>
        parseFloat(s.scores.overall) >= score &&
        parseFloat(s.entry.rr) >= rr &&
        parseFloat(s.risk) <= risk &&
        parseFloat(s.confidence) >= conf &&
        (secs.length===0 || secs.includes(s.sector))
    ).length;
    const el = document.getElementById('screenCount');
    if (el) el.textContent = count + ' stock' + (count!==1?'s':'')+' match';
}
function applyScreen() {
    screenFilters.score = parseFloat(document.getElementById('sf-score')?.value||0);
    screenFilters.rr    = parseFloat(document.getElementById('sf-rr')?.value||0);
    screenFilters.risk  = parseFloat(document.getElementById('sf-risk')?.value||100);
    screenFilters.conf  = parseFloat(document.getElementById('sf-conf')?.value||0);
    screenFilters.sectors = getSelectedSectors();
    screenActive = !(screenFilters.score===0 && screenFilters.rr===0 && screenFilters.risk===100 && screenFilters.conf===0 && screenFilters.sectors.length===ALL_SECTORS.length);
    document.getElementById('screenDot')?.classList.toggle('on', screenActive);
    closeModal('screenModal');
    renderStocks();
    showToast('🔎 Screener applied');
}
function resetScreen() {
    screenFilters = { score:0, rr:0, risk:100, conf:0, sectors:ALL_SECTORS };
    screenActive = false;
    document.getElementById('screenDot')?.classList.remove('on');
    if (document.getElementById('sf-score')) {
        document.getElementById('sf-score').value=0; document.getElementById('sl-score').textContent='0';
        document.getElementById('sf-rr').value=0;    document.getElementById('sl-rr').textContent='0x';
        document.getElementById('sf-risk').value=100; document.getElementById('sl-risk').textContent='100';
        document.getElementById('sf-conf').value=0;  document.getElementById('sl-conf').textContent='0';
    }
    initScreenSectors();
    renderStocks();
    showToast('Screener reset');
}

// ============================
// INIT V7 ADDITIONS
// ============================
updateApiBanner();
updateApiStatus('finnhub', apiKeys.finnhub ? 'ok' : 'none');
updateApiStatus('fred',    apiKeys.fred    ? 'ok' : 'none');
if (apiKeys.finnhub) { const el=document.getElementById('fhKeyInput');   if(el) el.placeholder='Key saved — paste to replace'; }
if (apiKeys.fred)    { const el=document.getElementById('fredKeyInput'); if(el) el.placeholder='Key saved — paste to replace'; }
initScreenSectors();

// ============================
// v8 — DRILL-DOWN FULL SCREEN
// ============================
let ddCurrentTicker = null;
let ddCurrentTf     = '1mo';
let ddLwChart       = null; // reused as Chart.js instance

function openDrillDown(ticker) {
    const s = stocks.find(x => x.ticker === ticker);
    if (!s) return;
    ddCurrentTicker = ticker;
    const overlay = document.getElementById('drilldownOverlay');
    // Populate static fields
    document.getElementById('ddTicker').textContent   = ticker;
    document.getElementById('ddFullname').textContent = s.name;
    const score = parseFloat(s.scores.overall);
    const badge = document.getElementById('ddScoreBadge');
    badge.textContent = Math.round(score);
    badge.className   = 'dd-score-badge ' + (score>=70?'hi':score>=45?'mid':'lo');
    // Price
    document.getElementById('ddPrice').textContent = `$${parseFloat(s.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
    const pct = parseFloat(s.momentum);
    const chg = parseFloat(s.dollarChange||0);
    const chgEl = document.getElementById('ddChange');
    chgEl.className = `dd-change ${pct>=0?'pos':'neg'}`;
    chgEl.textContent = `${pct>=0?'↗':'↘'} ${chg>=0?'+':''}${chg.toFixed(2)} (${pct>=0?'+':''}${pct.toFixed(2)}%) today` + (s._live ? '' : ' · base price');
    // Metrics
    document.getElementById('ddMetrics').innerHTML = [
        {l:'P/E Ratio',    v: s.peRatio||'--'},
        {l:'Market Cap',   v: s.marketCap ? fmtCap(s.marketCap) : '--'},
        {l:'52W High',     v: s.high52 ? '$'+s.high52.toFixed(0) : '--'},
        {l:'52W Low',      v: s.low52  ? '$'+s.low52.toFixed(0)  : '--'},
        {l:'Earnings',     v: s.earningsDate ? fmtEarDate(s.earningsDate) : '--'},
        {l:'Rev Growth',   v: s.revenueGrowth ? s.revenueGrowth+'%' : '--'},
    ].map(m=>`<div class="dd-metric"><div class="dd-metric-label">${m.l}</div><div class="dd-metric-val">${m.v}</div></div>`).join('');
    // News
    document.getElementById('ddNews').innerHTML = (s.news||[]).map(n=>`
        <div class="dd-news-item">
            <div class="dd-news-dot ${n[3]===true?'pos':n[3]===false?'neg':'neu'}"></div>
            <div><div class="dd-news-text">${n[0]}</div><div class="dd-news-meta">${n[1]} · ${n[2]}</div></div>
        </div>`).join('');
    // Extra: entry levels + AI summary
    document.getElementById('ddExtraContent').innerHTML = `
        <div class="dd-section-title">🎯 Entry Levels</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
            ${[['Entry',s.entry?.entry],['Stop',s.entry?.stop],['Target 1',s.entry?.t1]].map(([l,v])=>`
            <div class="dd-metric"><div class="dd-metric-label">${l}</div><div class="dd-metric-val">${v?'$'+parseFloat(v).toFixed(2):'--'}</div></div>`).join('')}
        </div>
        <div class="dd-section-title" style="margin-top:14px">🤖 AI Analysis</div>
        <div style="font-size:12px;color:var(--text-main);line-height:1.7;background:var(--bg-surface);padding:12px;border-radius:10px;border:1px solid var(--border-subtle)">${s.ai?.narrative||'Analysis unavailable.'}</div>`;
    // Show overlay
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';
    // Load chart
    setTimeout(() => ddLoadChart(ticker, ddCurrentTf), 50);
}

function closeDrillDown() {
    document.getElementById('drilldownOverlay').classList.remove('open');
    document.body.style.overflow = '';
    ddLwChart = null; // just clear reference, canvas was in innerHTML which gets cleared on next open
}

async function ddLoadChart(ticker, range) {
    const wrap    = document.getElementById('ddChart');
    const loading = document.getElementById('ddChartLoading');
    if (!wrap) return;

    // Clear previous chart
    ddLwChart = null;
    wrap.innerHTML = '';
    loading.style.display = 'flex';

    const intervalMap = {'5d':'15m','1mo':'1d','3mo':'1d','6mo':'1wk','1y':'1wk'};
    const interval = intervalMap[range] || '1d';
    const data = await fetchYahooChart(ticker, range, interval);
    loading.style.display = 'none';

    // Build candles from real data or fall back to stock's own price history
    let candles = [];
    if (data && data.timestamps?.length) {
        candles = data.timestamps.map((t, i) => ({
            t, open: data.open[i], high: data.high[i],
            low: data.low[i], close: data.close[i],
        })).filter(c => c.close != null && c.close > 0 && c.open != null);
    }

    // Fall back to generated price history if no live data
    if (!candles.length) {
        const s = stocks.find(x => x.ticker === ticker);
        if (s?.ph) {
            candles = s.ph.closes.map((c, i) => ({
                t: i, open: s.ph.opens[i], high: s.ph.highs[i],
                low: s.ph.lows[i], close: c,
            }));
        }
    }

    if (!candles.length) {
        wrap.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-dim);font-size:12px">Chart unavailable</div>`;
        return;
    }

    const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
    const canvas = document.createElement('canvas');
    canvas.style.cssText = 'width:100%;height:270px;display:block';
    wrap.appendChild(canvas);
    // Force layout so clientWidth is set
    canvas.width  = wrap.clientWidth  * (window.devicePixelRatio||1);
    canvas.height = 270 * (window.devicePixelRatio||1);
    const opens  = candles.map(c=>c.open);
    const closes = candles.map(c=>c.close);
    const highs  = candles.map(c=>c.high);
    const lows   = candles.map(c=>c.low);
    canvasCandlestick(canvas, opens, closes, highs, lows, isDark, {
        upClr:'#00ffa3', downClr:'#ff3366'
    });
    ddLwChart = canvas; // store reference to clear on next open
}

function ddSetTf(range, btn) {
    ddCurrentTf = range;
    document.querySelectorAll('.dd-tf').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (ddCurrentTicker) ddLoadChart(ddCurrentTicker, range);
}

function fmtCap(n) {
    if (n >= 1e12) return '$'+(n/1e12).toFixed(1)+'T';
    if (n >= 1e9)  return '$'+(n/1e9).toFixed(1)+'B';
    if (n >= 1e6)  return '$'+(n/1e6).toFixed(0)+'M';
    return '$'+n.toLocaleString();
}

function fmtEarDate(d) {
    if (!d || isNaN(d)) return '--';
    const diff = Math.round((d - Date.now()) / 86400000);
    if (diff < 0) return 'Reported';
    if (diff === 0) return 'Today!';
    if (diff <= 7) return `${diff}d`;
    return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}

// Add click handler to stock cards
function addCardClickHandlers() {
    document.querySelectorAll('.stock-card').forEach(card => {
        card.addEventListener('click', function(e) {
            // Don't trigger if clicking buttons/links inside card
            if (e.target.closest('button,a,.cta,input,select')) return;
            const ticker = this.dataset.ticker;
            if (ticker) openDrillDown(ticker);
        });
    });
}

// ============================
// v8 — EARNINGS CALENDAR
// ============================
let calYear  = new Date().getFullYear();
let calMonth = new Date().getMonth();
let calSelectedDay = null;

function renderEarningsCalendar() {
    if (!stocks.length) return;
    const grid  = document.getElementById('calGrid');
    const label = document.getElementById('calMonthLabel');
    if (!grid || !label) return;

    const today   = new Date();
    const firstDay = new Date(calYear, calMonth, 1);
    const lastDay  = new Date(calYear, calMonth+1, 0);
    label.textContent = firstDay.toLocaleDateString('en-US', { month:'long', year:'numeric' });

    // Build earnings map: "YYYY-MM-DD" → [stock, ...]
    const earningsMap = {};
    stocks.forEach(s => {
        if (!s.earningsDate) return;
        const d = new Date(s.earningsDate);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        if (!earningsMap[key]) earningsMap[key] = [];
        earningsMap[key].push(s);
    });

    // DOW headers
    const dows = ['Su','Mo','Tu','We','Th','Fr','Sa'];
    let html = dows.map(d=>`<div class="cal-dow">${d}</div>`).join('');

    // Empty cells before first day
    for (let i = 0; i < firstDay.getDay(); i++) html += `<div class="cal-day empty"></div>`;

    // Day cells
    for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateObj = new Date(calYear, calMonth, d);
        const key = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = dateObj.toDateString() === today.toDateString();
        const dayStocks = earningsMap[key] || [];
        const hasEarnings = dayStocks.length > 0;
        const classes = ['cal-day', isToday?'today':'', hasEarnings?'has-earnings':''].join(' ').trim();
        const chips = dayStocks.slice(0,2).map(s => {
            const score = parseFloat(s.scores.overall);
            const cls = score>=70?'':'score<45?lo:mid';
            const c = score >= 70 ? '' : score < 45 ? ' lo' : ' mid';
            return `<div class="cal-ear-chip${c}" onclick="event.stopPropagation();openDrillDown('${s.ticker}')">${s.ticker}</div>`;
        }).join('');
        const extra = dayStocks.length > 2 ? `<div class="cal-ear-chip mid">+${dayStocks.length-2}</div>` : '';
        html += `<div class="${classes}" onclick="calSelectDay('${key}',${d})">${
            `<div class="cal-day-num">${d}</div>${chips}${extra}`
        }</div>`;
    }
    grid.innerHTML = html;

    // Show today's or nearest earnings by default
    if (!calSelectedDay) {
        const nearest = Object.keys(earningsMap).sort()[0];
        if (nearest) calSelectDay(nearest, parseInt(nearest.split('-')[2]));
    } else {
        calSelectDay(calSelectedDay, parseInt(calSelectedDay.split('-')[2]));
    }
}

function calSelectDay(key, day) {
    calSelectedDay = key;
    const detail = document.getElementById('calDayDetail');
    const earningsMap = {};
    stocks.forEach(s => {
        if (!s.earningsDate) return;
        const d = new Date(s.earningsDate);
        const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        if (!earningsMap[k]) earningsMap[k] = [];
        earningsMap[k].push(s);
    });
    const dayStocks = earningsMap[key] || [];
    if (!dayStocks.length) {
        detail.innerHTML = `<div class="cal-dd-title">${new Date(calYear, calMonth, day).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}</div><div style="color:var(--text-dim);font-size:12px;padding:8px 0">No earnings scheduled</div>`;
        return;
    }
    const dateLabel = new Date(calYear, calMonth, day).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
    detail.innerHTML = `<div class="cal-dd-title">📅 ${dateLabel}</div><div class="cal-dd-list">${
        dayStocks.map(s => {
            const score = parseFloat(s.scores.overall);
            const scoreColor = score>=70?'var(--neon-green)':score<45?'var(--neon-red)':'var(--neon-amber)';
            const timeClass = s.earningsTime?.includes('Before')?'bmo':'amc';
            return `<div class="cal-dd-row" onclick="openDrillDown('${s.ticker}')">
                <div class="cal-dd-ticker">${s.ticker}</div>
                <div class="cal-dd-name">${s.name}</div>
                <div class="cal-dd-time ${timeClass}">${s.earningsTime?.includes('Before')?'BMO':'AMC'}</div>
                <div class="cal-dd-score" style="color:${scoreColor}">${Math.round(score)}</div>
            </div>`;
        }).join('')
    }</div>`;
}

function calNav(dir) {
    calMonth += dir;
    if (calMonth > 11) { calMonth = 0; calYear++; }
    if (calMonth < 0)  { calMonth = 11; calYear--; }
    calSelectedDay = null;
    renderEarningsCalendar();
}

// ============================
// v8 — SECTOR DEEP DIVE
// ============================
let sectorDiveChart = null;

function openSectorDive(sector) {
    const overlay = document.getElementById('sectorOverlay');
    const sectorStocks = stocks.filter(s => s.sector === sector);
    if (!sectorStocks.length) return;
    document.getElementById('sectorDiveTitle').textContent = sector;
    document.getElementById('sectorDiveBadge').textContent = `${sectorStocks.length} stocks`;

    const avgScore = sectorStocks.reduce((a,s)=>a+parseFloat(s.scores.overall),0)/sectorStocks.length;
    const avgMomentum = sectorStocks.reduce((a,s)=>a+parseFloat(s.momentum||0),0)/sectorStocks.length;
    const bestStock = sectorStocks.reduce((a,b)=>parseFloat(b.scores.overall)>parseFloat(a.scores.overall)?b:a);

    const body = document.getElementById('sectorBody');
    body.innerHTML = `
    <div class="sector-stats">
        <div class="sector-stat"><div class="sector-stat-lbl">Avg Score</div><div class="sector-stat-val" style="color:${avgScore>=60?'var(--neon-green)':avgScore<40?'var(--neon-red)':'var(--neon-amber)'}">${avgScore.toFixed(0)}</div></div>
        <div class="sector-stat"><div class="sector-stat-lbl">Avg Move</div><div class="sector-stat-val" style="color:${avgMomentum>=0?'var(--neon-green)':'var(--neon-red)'}">${avgMomentum>=0?'+':''}${avgMomentum.toFixed(2)}%</div></div>
        <div class="sector-stat"><div class="sector-stat-lbl">Top Pick</div><div class="sector-stat-val" style="color:var(--neon-cyan)">${bestStock.ticker}</div></div>
    </div>
    <div class="sector-chart-wrap"><canvas id="sectorChartCanvas"></canvas></div>
    <div style="padding:0 16px 8px;font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px">Score Breakdown</div>
    ${sectorStocks.sort((a,b)=>parseFloat(b.scores.overall)-parseFloat(a.scores.overall)).map((s,i)=>{
        const score = parseFloat(s.scores.overall);
        const pct = parseFloat(s.momentum||0);
        return `<div class="sector-bar-row">
            <div class="sector-bar-lbl"><span>${s.ticker} · ${s.name}</span><span>${score.toFixed(0)}</span></div>
            <div class="sector-bar-track"><div class="sector-bar-fill" style="width:${score}%;background:${score>=70?'var(--neon-green)':score<45?'var(--neon-red)':'var(--neon-amber)'}"></div></div>
        </div>
        <div class="sector-stocks-list" style="padding:0 16px;margin-bottom:2px">
            <div class="sector-stock-row" onclick="closeSectorDive();setTimeout(()=>openDrillDown('${s.ticker}'),350)">
                <div class="sector-rank">${i+1}</div>
                <div class="sector-s-ticker">${s.ticker}</div>
                <div class="sector-s-price">$${parseFloat(s.price).toFixed(2)}</div>
                <div class="sector-s-change ${pct>=0?'pos':'neg'}">${pct>=0?'+':''}${pct.toFixed(2)}%</div>
                <div class="sector-s-score" style="color:${score>=70?'var(--neon-green)':score<45?'var(--neon-red)':'var(--neon-amber)'}">${score.toFixed(0)}</div>
            </div>
        </div>`;
    }).join('')}`;

    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';

    // Draw bar chart
    setTimeout(() => {
        const canvas = document.getElementById('sectorChartCanvas');
        if (!canvas) return;
        const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        const labels = sectorStocks.map(s=>s.ticker);
        const values = sectorStocks.map(s=>parseFloat(s.scores.overall));
        const colors = values.map(sc=>sc>=70?'rgba(0,255,163,0.75)':sc<45?'rgba(255,51,102,0.75)':'rgba(255,184,0,0.75)');
        canvasBarChart(canvas, labels, values, colors, isDark);
    }, 100);
}

function closeSectorDive() {
    document.getElementById('sectorOverlay').classList.remove('open');
    document.body.style.overflow = '';
}

// Make sector tags open the deep-dive
function sectorTagClick(e, sector) {
    e.stopPropagation();
    openSectorDive(sector);
}

</script>

<!-- API KEYS MODAL -->
<div class="modal-bg" id="apiModal" onclick="handleModalClick(event,'apiModal')">
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">📡 Live Data Streaming</div>

        <!-- WebSocket explanation -->
        <div style="background:rgba(0,255,163,0.1);border:1px solid rgba(0,255,163,0.3);border-radius:var(--radius-sm);padding:14px;margin-bottom:16px">
            <div style="color:var(--neon-green);font-weight:600;font-size:12px;margin-bottom:8px">✅ Real-Time Streaming Active</div>
            <div style="color:var(--text-mid);font-size:11px;line-height:1.6">
                Bulls Eye uses <strong>Finnhub WebSocket API</strong> to stream live stock prices continuously. WebSocket connections bypass CORS restrictions entirely — works perfectly on iOS Safari, even from local HTML files.
            </div>
        </div>

        <!-- Finnhub key -->
        <div class="api-key-block" style="border-color:rgba(0,255,163,0.3)">
            <div class="akb-label">
                <div class="akb-status" id="fhStatus"></div>
                Finnhub API Key · <span style="color:var(--neon-green);font-size:10px;font-weight:700">WEBSOCKET STREAMING</span>
            </div>
            <input class="akb-input" id="fhKeyInput" type="password" placeholder="Key saved — paste to replace">
            <div class="akb-row">
                <button class="akb-save" onclick="saveApiKey('finnhub')">✓ Save & Connect</button>
                <button class="akb-clear" onclick="clearApiKey('finnhub')">✕</button>
            </div>
            <div class="api-note">
                <strong>Free tier:</strong> Unlimited real-time streaming via WebSocket + 60 REST calls/min for historical charts.<br>
                <strong>How it works:</strong> When you tap Analyze, Bulls Eye connects to <code>wss://ws.finnhub.io</code> and subscribes to all 15 stocks. Prices update live as trades occur.<br>
                Get your free key at <a href="https://finnhub.io" target="_blank">finnhub.io</a>
            </div>
        </div>

        <!-- FRED (optional) -->
        <div class="api-key-block">
            <div class="akb-label">
                <div class="akb-status" id="fredStatus"></div>
                FRED API Key · <span style="font-size:10px;color:var(--text-dim)">Optional — macro data</span>
            </div>
            <input class="akb-input" id="fredKeyInput" type="password" placeholder="Paste your FRED key (optional)">
            <div class="akb-row">
                <button class="akb-save" onclick="saveApiKey('fred')">✓ Save & Connect</button>
                <button class="akb-clear" onclick="clearApiKey('fred')">✕</button>
            </div>
            <div class="api-note">Free, unlimited · VIX, Fed Funds Rate, 10Y Treasury, S&P 500. Get key at <a href="https://fred.stlouisfed.org/docs/api/api_key.html" target="_blank">fred.stlouisfed.org</a></div>
        </div>

        <div style="background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.2);border-radius:var(--radius-sm);padding:12px;font-size:11px;color:var(--text-dim);line-height:1.6">
            <strong style="color:var(--neon-cyan)">💡 Why WebSocket?</strong> WebSocket connections (<code>wss://</code>) are not subject to browser CORS policies. This makes them the most reliable way to get live data on iOS Safari. All API keys are stored locally only — never sent to any server except the data provider.
        </div>
    </div>
</div>

<!-- SCREENING MODAL -->
<div class="modal-bg" id="screenModal" onclick="handleModalClick(event,'screenModal')">
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">🔎 Screener</div>
        <div class="screen-group-lbl">Score Filters</div>
        <div class="screen-row">
            <div class="screen-field">
                <div class="screen-lbl">Min Score <span id="sl-score">0</span></div>
                <input type="range" class="screen-range" id="sf-score" min="0" max="100" value="0" oninput="document.getElementById('sl-score').textContent=this.value">
            </div>
            <div class="screen-field">
                <div class="screen-lbl">Min R/R <span id="sl-rr">0x</span></div>
                <input type="range" class="screen-range" id="sf-rr" min="0" max="4" step="0.5" value="0" oninput="document.getElementById('sl-rr').textContent=this.value+'x'">
            </div>
        </div>
        <div class="screen-row">
            <div class="screen-field">
                <div class="screen-lbl">Max Risk <span id="sl-risk">100</span></div>
                <input type="range" class="screen-range" id="sf-risk" min="0" max="100" value="100" oninput="document.getElementById('sl-risk').textContent=this.value">
            </div>
            <div class="screen-field">
                <div class="screen-lbl">Min Conf% <span id="sl-conf">0</span></div>
                <input type="range" class="screen-range" id="sf-conf" min="0" max="100" value="0" oninput="document.getElementById('sl-conf').textContent=this.value">
            </div>
        </div>
        <div class="screen-group-lbl">Sectors</div>
        <div class="screen-sector-grid" id="screenSectors"></div>
        <div class="results-count" id="screenCount"></div>
        <button class="apply-screen-btn" onclick="applyScreen()">Apply Filter</button>
        <button class="reset-screen-btn" onclick="resetScreen()">Reset All</button>
    </div>
</div>

</body>
</html>
